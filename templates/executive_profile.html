<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Executive Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">

  <style>
    body{background:#f6f8fb}
    .card{border:1px solid #e5e7eb;border-radius:14px}
    .avatar{width:120px;height:120px;object-fit:cover;border-radius:50%;border:3px solid #fff;box-shadow:0 5px 18px rgba(0,0,0,.08)}
    .label{font-size:.8rem;color:#64748b}
  </style>
</head>
<body>
      {% include 'executive_sidebar.html' %}

<div class="container py-4">
  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category=='error' else category }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="row g-4">
    <div class="col-lg-5">
      <div class="card shadow-sm p-4">
        <div class="text-center mb-3">
          <img class="avatar" src="{{ user.image_url or 'https://via.placeholder.com/160?text=Executive' }}" alt="Avatar">
          <h5 class="mt-3 mb-1">{{ user.name or user.username }}</h5>
          <div class="text-muted">{{ (user.position or 'Executive') ~ ' -  ' ~ (user.branch or '') }}</div>
          <span class="badge bg-{{ 'success' if (user.status or '').lower()=='active' else 'secondary' }} mt-2">
            {{ user.status or 'Active' }}
          </span>
        </div>
        <hr>
        <div class="row gy-3">
          <div class="col-12">
            <div class="label">Username</div>
            <div class="fw-medium">{{ user.username }}</div>
          </div>
          <div class="col-12">
            <div class="label">Email</div>
            <div class="fw-medium">{{ user.email }}</div>
          </div>
          <div class="col-6">
            <div class="label">Phone</div>
            <div class="fw-medium">{{ user.phone }}</div>
          </div>
          <div class="col-6">
            <div class="label">Gender</div>
            <div class="fw-medium">{{ user.gender }}</div>
          </div>
          <div class="col-6">
            <div class="label">Location</div>
            <div class="fw-medium">{{ user.location }}</div>
          </div>
          <div class="col-6">
            <div class="label">Start Date</div>
            <div class="fw-medium">{{ user.start_date }}</div>
          </div>
          <div class="col-12">
            <div class="label">Assets</div>
            <div class="fw-medium">
              {% if user.assets and user.assets|length %}
                {{ user.assets|join(', ') }}
              {% else %}
                --
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Change password -->
    <div class="col-lg-7">
      <div class="card shadow-sm p-4">
        <h5 class="mb-3">Change Password</h5>
        <form method="post" action="{{ url_for('executive_profile.change_password') }}">
          <div class="mb-3">
            <label class="form-label">Current Password</label>
            <input name="current_password" type="password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <input name="new_password" type="password" class="form-control" minlength="6" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm New Password</label>
            <input name="confirm_password" type="password" class="form-control" minlength="6" required>
          </div>
          <button class="btn btn-primary">Update Password</button>
        </form>

        <div class="mt-4 small text-muted">
          Tip: choose 8-32 characters with a mix of letters and numbers. Avoid reusing old passwords.
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm p-4 mt-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap mb-3">
      <h5 class="mb-0">Login Activity / Security</h5>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-light text-dark border">Last login:
          {% if login_stats.last_login %}
            {{ login_stats.last_login.strftime('%Y-%m-%d %H:%M') }}
          {% else %}
            --
          {% endif %}
        </span>
        <span class="badge bg-light text-dark border">Total logins (30 days): {{ login_stats.total_logins }}</span>
        <span class="badge bg-light text-dark border">Unique IPs (30 days): {{ login_stats.unique_ips }}</span>
        <span class="badge bg-light text-dark border">Unique devices (30 days): {{ login_stats.unique_devices }}</span>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
        <tr>
          <th>Date/Time</th>
          <th>IP</th>
          <th>Device</th>
          <th>Location</th>
        </tr>
        </thead>
        <tbody>
        {% if login_logs and login_logs|length %}
          {% for log in login_logs %}
            <tr>
              <td>
                {% if log.timestamp %}
                  {{ log.timestamp.strftime('%Y-%m-%d %H:%M') if log.timestamp.__class__.__name__ == 'datetime' else log.timestamp }}
                {% else %}--{% endif %}
                {% if log.is_new_location %}
                  <span class="badge bg-warning text-dark ms-2">New location</span>
                {% endif %}
                {% if log.is_low_accuracy %}
                  <span class="badge bg-secondary ms-2">Low accuracy</span>
                {% endif %}
              </td>
              <td>{{ log.ip or '--' }}</td>
              <td>
                <div>{{ (log.device.os or 'Unknown') }} -  {{ (log.device.browser or 'Unknown') }}</div>
                <small class="text-muted">{{ 'Mobile' if log.device.is_mobile else 'Desktop' }}</small>
              </td>
              <td>
                {% if log.geo and log.geo.lat is not none %}
                  <div>Lat {{ log.geo.lat }}, Lng {{ log.geo.lng }} (Â±{{ log.geo.accuracy_m or 0 }}m)</div>
                  <a class="btn btn-outline-primary btn-sm mt-1" target="_blank"
                     href="https://www.google.com/maps?q={{ log.geo.lat }},{{ log.geo.lng }}">
                    Open Map
                  </a>
                {% else %}
                  --
                {% endif %}
                {% set ip_loc = log.ip_location or log.location %}
                {% if ip_loc %}
                  <div class="text-muted small">
                    {{ ip_loc.city or '' }} {{ ip_loc.region or '' }} {{ ip_loc.country or '' }}
                  </div>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="4" class="text-center text-muted py-3">No login activity yet.</td></tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
  {% include 'app_footer.html' %}

</body>
</html>

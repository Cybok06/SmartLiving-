<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3e8ff;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212 !important;
      color: #f1f1f1;
    }

    .dark-mode .navbar,
    .dark-mode .footer,
    .dark-mode .card,
    .dark-mode table {
      background-color: #343a40 !important;
      color: white;
    }

    .footer {
      background-color: #e0c7ff;
      padding: 10px;
      text-align: center;
      margin-top: 40px;
      border-top: 1px solid #ccc;
    }

    .btn-update {
      background-color: #28a745;
      color: white;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .flash {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      color: white;
    }

    .flash.success { background-color: #28a745; }
    .flash.danger { background-color: #dc3545; }
  </style>
</head>
<body>
    {% include 'inventory_sidebar.html' %}

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light px-3">
  <a class="navbar-brand d-flex align-items-center" href="#">
    <img src="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" alt="Logo" height="40">
  </a>
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
    <ul class="navbar-nav align-items-center">
      <li class="nav-item">
        <a class="nav-link" href="/inventory/dashboard">üè† Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('add_inventory.add_inventory') }}">‚ûï Add Product</a>
      </li>

       <li class="nav-item">
        <a class="nav-link" href="{{ url_for('inventory_analysis.inventory_analysis') }}">üìä Analysis</a>
      </li>
      <li class="nav-item">
        <button class="btn btn-outline-dark ms-lg-3 me-3" onclick="toggleDarkMode()" id="darkModeToggle">üåô</button>
      </li>
      <li class="nav-item">
        <a href="/logout" class="btn btn-danger">Logout</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Content -->
<div class="container mt-4">
  <h2 class="text-center mb-4">Warehouse Products by Branch</h2>
<!-- Filter Form -->
<form method="GET" class="row g-3 filter-form mb-3">
  <div class="col-md-4">
    <select name="manager" class="form-select">
      <option value="">All Managers</option>
      {% for name in managers %}
        <option value="{{ name }}" {% if request.args.get('manager') == name %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <select name="branch" class="form-select">
      <option value="">All Branches</option>
      {% for branch in branches %}
        <option value="{{ branch }}" {% if request.args.get('branch') == branch %}selected{% endif %}>{{ branch }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <input type="text" name="product" class="form-control" placeholder="Search Product" value="{{ request.args.get('product', '') }}">
  </div>
  <div class="col-md-12">
    <button type="submit" class="btn btn-primary w-100">Filter</button>
  </div>
</form>




  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="table-responsive">
  <div class="row row-cols-2 row-cols-lg-3 g-4">
    {% for item in inventory %}
    <div class="col">
      <div class="card shadow-sm h-100">
<div class="position-relative">
  <img src="{{ item.image_url }}" class="card-img-top" alt="{{ item.name }}" style="object-fit: cover; height: 180px;">
  <button class="btn btn-sm btn-warning position-absolute top-0 end-0 m-2" data-bs-toggle="modal" data-bs-target="#changeImageModal{{ item._id }}">
    üñºÔ∏è Change Image
  </button>
</div>
        <div class="card-body">
          <h5 class="card-title">{{ item.name }}</h5>
          <p class="card-text">{{ item.description }}</p>
          <p class="card-text"><strong>Price:</strong> GHS {{ item.price }}</p>
          <p class="card-text"><strong>Qty:</strong> {{ item.qty }}</p>
          <p class="card-text"><strong>Manager:</strong> 
            {% if item.manager.name == 'Multiple' %}
              <span class="text-info">All Branches</span>
            {% else %}
              {{ item.manager.name }} ({{ item.manager.branch }})
            {% endif %}
          </p>

          <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#editModal{{ item._id }}">Edit</button>

          <form method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this item?');">
            <input type="hidden" name="item_id" value="{{ item._id }}">
            <div class="d-flex flex-wrap mb-2">
              <div class="form-check me-2">
                <input class="form-check-input branch-master" type="checkbox" id="deleteAllBranches{{ item._id }}">
                <label class="form-check-label small" for="deleteAllBranches{{ item._id }}">All</label>
              </div>
              {% for branch in branches %}
              <div class="form-check me-2">
                <input class="form-check-input branch-option" type="checkbox" name="branches" value="{{ branch }}" id="deleteBranch{{ item._id }}{{ loop.index }}">
                <label class="form-check-label small" for="deleteBranch{{ item._id }}{{ loop.index }}">{{ branch }}</label>
              </div>
              {% endfor %}
            </div>
            <button class="btn btn-sm btn-danger" name="action" value="delete">Delete</button>
          </form>

          <button class="btn btn-sm btn-secondary" onclick="openHistoryModal('{{ item._id }}', '{{ item.name }}')">History</button>
        </div>
      </div>
    </div>
<!-- Change Image Modal -->
<div class="modal fade" id="changeImageModal{{ item._id }}" tabindex="-1" aria-labelledby="changeImageModalLabel{{ item._id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" enctype="multipart/form-data" class="change-image-form" data-name="{{ item.name }}" data-price="{{ item.price }}">
        <div class="modal-header">
          <h5 class="modal-title">Change Image for "{{ item.name }}"</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="name" value="{{ item.name }}">
          <input type="hidden" name="price" value="{{ item.price }}">
          <input type="file" name="image" class="form-control mb-2" accept="image/*" required>
          <p class="text-muted small">New image will apply to all items with this name and price.</p>
          <div class="preview-container mt-2 text-center"></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Update Image</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal{{ item._id }}" tabindex="-1" aria-labelledby="editModalLabel{{ item._id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel{{ item._id }}">Edit {{ item.name }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="item_id" value="{{ item._id }}">

              <div class="mb-3">
                <label for="name{{ item._id }}" class="form-label">Product Name</label>
                <input type="text" name="name" class="form-control" id="name{{ item._id }}" value="{{ item.name }}" required>
              </div>

              <div class="mb-3">
                <label for="price{{ item._id }}" class="form-label">Price (GHS)</label>
                <input type="number" name="price" class="form-control" id="price{{ item._id }}" value="{{ item.price }}" step="0.01" required>
              </div>

              <div class="mb-3">
                <label for="qty{{ item._id }}" class="form-label">Quantity</label>
                <input type="number" name="qty" class="form-control" id="qty{{ item._id }}" value="{{ item.qty }}" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Apply to Branches</label>
                <div class="d-flex flex-wrap">
                  <div class="form-check me-2">
                    <input class="form-check-input branch-master" type="checkbox" id="editAllBranches{{ item._id }}">
                    <label class="form-check-label small" for="editAllBranches{{ item._id }}">All</label>
                  </div>
                  {% for branch in branches %}
                  <div class="form-check me-2">
                    <input class="form-check-input branch-option" type="checkbox" name="branches" value="{{ branch }}" id="editBranch{{ item._id }}{{ loop.index }}">
                    <label class="form-check-label small" for="editBranch{{ item._id }}{{ loop.index }}">{{ branch }}</label>
                  </div>
                  {% endfor %}
                </div>
                <small class="text-muted">Tick all the branches you want the update to apply to.</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" name="action" value="update" class="btn btn-primary">Save changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div> <!-- End of .row -->
</div> <!-- End of .table-responsive -->

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="historyModalLabel">History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul id="historyList" class="list-group">
          <li class="list-group-item">Loading...</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% if total_count > current_page * limit %}
  <div class="text-center mt-4">
    <form method="get">
      <input type="hidden" name="manager" value="{{ request.args.get('manager', '') }}">
      <input type="hidden" name="branch" value="{{ request.args.get('branch', '') }}">
      <input type="hidden" name="product" value="{{ request.args.get('product', '') }}">
      <input type="hidden" name="offset" value="{{ offset + limit }}">
      <button class="btn btn-outline-primary">Load More ({{ total_count - current_page * limit }} remaining)</button>
    </form>
  </div>
{% endif %}

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
      <h5>Applying to all branches...</h5>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  CYTECH | Admin Panel
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = document.getElementById('darkModeToggle');
    btn.textContent = document.body.classList.contains('dark-mode') ? 'üåû' : 'üåô';
  }

  function openHistoryModal(itemId, productName) {
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    document.getElementById('historyModalLabel').innerText = `History - ${productName}`;
    const list = document.getElementById('historyList');
    list.innerHTML = '<li class="list-group-item">Loading...</li>';

    fetch(`/inventory_history/${itemId}`)
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) {
          list.innerHTML = '<li class="list-group-item text-danger">No logs found.</li>';
          return;
        }

        list.innerHTML = '';
        data.forEach(log => {
          const li = document.createElement('li');
          li.classList.add('list-group-item');
          li.innerHTML = `
            <strong>${log.action.toUpperCase()}</strong> by ${log.updated_by || log.deleted_by || 'Unknown'}<br>
            ${log.old_price !== undefined ? `Old Price: GHS ${log.old_price} ‚Üí New Price: GHS ${log.new_price}<br>` : ''}
            ${log.old_qty !== undefined ? `Old Qty: ${log.old_qty} ‚Üí New Qty: ${log.new_qty}<br>` : ''}
            <small class="text-muted">${new Date(log.updated_at).toLocaleString()}</small>
          `;
          list.appendChild(li);
        });
      });

    modal.show();
  }

  // Checkbox logic for select all
  document.querySelectorAll('.branch-master').forEach(masterCheckbox => {
    masterCheckbox.addEventListener('change', function () {
      const container = this.closest('.modal-body') || this.closest('form');
      const checkboxes = container.querySelectorAll('.branch-option');
      checkboxes.forEach(cb => cb.checked = this.checked);
    });
  });

  // Show loader when form with branch checkboxes is submitted
  document.querySelectorAll("form").forEach(form => {
    form.addEventListener("submit", function (e) {
      const hasAllCheckbox = form.querySelector(".branch-master");
      if (hasAllCheckbox && hasAllCheckbox.checked) {
        const loading = new bootstrap.Modal(document.getElementById("loadingModal"));
        loading.show();
      }
    });
  });

  // ‚úÖ Handle change image logic (corrected route)
  document.querySelectorAll('.change-image-form').forEach(form => {
    const previewContainer = form.querySelector('.preview-container');
    const fileInput = form.querySelector('input[type="file"]');

    // Preview selected image
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      const imgPreview = document.createElement('img');
      imgPreview.src = URL.createObjectURL(file);
      imgPreview.style.maxHeight = "150px";
      imgPreview.classList.add("img-fluid", "mt-2", "rounded");
      previewContainer.innerHTML = '';
      previewContainer.appendChild(imgPreview);
    });

    // Submit form via correct route using item_id
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerText = "Updating...";

      const itemId = form.closest('.modal').id.replace('changeImageModal', '');
      const formData = new FormData(form);

      try {
        const response = await fetch(`/inventory_products/change_image/${itemId}`, {
          method: 'POST',
          body: formData
        });
        const result = await response.text(); // Use text in case it's HTML redirect

        // Redirect if backend redirects, else reload
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          location.reload();
        }
      } catch (err) {
        alert("Upload failed: " + (err.message || "Unknown error"));
        submitBtn.disabled = false;
        submitBtn.innerText = "Update Image";
      }
    });
  });
</script>
</body>
</html>
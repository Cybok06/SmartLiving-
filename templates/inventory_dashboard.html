<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --soft:#f6f9fc; }
    body{ background:var(--soft); color:var(--ink) }
    .card{ border:1px solid var(--line); box-shadow:0 10px 24px rgba(2,6,23,.06) }
    .muted{ color:var(--muted) }
    .kpi .num{ font-size:1.6rem; font-weight:800 }
    .table thead th{ background:#0d6efd; color:#fff; }
  </style>
</head>
<body>
  {% include 'inventory_sidebar.html' %}

  <main class="container py-4">
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">Welcome, {{ username }} ðŸ‘‹</h3>
        <div class="muted">Inventory Control Dashboard</div>
      </div>
      <span class="badge bg-primary">Live</span>
    </div>

    <!-- Filters -->
    <div class="card p-3 mb-3">
      <form id="filters" class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Branch</label>
          <input class="form-control" id="branch" placeholder="All branches">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Manager ID</label>
          <input class="form-control" id="manager_id" placeholder="Optional">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">From</label>
          <input type="date" class="form-control" id="date_from">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">To</label>
          <input type="date" class="form-control" id="date_to">
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary">Apply</button>
        </div>
      </form>
    </div>

    <!-- KPI rows -->
    <div class="row g-3 mb-3">
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_open">0</div><div class="muted">Open Orders</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_partial">0</div><div class="muted">Partially Delivered</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_closed">0</div><div class="muted">Closed Orders</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_outstanding">0</div><div class="muted">Outstanding Lines</div></div></div></div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_postponed">0</div><div class="muted">Postponed Lines</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_pkg_pending">0</div><div class="muted">Packages Pending</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num" id="k_pkg_delivered">0</div><div class="muted">Packages Delivered (7d)</div></div></div></div>
      <div class="col-md-3"><div class="card p-3 kpi"><div><div class="num"><span id="k_transfers">0</span> / <span id="k_closures">0</span></div><div class="muted">Transfers / Closures (14d)</div></div></div></div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-3">
      <div class="col-lg-4"><div class="card p-3"><h6>Order Status</h6><canvas id="c_status"></canvas></div></div>
      <div class="col-lg-8"><div class="card p-3"><h6>Deliveries -- Last 30 days</h6><canvas id="c_deliveries"></canvas></div></div>
    </div>
    <div class="row g-3 mb-4">
      <div class="col-lg-7"><div class="card p-3"><h6>Outstanding Lines by Branch</h6><canvas id="c_branch"></canvas></div></div>
      <div class="col-lg-5"><div class="card p-3"><h6>Top Managers by Outstanding</h6><canvas id="c_managers"></canvas></div></div>
    </div>

    <!-- Recent deliveries -->
    <div class="card p-3 mb-5">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Recent Deliveries</h6><span class="muted small">latest 50</span>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-hover table-sm align-middle">
          <thead><tr><th>When</th><th>Branch</th><th>Manager</th><th>Item</th><th>Qty</th><th>Order</th></tr></thead>
          <tbody id="recent_tbody"><tr><td colspan="6" class="text-center text-muted">Loadingâ€¦</td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    function setText(id, v){ document.getElementById(id).textContent = v; }
    function makeChart(ctx, type, data, options){
      if(ctx.__chart) ctx.__chart.destroy();
      ctx.__chart = new Chart(ctx, {type, data, options});
    }

    async function loadDash(){
      const params = new URLSearchParams();
      const b = document.getElementById('branch').value.trim();
      const m = document.getElementById('manager_id').value.trim();
      const df = document.getElementById('date_from').value;
      const dt = document.getElementById('date_to').value;
      if(b) params.set('branch', b);
      if(m) params.set('manager_id', m);
      if(df) params.set('date_from', df);
      if(dt) params.set('date_to', dt);

      const r = await fetch(`/inventory/dashboard/data?${params.toString()}`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const j = await r.json();
      if(!j.ok){ alert(j.message||'Failed'); return; }

      const k = j.kpis;
      setText('k_open', k.orders_open);
      setText('k_partial', k.orders_partial);
      setText('k_closed', k.orders_closed);
      setText('k_outstanding', k.outstanding_lines);
      setText('k_postponed', k.postponed_lines);
      setText('k_pkg_pending', k.packages_pending);
      setText('k_pkg_delivered', k.packages_delivered_7d);
      setText('k_transfers', k.transfers_14d);
      setText('k_closures', k.closures_14d);

      makeChart(document.getElementById('c_status').getContext('2d'), 'doughnut', {
        labels: j.charts.status_donut.labels,
        datasets: [{ data: j.charts.status_donut.values }]
      }, { plugins:{ legend:{ position:'bottom' }}});

      makeChart(document.getElementById('c_deliveries').getContext('2d'), 'line', {
        labels: j.charts.deliveries_last30.labels,
        datasets: [{ label:'Deliveries', data: j.charts.deliveries_last30.values, fill:false, tension:0.25 }]
      }, { plugins:{ legend:{ display:false }}});

      makeChart(document.getElementById('c_branch').getContext('2d'), 'bar', {
        labels: j.charts.outstanding_by_branch.labels,
        datasets: [{ label:'Outstanding', data: j.charts.outstanding_by_branch.values }]
      }, { plugins:{ legend:{ display:false }}});

      makeChart(document.getElementById('c_managers').getContext('2d'), 'bar', {
        labels: j.charts.top_managers_outstanding.labels,
        datasets: [{ label:'Outstanding', data: j.charts.top_managers_outstanding.values }]
      }, { indexAxis:'y', plugins:{ legend:{ display:false }}});

      const tb = document.getElementById('recent_tbody');
      tb.innerHTML = (j.recent_deliveries||[]).length
        ? j.recent_deliveries.map(r=>`
            <tr>
              <td>${r.when}</td>
              <td>${r.branch}</td>
              <td>${r.manager}</td>
              <td>${r.item}</td>
              <td>${r.qty}</td>
              <td class="text-muted">${r.order_id.slice(-8)}</td>
            </tr>`).join('')
        : `<tr><td colspan="6" class="text-center text-muted">No recent deliveries.</td></tr>`;
    }

    document.getElementById('filters').addEventListener('submit', e => { e.preventDefault(); loadDash(); });
    loadDash();
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

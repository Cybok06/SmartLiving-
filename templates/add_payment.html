<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .container { max-width: 640px; margin: 36px auto; background: #fff; padding: 28px; border-radius: 16px; box-shadow: 0 10px 26px rgba(15,23,42,.08); }
    h2 { margin: 0; color: #111827; font-weight: 700; }
    label { margin-top: 12px; font-weight: 500; color: #111827; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 10px; border: 1px solid #d6dbe3; box-shadow: 0 2px 8px rgba(15,23,42,.06); }

    /* Submit button + inline spinner */
    #submitBtn { width: 100%; margin-top: 20px; padding: 12px; background-color: #007BFF; border: none; color: #fff; font-size: 16px; border-radius: 8px; transition: background-color .3s ease; display:flex; align-items:center; justify-content:center; gap:.5rem; }
    #submitBtn:hover { background-color: #0056b3; }
    .btn-spinner {
      display: inline-block; width: 1rem; height: 1rem; border: .2rem solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%;
      animation: spin .8s linear infinite; vertical-align:middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .flash-message { padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; margin-bottom: 15px; text-align: center; }
    footer { background-color: #8a2be2; color: white; padding: 10px 0; text-align: center; margin-top: 50px; }
    .navbar { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
    .btn-toggle-mode { background: none; border: none; color: #333; font-size: 1.5em; cursor: pointer; }

    .section-card {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      background: #f9fafb;
      box-shadow: 0 4px 14px rgba(15,23,42,.06);
    }
    .summary-row { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-top: 14px; }
    .summary-cards { flex: 1; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .summary-card { background:#f3f4f6; border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; }
    .summary-card .label { font-size: 0.8rem; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
    .summary-card .value { font-size:1.2rem; font-weight:700; color:#111827; }
    @media (max-width: 576px) {
      .summary-row { flex-direction: column; align-items: stretch; }
      .summary-cards { grid-template-columns: 1fr; }
    }
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .mode-badge { font-size:.75rem; letter-spacing:.08em; text-transform:uppercase; padding:.25rem .6rem; border-radius:999px; background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; }
    .subtle-text { color:#6b7280; font-size:.9rem; }

    /* View payments pill */
    .view-payments-link {
      background: linear-gradient(to right, #0dfd65, #06b36f);
      color: #fff; font-weight: 600; border-radius: 30px;
      box-shadow: 0 8px 16px rgba(13,253,101,.25);
      text-decoration: none; transition: all .2s ease;
      padding: 12px 30px; display: inline-block;
    }
    .view-payments-link:hover { background: linear-gradient(to right, #06b36f, #039f58); box-shadow: 0 10px 20px rgba(13,253,101,.35); color: #fff; }

    /* ------ Face ID-style loading ring ------ */
    .faceid-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; }
    .faceid-ring {
      width: 96px; height: 96px; border-radius: 50%; position: relative;
      background: radial-gradient(circle at 50% 50%, rgba(0,123,255,.08) 0 45%, transparent 46% 100%);
    }
    .faceid-arc, .faceid-arc:before, .faceid-arc:after {
      position: absolute; inset: 0; border-radius: 50%;
      border: 4px solid transparent; content: "";
    }
    .faceid-arc { border-top-color: #0d6efd; animation: spin 1.2s linear infinite; }
    .faceid-arc:before { border-right-color: #0d6efd; animation: spin 1.2s linear infinite reverse; }
    .faceid-arc:after { border-bottom-color: #0d6efd; animation: spin 1.6s linear infinite; }
    .loading-text { margin-top: 16px; font-weight: 600; color: #0b1320; }
    body.dark-mode .loading-text { color: #f8f9fa; }

    /* ------ Success check animation ------ */
    .checkmark { width: 120px; height: 120px; display:block; margin: 0 auto; }
    .checkmark__circle {
      stroke: #28a745; stroke-width: 4; stroke-miterlimit: 10; fill: none;
      animation: stroke 0.6s ease-in-out forwards;
    }
    .checkmark__check {
      transform-origin: 50% 50%; stroke: #28a745; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none;
      stroke-dasharray: 48; stroke-dashoffset: 48; animation: draw 0.35s 0.6s ease-out forwards;
    }
    @keyframes stroke { from { stroke-dasharray: 0 380; } to { stroke-dasharray: 380 380; } }
    @keyframes draw { to { stroke-dashoffset: 0; } }

    /* --- Simple SMS toggle (accessible) --- */
    .sms-toggle-wrap { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .sms-badge { font-size: .85rem; padding: .2rem .6rem; border-radius: 999px; }
    .sms-badge.off { background:#f3f4f6; color:#374151; border:1px solid #e5e7eb; }
    .sms-badge.on  { background:#dcfce7; color:#14532d; border:1px solid #bbf7d0; }
    .sms-switch.btn { min-width: 130px; }

    /* Select2 align to Bootstrap */
    .select2-container .select2-selection--single {
      height: 42px;
      border-radius: 10px;
      border: 1px solid #d6dbe3;
      box-shadow: 0 2px 8px rgba(15,23,42,.06);
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 42px;
      padding-left: 12px;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 42px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
{% include 'side_bar.html' %}

<!-- Main Content -->
<div class="container">
  <div class="header-row mb-2">
    <h2>Add Payment</h2>
    <span class="mode-badge">PRODUCT</span>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-2 mb-2">
    <div class="subtle-text">Record a payment quickly and accurately.</div>
    <button type="button" id="toggleSusuBtn" class="btn btn-warning btn-sm w-100 w-md-auto">üîÅ Switch to SUSU Mode</button>
  </div>

  <form id="paymentForm" method="POST">
    <!-- Customer Dropdown -->
    <label for="customer_id">Select Customer</label>
    <select name="customer_id" class="form-select" required>
      {% for customer in customers %}
        <option value="{{ customer._id }}">{{ customer.name }} ({{ customer.phone_number }})</option>
      {% endfor %}
    </select>

    <!-- Product Section -->
    <div id="product-section">
      <label for="product_id">Select Product</label>
      <select name="product_id" id="productSelect" class="form-select">
        <option value="">Select a product</option>
      </select>
    </div>

    <!-- Hidden Field for SUSU Mode -->
    <input type="hidden" name="is_susu" id="isSusuInput" value="no">
    <!-- Hidden for SMS toggle (DEFAULT OFF) -->
    <input type="hidden" name="send_sms" id="sendSmsInput" value="no">
    <!-- Hidden for force insert (set only if user confirms duplicate) -->
    <input type="hidden" name="force" id="forceInput" value="no">

    <!-- Summary + SMS row -->
    <div class="summary-row">
      <div class="summary-cards" id="paidSummary" style="display:none;">
        <div class="summary-card">
          <div class="label">Total Paid</div>
          <div class="value">GHS <span id="paidAmount">0.00</span></div>
        </div>
        <div class="summary-card">
          <div class="label">Amount Left</div>
          <div class="value">GHS <span id="leftAmount">0.00</span></div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span id="smsStatus" class="sms-badge off">SMS: Off</span>
        <button type="button" id="smsToggleBtn" class="btn btn-outline-secondary sms-switch" aria-pressed="false">
          Turn SMS On
        </button>
      </div>
    </div>

    <input type="hidden" name="method" value="Cash">

    <!-- Amount -->
    <label for="amount">Amount (GH‚Çµ)</label>
    <input type="number" name="amount" class="form-control" step="0.01" required>
    <div class="subtle-text mt-1">Enter amount in GHS</div>

    <input type="hidden" name="date" value="{{ today }}">

    <!-- Submit Button (with spinner placeholder) -->
    <button type="submit" id="submitBtn">
      <span class="btn-label">Submit Payment</span>
      <span class="btn-spinner" style="display:none;"></span>
    </button>
  </form>
</div>

<!-- Footer -->
<footer><p>&copy; 2025 SMART LIVING. All Rights Reserved.</p></footer>

<!-- Loading Modal (Face ID style) -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body">
        <div class="faceid-wrap text-center">
          <div class="faceid-ring">
            <div class="faceid-arc"></div>
          </div>
          <div class="loading-text">Processing payment‚Ä¶</div>
          <div class="text-muted mt-2" style="font-size:.9rem;">Please keep this window open</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body text-center p-4">
        <svg class="checkmark" viewBox="0 0 52 52" aria-hidden="true">
          <circle class="checkmark__circle" cx="26" cy="26" r="24"></circle>
          <path class="checkmark__check" d="M14 27 L22 34 L38 18"></path>
        </svg>
        <h5 class="mt-3 mb-2">Payment Recorded</h5>
        <p id="successDetails" class="text-muted mb-3"></p>
        <div class="d-flex gap-2 justify-content-center mt-2">
          <button class="btn btn-outline-secondary" id="addAnotherBtn">Add Another</button>
          <a class="view-payments-link" id="viewPaymentsLink" href="/payments">View Payments</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script id="customers-data" type="application/json">
  {{ customers | tojson }}
</script>

<script>
(function(){
  const VIEW_PAYMENTS_URL = "/payments"; // <-- change if your route is different
  const PRODUCT_PAID_URL = "{{ url_for('payment.get_product_paid') }}";

  const customers = JSON.parse(document.getElementById('customers-data').textContent || '[]');
  const customerSelect = $('select[name="customer_id"]');
  const productSelect = $('#productSelect');
  const productSection = $('#product-section');
  const isSusuInput = $('#isSusuInput');
  const susuBtn = $('#toggleSusuBtn');
  const form = document.getElementById('paymentForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitSpinner = submitBtn.querySelector('.btn-spinner');
  const submitLabel = submitBtn.querySelector('.btn-label');
  const forceInput = document.getElementById('forceInput');
  const paidSummary = document.getElementById('paidSummary');
  const paidAmount = document.getElementById('paidAmount');
  const leftAmount = document.getElementById('leftAmount');

  // SMS toggle bits
  const sendSmsInput = document.getElementById('sendSmsInput'); // hidden field
  const smsToggleBtn = document.getElementById('smsToggleBtn');
  const smsStatus = document.getElementById('smsStatus');

  let isSusuMode = false;
  let loadingModal, successModal;

  // Init customer dropdown
  customerSelect.select2({ placeholder: "Select a customer", width: '100%' });

  const urlParams = new URLSearchParams(window.location.search);
  const prefillCustomerId = urlParams.get('customer_id') || '';
  let pendingProductIndex = urlParams.get('product_index');

  function formatProductOption(option) {
    if (!option.id) return option.text;
    const img = option.element?.dataset?.image;
    const price = parseFloat(option.element?.dataset?.price || 0);
    const name = (option.text || '').split(' - ')[0];
    if (!img) return option.text;
    const span = document.createElement('span');
    span.innerHTML = `<img src="${img}" alt="" style="width:22px;height:22px;border-radius:4px;object-fit:cover;margin-right:6px;"><span style="margin-right:6px;">${name}</span><span class="text-muted">GHS ${price.toFixed(2)}</span>`;
    return span;
  }

  productSelect.select2({
    placeholder: "Select a product",
    width: '100%',
    templateResult: formatProductOption,
    templateSelection: formatProductOption
  });

  // Populate products for a selected customer
  function populateProducts(customer){
    productSelect.empty().append('<option value="">Select a product</option>');
      if (customer && Array.isArray(customer.purchases)) {
        customer.purchases.forEach((p, i) => {
          const product = p.product || {};
          if ((product.transfer_status || '') === 'transferred_out') {
            return;
          }
          const name = product.name || 'Unnamed';
          const total = product.total || 0;
          const opt = new Option(`${name} - GHS ${total}`, i);
          opt.dataset.image = product.image_url || '';
          opt.dataset.price = total;
          productSelect.append(opt);
        });
      if (customer.purchases.length > 0) {
        productSelect.val("0").trigger('change');
      }
    }
    if (pendingProductIndex !== null && pendingProductIndex !== undefined && pendingProductIndex !== '') {
      const exists = productSelect.find(`option[value="${pendingProductIndex}"]`).length > 0;
      if (exists) {
        productSelect.val(String(pendingProductIndex)).trigger('change');
      }
      pendingProductIndex = null;
    }
    productSelect.trigger('change');
  }

  function resetPaidSummary() {
    if (!paidSummary) return;
    paidSummary.style.display = 'none';
    if (paidAmount) paidAmount.textContent = '0.00';
    if (leftAmount) leftAmount.textContent = '0.00';
  }

  async function fetchPaidSummary(customerId, productIndex) {
    if (!paidSummary || !customerId || productIndex === '') {
      resetPaidSummary();
      return;
    }
    try {
      const url = `${PRODUCT_PAID_URL}?customer_id=${encodeURIComponent(customerId)}&product_index=${encodeURIComponent(productIndex)}`;
      const res = await fetch(url, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const contentType = res.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        const text = await res.text();
        console.warn('Non-JSON response from product_paid:', text.slice(0, 200));
        resetPaidSummary();
        return;
      }
      const data = await res.json();
      if (!res.ok || !data.ok) {
        resetPaidSummary();
        return;
      }
      paidSummary.style.display = 'block';
      if (paidAmount) paidAmount.textContent = (data.paid || 0).toFixed(2);
      if (leftAmount) leftAmount.textContent = (data.left || 0).toFixed(2);
    } catch (err) {
      resetPaidSummary();
    }
  }

  // On customer change, reload products
  customerSelect.on('change', function(){
    const selectedId = $(this).val();
    const customer = customers.find(c => String(c._id) === String(selectedId));
    if (!isSusuMode) populateProducts(customer);
    resetPaidSummary();
  });

  // Auto-select customer (prefill if provided)
  if (prefillCustomerId) {
    customerSelect.val(prefillCustomerId).trigger('change');
  } else if (customers.length > 0) {
    const firstCustomerId = customers[0]._id;
    customerSelect.val(firstCustomerId).trigger('change');
  }

  productSelect.on('change', function(){
    if (isSusuMode) return;
    const customerId = customerSelect.val();
    const productIndex = $(this).val();
    fetchPaidSummary(customerId, productIndex);
  });

  // Optional dark mode toggle (if present in included navbar)
  $('#mode-toggle').on('click', function () {
    document.body.classList.toggle('dark-mode');
  });

  // SUSU toggle button
  susuBtn.on('click', function(){
    isSusuMode = !isSusuMode;
    if (isSusuMode) {
      productSection.hide();
      susuBtn.text('üõí Switch to Product Mode').removeClass('btn-warning').addClass('btn-success');
      isSusuInput.val('yes');
    } else {
      productSection.show();
      susuBtn.text('üîÅ Switch to SUSU Mode').removeClass('btn-success').addClass('btn-warning');
      isSusuInput.val('no');
      const selectedId = customerSelect.val();
      const customer = customers.find(c => String(c._id) === String(selectedId));
      populateProducts(customer);
    }
  });

  // ===== Simple SMS Toggle (default OFF) =====
  function setSms(on) {
    sendSmsInput.value = on ? 'yes' : 'no';
    smsToggleBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
    if (on) {
      smsToggleBtn.classList.remove('btn-outline-secondary');
      smsToggleBtn.classList.add('btn-success');
      smsToggleBtn.textContent = 'SMS: On';
      smsStatus.textContent = 'SMS: On';
      smsStatus.classList.remove('off'); smsStatus.classList.add('on');
    } else {
      smsToggleBtn.classList.add('btn-outline-secondary');
      smsToggleBtn.classList.remove('btn-success');
      smsToggleBtn.textContent = 'Turn SMS On';
      smsStatus.textContent = 'SMS: Off';
      smsStatus.classList.add('off'); smsStatus.classList.remove('on');
    }
  }
  // init OFF
  setSms(false);

  smsToggleBtn.addEventListener('click', () => {
    const next = sendSmsInput.value !== 'yes';
    setSms(next);
  });

  // Bootstrap modal helpers
  document.addEventListener('DOMContentLoaded', () => {
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    successModal = new bootstrap.Modal(document.getElementById('successModal'));
  });

  // Helpers to toggle button spinner
  function startBtnLoading(){
    submitBtn.disabled = true;
    submitSpinner.style.display = 'inline-block';
    submitLabel.textContent = 'Submitting...';
  }
  function stopBtnLoading(){
    submitBtn.disabled = false;
    submitSpinner.style.display = 'none';
    submitLabel.textContent = 'Submit Payment';
  }

  // Core request sender (handles force flow)
  async function sendPayment({ force = false } = {}){
    const url = form.getAttribute('action') || window.location.href;
    const method = (form.getAttribute('method') || 'POST').toUpperCase();
    const fd = new FormData(form);
    fd.set('force', force ? 'yes' : 'no'); // ensure force flag for second run

    const resp = await fetch(url, {
      method,
      body: fd,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    let data = null;
    try { data = await resp.clone().json(); } catch (_) {}

    return { ok: resp.ok, data };
  }

  // Confirm -> Loading -> (dup confirm) -> Success
  $('#paymentForm').on('submit', function(e){
    e.preventDefault();

    const amountVal = parseFloat(($('input[name="amount"]').val() || "0"));
    if (isNaN(amountVal) || amountVal <= 0) {
      Swal.fire({ icon: 'error', title: 'Invalid amount', text: 'Please enter a valid payment amount.' });
      return;
    }
    const formatted = amountVal.toFixed(2);

    const smsLine = (sendSmsInput.value === 'yes')
      ? '<span class="badge text-bg-success">SMS: On</span>'
      : '<span class="badge text-bg-secondary">SMS: Off</span>';

    Swal.fire({
      title: 'Confirm Payment',
      html: `
        <div style="font-size: 18px;line-height:1.4">
          <div class="mb-2"><strong>Amount:</strong> <span style="font-size: 24px; color: #007BFF;"><strong>GHS ${formatted}</strong></span></div>
          <div class="mb-2"><strong>Notify Customer:</strong> ${smsLine}</div>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#007BFF',
      cancelButtonColor: '#d33',
      confirmButtonText: '<b>Yes, Submit</b>',
      cancelButtonText: 'Cancel',
    }).then(async (result) => {
      if (!result.isConfirmed) return;

      // Show loading states
      loadingModal.show();
      startBtnLoading();

      try {
        // First attempt (without force)
        let { ok, data } = await sendPayment({ force: false });

        // If API returns needs_confirm (duplicate detected), ask user and resend with force
        if (data && data.needs_confirm === true) {
          loadingModal.hide(); // pause spinner for the confirm prompt
          stopBtnLoading();

          const scope = data.scope || 'this selection';
          const count = data.existing_count ?? 0;
          const total = (data.existing_total ?? 0).toFixed(2);
          const msg = data.message || `You already recorded ${count} payment(s) totaling GHS ${total} for ${scope}. Proceed anyway?`;

          const dup = await Swal.fire({
            title: 'Existing payment found',
            html: `<div style="font-size:16px">${msg}</div>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Proceed anyway',
            cancelButtonText: 'Cancel'
          });

          if (!dup.isConfirmed) return;

          // Resume loading and force insert
          loadingModal.show();
          startBtnLoading();

          ({ ok, data } = await sendPayment({ force: true }));
        }

        loadingModal.hide();
        stopBtnLoading();

        // Handle final result
        if (data && data.ok) {
          const customerText = ($('select[name="customer_id"] option:selected').text() || '').trim();
          const details = `GHS ${formatted} -  ${customerText}`;
          document.getElementById('successDetails').textContent = details;
          document.getElementById('viewPaymentsLink').setAttribute('href', VIEW_PAYMENTS_URL);
          successModal.show();

          // Reset form for another entry
          form.reset();
          // keep current customer selection + product list
          const selectedId = customerSelect.val();
          const customerObj = customers.find(c => String(c._id) === String(selectedId));
          if (!isSusuMode) populateProducts(customerObj);
          resetPaidSummary();

          // Reset flags back to defaults
          isSusuMode = false;
          isSusuInput.val('no');
          $('#forceInput').val('no');
          setSms(false); // default OFF after success
        } else {
          const message = (data && data.message) ? data.message : 'Could not save payment.';
          Swal.fire({ icon: 'error', title: 'Failed', text: message });
        }
      } catch (err) {
        loadingModal.hide();
        stopBtnLoading();
        Swal.fire({ icon: 'error', title: 'Network Error', text: 'Please check your connection and try again.' });
      }
    });
  });

  // Success modal buttons
  document.getElementById('addAnotherBtn')?.addEventListener('click', () => {
    successModal.hide();
    $('input[name="amount"]').focus();
  });

})();
</script>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  {% include 'app_footer.html' %}


</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Payment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 0; transition: background-color .3s ease; }
    .container { max-width: 550px; margin: 50px auto; background: #fff; padding: 30px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.1); animation: slideIn .8s forwards; }
    @keyframes slideIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    h2 { text-align: center; margin-bottom: 25px; color: #333; }
    label { margin-top: 12px; font-weight: 500; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ced4da; }

    /* Submit button + inline spinner */
    #submitBtn { width: 100%; margin-top: 20px; padding: 12px; background-color: #007BFF; border: none; color: #fff; font-size: 16px; border-radius: 8px; transition: background-color .3s ease; display:flex; align-items:center; justify-content:center; gap:.5rem; }
    #submitBtn:hover { background-color: #0056b3; }
    .btn-spinner {
      display: inline-block; width: 1rem; height: 1rem; border: .2rem solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%;
      animation: spin .8s linear infinite; vertical-align:middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .flash-message { padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; margin-bottom: 15px; text-align: center; }
    footer { background-color: #8a2be2; color: white; padding: 10px 0; text-align: center; margin-top: 50px; }
    .navbar { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
    .btn-toggle-mode { background: none; border: none; color: #333; font-size: 1.5em; cursor: pointer; }

    /* Dark mode */
    body.dark-mode { background-color: #121212; color: #fff; }
    body.dark-mode .container { background: #333; color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,.4); }
    body.dark-mode input, body.dark-mode select { background-color: #444; color: #fff; border-color: #555; }
    body.dark-mode .flash-message { background-color: #5a6268; color: #f8f9fa; }
    body.dark-mode footer { background-color: #6a1b9a; }

    /* View payments pill */
    .view-payments-link {
      background: linear-gradient(to right, #0dfd65, #06b36f);
      color: #fff; font-weight: 600; border-radius: 30px;
      box-shadow: 0 8px 16px rgba(13,253,101,.25);
      text-decoration: none; transition: all .4s ease;
      animation: slideInLinkLeft .8s ease forwards; opacity: 0; transform: translateX(-40px);
      padding: 12px 30px; display: inline-block;
    }
    .view-payments-link:hover { background: linear-gradient(to right, #06b36f, #039f58); transform: scale(1.05); box-shadow: 0 10px 20px rgba(13,253,101,.35); color: #fff; }
    @keyframes slideInLinkLeft { to { opacity: 1; transform: translateX(0); } }

    /* ------ Face ID‚Äìstyle loading ring ------ */
    .faceid-wrap { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; }
    .faceid-ring {
      width: 96px; height: 96px; border-radius: 50%; position: relative;
      background: radial-gradient(circle at 50% 50%, rgba(0,123,255,.08) 0 45%, transparent 46% 100%);
    }
    .faceid-arc, .faceid-arc:before, .faceid-arc:after {
      position: absolute; inset: 0; border-radius: 50%;
      border: 4px solid transparent; content: "";
    }
    .faceid-arc { border-top-color: #0d6efd; animation: spin 1.2s linear infinite; }
    .faceid-arc:before { border-right-color: #0d6efd; animation: spin 1.2s linear infinite reverse; }
    .faceid-arc:after { border-bottom-color: #0d6efd; animation: spin 1.6s linear infinite; }
    .loading-text { margin-top: 16px; font-weight: 600; color: #0b1320; }
    body.dark-mode .loading-text { color: #f8f9fa; }

    /* ------ Success check animation ------ */
    .checkmark { width: 120px; height: 120px; display:block; margin: 0 auto; }
    .checkmark__circle {
      stroke: #28a745; stroke-width: 4; stroke-miterlimit: 10; fill: none;
      animation: stroke 0.6s ease-in-out forwards;
    }
    .checkmark__check {
      transform-origin: 50% 50%; stroke: #28a745; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; fill: none;
      stroke-dasharray: 48; stroke-dashoffset: 48; animation: draw 0.35s 0.6s ease-out forwards;
    }
    @keyframes stroke { from { stroke-dasharray: 0 380; } to { stroke-dasharray: 380 380; } }
    @keyframes draw { to { stroke-dashoffset: 0; } }

    /* Tighter modal visuals */
    .modal-body p { margin: 0; }
  </style>
</head>
<body>

<!-- Navbar -->
{% include 'side_bar.html' %}

<!-- Main Content -->
<div class="container">
  <h2>Add Payment</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash-message">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="text-center mt-3 mb-2">
    <button type="button" id="toggleSusuBtn" class="btn btn-warning btn-sm">üîÅ Switch to SUSU Mode</button>
  </div>

  <form id="paymentForm" method="POST">
    <!-- Customer Dropdown -->
    <label for="customer_id">Select Customer</label>
    <select name="customer_id" class="form-select" required>
      {% for customer in customers %}
        <option value="{{ customer._id }}">{{ customer.name }} ({{ customer.phone_number }})</option>
      {% endfor %}
    </select>

    <!-- Product Section -->
    <div id="product-section">
      <label for="product_id">Select Product</label>
      <select name="product_id" id="productSelect" class="form-select">
        <option value="">Select a product</option>
      </select>
    </div>

    <!-- Hidden Field for SUSU Mode -->
    <input type="hidden" name="is_susu" id="isSusuInput" value="no">
    <!-- Hidden for SMS toggle -->
    <input type="hidden" name="send_sms" id="sendSmsInput" value="yes">
    <!-- Hidden for force insert (set only if user confirms duplicate) -->
    <input type="hidden" name="force" id="forceInput" value="no">

    <!-- Payment Method -->
    <label for="method">Payment Method</label>
    <select name="method" class="form-select" required>
      <option value="Cash">Cash</option>
      <option value="Mobile Money">Mobile Money</option>
    </select>

    <!-- Amount -->
    <label for="amount">Amount (GH‚Çµ)</label>
    <input type="number" name="amount" class="form-control" step="0.01" required>

    <!-- Date -->
    <label for="date">Payment Date</label>
    <select name="date" class="form-select" required>
      <option value="{{ today }}">Today ({{ today }})</option>
    </select>

    <!-- Submit Button (with spinner placeholder) -->
    <button type="submit" id="submitBtn">
      <span class="btn-label">Submit Payment</span>
      <span class="btn-spinner" style="display:none;"></span>
    </button>
  </form>
</div>

<!-- Footer -->
<footer><p>&copy; 2025 SMART LIVING. All Rights Reserved.</p></footer>

<!-- Loading Modal (Face ID style) -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body">
        <div class="faceid-wrap text-center">
          <div class="faceid-ring">
            <div class="faceid-arc"></div>
          </div>
          <div class="loading-text">Processing payment‚Ä¶</div>
          <div class="text-muted mt-2" style="font-size:.9rem;">Please keep this window open</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-body text-center p-4">
        <svg class="checkmark" viewBox="0 0 52 52" aria-hidden="true">
          <circle class="checkmark__circle" cx="26" cy="26" r="24"></circle>
          <path class="checkmark__check" d="M14 27 L22 34 L38 18"></path>
        </svg>
        <h5 class="mt-3 mb-2">Payment Recorded</h5>
        <p id="successDetails" class="text-muted mb-3"></p>
        <div class="d-flex gap-2 justify-content-center mt-2">
          <button class="btn btn-outline-secondary" id="addAnotherBtn">Add Another</button>
          <a class="view-payments-link" id="viewPaymentsLink" href="/payments">View Payments</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script id="customers-data" type="application/json">
  {{ customers | tojson }}
</script>

<script>
(function(){
  const VIEW_PAYMENTS_URL = "/payments"; // <-- change if your route is different

  const customers = JSON.parse(document.getElementById('customers-data').textContent || '[]');
  const customerSelect = $('select[name="customer_id"]');
  const productSelect = $('#productSelect');
  const productSection = $('#product-section');
  const isSusuInput = $('#isSusuInput');
  const susuBtn = $('#toggleSusuBtn');
  const form = document.getElementById('paymentForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitSpinner = submitBtn.querySelector('.btn-spinner');
  const submitLabel = submitBtn.querySelector('.btn-label');
  const forceInput = document.getElementById('forceInput');

  let isSusuMode = false;
  let loadingModal, successModal;

  // Init customer dropdown
  customerSelect.select2({ placeholder: "Select a customer", width: '100%' });

  // Populate products for a selected customer
  function populateProducts(customer){
    productSelect.empty().append('<option value="">Select a product</option>');
    if (customer && Array.isArray(customer.purchases)) {
      customer.purchases.forEach((p, i) => {
        const product = p.product || {};
        const name = product.name || 'Unnamed';
        const total = product.total || 0;
        productSelect.append(new Option(`${name} - GHS ${total}`, i));
      });
      if (customer.purchases.length === 1) productSelect.prop('selectedIndex', 1);
    }
  }

  // On customer change, reload products
  customerSelect.on('change', function(){
    const selectedId = $(this).val();
    const customer = customers.find(c => String(c._id) === String(selectedId));
    if (!isSusuMode) populateProducts(customer);
  });

  // Auto-select first customer
  if (customers.length > 0) {
    const firstCustomerId = customers[0]._id;
    customerSelect.val(firstCustomerId).trigger('change');
  }

  // Optional dark mode toggle (if present in included navbar)
  $('#mode-toggle').on('click', function () {
    document.body.classList.toggle('dark-mode');
  });

  // SUSU toggle button
  susuBtn.on('click', function(){
    isSusuMode = !isSusuMode;
    if (isSusuMode) {
      productSection.hide();
      susuBtn.text('üõí Switch to Product Mode').removeClass('btn-warning').addClass('btn-success');
      isSusuInput.val('yes');
    } else {
      productSection.show();
      susuBtn.text('üîÅ Switch to SUSU Mode').removeClass('btn-success').addClass('btn-warning');
      isSusuInput.val('no');
      const selectedId = customerSelect.val();
      const customer = customers.find(c => String(c._id) === String(selectedId));
      populateProducts(customer);
    }
  });

  // Bootstrap modal helpers
  document.addEventListener('DOMContentLoaded', () => {
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    successModal = new bootstrap.Modal(document.getElementById('successModal'));
  });

  // Helpers to toggle button spinner
  function startBtnLoading(){
    submitBtn.disabled = true;
    submitSpinner.style.display = 'inline-block';
    submitLabel.textContent = 'Submitting...';
  }
  function stopBtnLoading(){
    submitBtn.disabled = false;
    submitSpinner.style.display = 'none';
    submitLabel.textContent = 'Submit Payment';
  }

  // Core request sender (handles force flow)
  async function sendPayment({ force = false } = {}){
    const url = form.getAttribute('action') || window.location.href;
    const method = (form.getAttribute('method') || 'POST').toUpperCase();
    const fd = new FormData(form);
    fd.set('force', force ? 'yes' : 'no'); // ensure force flag for second run

    const resp = await fetch(url, {
      method,
      body: fd,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    let data = null;
    try { data = await resp.clone().json(); } catch (_) {}

    return { ok: resp.ok, data };
  }

  // SweetAlert confirm -> Loading Modal -> AJAX submit -> (duplicate?) -> Success Modal
  $('#paymentForm').on('submit', function(e){
    e.preventDefault();

    const amountVal = parseFloat(($('input[name="amount"]').val() || "0"));
    if (isNaN(amountVal) || amountVal <= 0) {
      Swal.fire({ icon: 'error', title: 'Invalid amount', text: 'Please enter a valid payment amount.' });
      return;
    }
    const formatted = amountVal.toFixed(2);
    let sendSms = true;

    // First confirmation before any submit
    Swal.fire({
      title: 'Confirm Payment',
      html: `
        <div style="font-size: 20px;"><strong>Submit payment of</strong><br>
        <span style="font-size: 28px; color: #007BFF;"><strong>GHS ${formatted}</strong></span>?</div>
        <div style="margin-top: 25px; text-align: center;">
          <button type="button" id="smsToggleBtn" class="btn btn-success mt-3" style="padding: 10px 20px; font-size: 16px;">‚úÖ Send SMS to customer</button>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#007BFF',
      cancelButtonColor: '#d33',
      confirmButtonText: '<b>Yes, Submit</b>',
      cancelButtonText: 'Cancel',
      didOpen: () => {
        const btn = document.getElementById('smsToggleBtn');
        btn.addEventListener('click', () => {
          sendSms = !sendSms;
          if (sendSms) {
            btn.classList.remove('btn-danger'); btn.classList.add('btn-success');
            btn.innerHTML = '‚úÖ Send SMS to customer';
          } else {
            btn.classList.remove('btn-success'); btn.classList.add('btn-danger');
            btn.innerHTML = '‚ùå Don\'t Send SMS';
          }
        });
      },
      preConfirm: () => { $('#sendSmsInput').val(sendSms ? 'yes' : 'no'); }
    }).then(async (result) => {
      if (!result.isConfirmed) return;

      // Show loading states
      loadingModal.show();
      startBtnLoading();

      try {
        // First attempt (without force)
        let { ok, data } = await sendPayment({ force: false });

        // If API returns needs_confirm (duplicate detected), ask user and resend with force
        if (data && data.needs_confirm === true) {
          loadingModal.hide(); // pause spinner for the confirm prompt
          stopBtnLoading();

          const scope = data.scope || 'this selection';
          const count = data.existing_count ?? 0;
          const total = (data.existing_total ?? 0).toFixed(2);
          const msg = data.message || `You already recorded ${count} payment(s) totaling GHS ${total} for ${scope}. Proceed anyway?`;

          const dup = await Swal.fire({
            title: 'Existing payment found',
            html: `<div style="font-size:16px">${msg}</div>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Proceed anyway',
            cancelButtonText: 'Cancel'
          });

          if (!dup.isConfirmed) return;

          // Resume loading and force insert
          loadingModal.show();
          startBtnLoading();

          ({ ok, data } = await sendPayment({ force: true }));
        }

        loadingModal.hide();
        stopBtnLoading();

        // Handle final result
        if (data && data.ok) {
          const customerText = ($('select[name="customer_id"] option:selected').text() || '').trim();
          const details = `GHS ${formatted} ‚Ä¢ ${customerText}`;
          document.getElementById('successDetails').textContent = details;
          document.getElementById('viewPaymentsLink').setAttribute('href', VIEW_PAYMENTS_URL);
          successModal.show();

          // Reset form for another entry
          form.reset();
          $('#sendSmsInput').val('yes');
          forceInput.value = 'no';
          if (!isSusuMode) {
            const selectedId = customerSelect.val();
            const customerObj = customers.find(c => String(c._id) === String(selectedId));
            populateProducts(customerObj);
          }
        } else {
          const message = (data && data.message) ? data.message : 'Could not save payment.';
          Swal.fire({ icon: 'error', title: 'Failed', text: message });
        }
      } catch (err) {
        loadingModal.hide();
        stopBtnLoading();
        Swal.fire({ icon: 'error', title: 'Network Error', text: 'Please check your connection and try again.' });
      }
    });
  });

  // Success modal buttons
  document.getElementById('addAnotherBtn')?.addEventListener('click', () => {
    successModal.hide();
    $('input[name="amount"]').focus();
  });

})();
</script>

<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

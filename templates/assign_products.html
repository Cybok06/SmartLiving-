<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Assigned Products</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg">

  <style>
    body { background:#f7f8fa; color:#212529; }
    .page-header { position: sticky; top: 8px; z-index: 10; background:#f7f8fa; padding-bottom:.5rem; }
    .card { border:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .table thead th { background:#0d6efd; color:#fff; }
    .badge-ok { background:#198754; }
    .badge-warn { background:#ffc107; color:#212529; }
    .select2-container--default .select2-selection--single { height: 38px; }
    .select2-container .select2-selection--single .select2-selection__rendered { line-height: 38px; }
    .select2-container .select2-selection--single .select2-selection__arrow { height: 36px; }
  </style>
</head>
<body>

  {% include 'inventory_sidebar.html' %}

  <main class="inv-content">
    <div class="inv-page">

      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <h2 class="mb-2">Assigned Products</h2>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-primary btn-sm"
               href="{{ url_for('assigned_products.products_sold',
                                product_key=f_key,
                                manager_id=f_manager,
                                branch=f_branch,
                                q=free_text,
                                export=1) if false else '#' }}"
               onclick="alert('CSV export can be added similarly to other pages.'); return false;">
              Export CSV
            </a>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-3">
        <div class="card-body">
          <form class="row g-2" method="GET" action="{{ url_for('assigned_products.products_sold') }}">
            <!-- Product (Select2) -->
            <div class="col-12 col-md-4">
              <label class="form-label">Product</label>
              <select class="form-select" id="sel-product" name="product_key" data-placeholder="All products">
                <option value="">All products</option>
                {% for p in products_unique %}
                  {% set label = p.name ~ ' -- GH₵' ~ (('%.2f'|format(p.price)) if p.price is number else p.price) %}
                  <option value="{{ p.key }}" {% if f_key == p.key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Manager (Select2) -->
            <div class="col-12 col-md-4">
              <label class="form-label">Manager</label>
              <select class="form-select" id="sel-manager" name="manager_id" data-placeholder="All managers">
                <option value="">All managers</option>
                {% for m in managers %}
                  <option value="{{ m._id }}" {% if f_manager == m._id %}selected{% endif %}>
                    {{ m.name }} -- {{ m.branch }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Branch -->
            <div class="col-12 col-md-3">
              <label class="form-label">Branch</label>
              <select class="form-select" name="branch">
                <option value="">All branches</option>
                {% for b in branches %}
                  <option value="{{ b }}" {% if f_branch == b %}selected{% endif %}>{{ b }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Free text -->
            <div class="col-12 col-md-3">
              <label class="form-label">Search</label>
              <input type="text" class="form-control" name="q" placeholder="manager / branch / product / sku"
                     value="{{ free_text }}">
            </div>

            <div class="col-12 d-flex gap-2 mt-1">
              <button class="btn btn-primary">Apply</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('assigned_products.products_sold') }}">Reset</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Results -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Branch</th>
                  <th>Manager</th>
                  <th>Product</th>
                  <th>SKU</th>
                  <th class="text-end">Assigned</th>
                  <th class="text-end">Sent</th>
                  <th class="text-end">Remaining</th>
                  <th>Updated</th>
                  {% if can_edit %}<th style="width: 160px;">Actions</th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% if rows and rows|length > 0 %}
                  {% for r in rows %}
                    <tr>
                      <td>{{ loop.index }}</td>
                      <td>{{ r.manager_branch or '--' }}</td>
                      <td>{{ r.manager_name or '--' }}</td>
                      <td>{{ r.product_name or '--' }}</td>
                      <td>{{ r.product_sku or '--' }}</td>
                      <td class="text-end">{{ r.assigned_total or 0 }}</td>
                      <td class="text-end">{{ r.sent_total or 0 }}</td>
                      <td class="text-end">
                        {% if (r.remaining or 0) > 0 %}
                          <span class="badge badge-warn">{{ r.remaining }}</span>
                        {% else %}
                          <span class="badge badge-ok">0</span>
                        {% endif %}
                      </td>
                      <td>{% if r.updated_at %}{{ r.updated_at.strftime('%Y-%m-%d %H:%M') }}{% else %}--{% endif %}</td>

                      {% if can_edit %}
                      <td>
                        <button class="btn btn-sm btn-outline-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#editAssignedModal"
                                data-id="{{ r._id }}"
                                data-manager="{{ r.manager_name }}"
                                data-branch="{{ r.manager_branch }}"
                                data-product="{{ r.product_name }}"
                                data-current="{{ r.assigned_total }}"
                                data-sent="{{ r.sent_total }}">
                          Edit Assigned
                        </button>
                      </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="10" class="text-center py-4">No results.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {% if can_edit %}
      <!-- Edit Assigned Modal -->
      <div class="modal fade" id="editAssignedModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <form class="modal-content" method="POST" action="{{ url_for('assigned_products.update_assigned_quantity') }}">
            <div class="modal-header">
              <h5 class="modal-title">Update Assigned Quantity</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="assignment_id" id="ea-id">
              <div class="mb-2">
                <div class="small text-muted">Manager / Branch:</div>
                <div class="fw-semibold" id="ea-mgr">--</div>
              </div>
              <div class="mb-2">
                <div class="small text-muted">Product:</div>
                <div class="fw-semibold" id="ea-prod">--</div>
              </div>
              <div class="mb-2">
                <div class="small text-muted">Sent so far:</div>
                <div class="badge bg-info" id="ea-sent">0</div>
              </div>
              <div class="mb-3">
                <label class="form-label">New assigned total</label>
                <input type="number" class="form-control" min="0" name="new_assigned" id="ea-new" required>
                <div class="form-text">Must be ≥ "sent so far".</div>
              </div>
              <div class="mb-1">
                <label class="form-label">Note (optional)</label>
                <input type="text" name="note" class="form-control" placeholder="Reason for adjustment">
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // init Select2 on two selects
    $(function(){
      $('#sel-product').select2({ width: '100%', placeholder: $('#sel-product').data('placeholder') || 'All products' });
      $('#sel-manager').select2({ width: '100%', placeholder: $('#sel-manager').data('placeholder') || 'All managers' });
    });

    // Fill Edit modal
    const editModal = document.getElementById('editAssignedModal');
    editModal?.addEventListener('show.bs.modal', function (e) {
      const btn = e.relatedTarget;
      const id  = btn.getAttribute('data-id');
      const mgr = btn.getAttribute('data-manager');
      const br  = btn.getAttribute('data-branch');
      const pr  = btn.getAttribute('data-product');
      const cur = btn.getAttribute('data-current');
      const sent= btn.getAttribute('data-sent');

      this.querySelector('#ea-id').value = id;
      this.querySelector('#ea-mgr').textContent = `${mgr || '--'} -- ${br || '--'}`;
      this.querySelector('#ea-prod').textContent = pr || '--';
      this.querySelector('#ea-new').value = cur || 0;
      this.querySelector('#ea-sent').textContent = sent || 0;
      this.querySelector('#ea-new').min = sent || 0;
    });
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

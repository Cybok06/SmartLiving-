{# templates/manager/deposits.html #}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manager Deposits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon"
          href="https://imagedelivery.net/h9fmMoa1o2c2P55TcWJGOg/10283f28-b9a0-4100-b254-19a854386800/public"
          type="image/png">
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --ring:#e9eef5; --soft:#f7fafc; --brand:#0d6efd; }
    body{ background:#f6f8fb; color:var(--ink); }
    .card { border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.06); }
    .preview { max-width: 160px; max-height: 160px; border: 1px dashed #ced4da; border-radius: 10px; object-fit: contain; }
    .pill { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:999px; font-size:.75rem; background:#f1f3f5; }
    .table td, .table th{ vertical-align: middle; }
    .iconify{ width:18px; height:18px; }
    .spinner-inline{ width:1rem; height:1rem; border:.2rem solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; display:none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .method-badge i{ margin-right:.25rem }
  </style>
</head>
<body>
  {% include 'side_bar.html' %}

<div class="container py-4">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category in ['danger','error'] else category }} mb-2">
            <i class="bi bi-info-circle me-2"></i>{{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <h3 class="m-0">
      <i class="bi bi-bank2 me-2"></i>Manager Deposits
    </h3>
    <div>
      <span class="pill me-2"><i class="bi bi-person-badge"></i> Manager: <strong>{{ manager_name }}</strong></span>
      <span class="pill"><i class="bi bi-geo"></i> Branch: <strong>{{ branch_name }}</strong></span>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card mb-4">
    <div class="card-body">
      <form id="depositForm"
            action="{{ url_for('manager_deposits.submit_deposit') }}"
            method="POST"
            enctype="multipart/form-data"
            class="row g-3">

        <!-- Amount -->
        <div class="col-12 col-md-4">
          <label class="form-label">Amount (GHS)</label>
          <div class="input-group">
            <span class="input-group-text">GHS</span>
            <input type="number" name="amount" id="amount" step="0.01" min="0.01" class="form-control" required>
          </div>
          <div class="form-text">Enter the exact amount you deposited.</div>
        </div>

        <!-- Method Type -->
        <div class="col-12 col-md-4">
          <label class="form-label">Method</label>
          <select name="method_type" id="method_type" class="form-select" required>
            <option value="" selected disabled>-- Select --</option>
            <option value="Bank">Bank</option>
            <option value="Mobile Money">Mobile Money</option>
            <option value="Cash">Cash</option>
          </select>
          <div class="form-text">
            Choose how the money was deposited.
          </div>
        </div>

        <!-- Account / Wallet (for Bank & MoMo) -->
        <div class="col-12 col-md-4" id="bankAccountWrapper">
          <label class="form-label">Account / Wallet</label>
          <select name="bank_account_id" id="bank_account_id" class="form-select">
            <option value="">-- Select Account / Wallet --</option>
            {# options will be populated dynamically in JS based on method_type #}
          </select>
          <div class="form-text">
            For Bank or Mobile Money deposits, select the exact account / wallet used.
          </div>
        </div>

        <!-- Method Name / Cash office (only for Cash) -->
        <div class="col-12 col-md-6" id="methodNameWrapper">
          <label class="form-label" id="method_name_label">Cash Office / Location (optional)</label>
          <input type="text"
                 name="method_name"
                 id="method_name"
                 class="form-control"
                 placeholder="e.g., Cash Office / Teller">
          <div class="form-text" id="method_name_help">
            Optional. You may specify the cash office or teller name.
          </div>
        </div>

        <!-- Reference -->
        <div class="col-12 col-md-6">
          <label class="form-label">Reference (optional)</label>
          <input type="text" name="reference" class="form-control" placeholder="Txn ID / Slip number">
        </div>

        <!-- Notes -->
        <div class="col-12 col-md-6">
          <label class="form-label">Notes (optional)</label>
          <input type="text" name="notes" class="form-control" placeholder="Any extra info">
        </div>

        <!-- Receipt Upload -->
        <div class="col-12 col-md-6">
          <label class="form-label">Upload Receipt (Image/PDF)</label>
          <input type="file" name="receipt" id="receipt" accept=".png,.jpg,.jpeg,.webp,.pdf" class="form-control" required>
          <div class="form-text">Allowed: png, jpg, jpeg, webp, pdf</div>
        </div>

        <!-- Preview -->
        <div class="col-12 col-md-6 d-flex align-items-end">
          <img id="preview" class="preview d-none" alt="preview">
          <span id="pdfNote" class="ms-3 text-muted d-none">
            <i class="bi bi-file-earmark-pdf me-1"></i>PDF selected (no preview)
          </span>
        </div>

        <!-- Buttons -->
        <div class="col-12 d-flex gap-2">
          <button id="submitBtn" class="btn btn-primary px-4">
            <span class="btn-label"><i class="bi bi-cloud-upload me-2"></i>Submit Deposit</span>
            <span class="spinner-inline ms-2" id="btnSpinner"></span>
          </button>
          <button type="reset" class="btn btn-outline-secondary">
            <i class="bi bi-eraser me-1"></i>Clear
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recent Submissions -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0"><i class="bi bi-clock-history me-2"></i>Recent Submissions</h5>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Ref</th>
            <th>Receipt</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody>
          {% if recent %}
            {% for r in recent %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  {% if r.created_at %}
                    {{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at.strftime else r.created_at }}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <span class="fw-semibold">GHS {{ "%.2f"|format((r.amount or 0)|float) }}</span>
                </td>
                <td>
                  {% set mt = (r.method_type or '') %}
                  {% set badge = 'secondary' %}
                  {% set icon  = 'wallet' %}
                  {% if mt == 'Bank' %}{% set badge='primary' %}{% set icon='bank' %}{% endif %}
                  {% if mt == 'Mobile Money' %}{% set badge='success' %}{% set icon='phone' %}{% endif %}
                  {% if mt == 'Cash' %}{% set badge='warning' %}{% set icon='cash-coin' %}{% endif %}

                  <span class="badge bg-{{ badge }} method-badge">
                    <i class="bi bi-{{ icon }}"></i>{{ mt or '--' }}
                  </span>
                  {% if r.method_name %}
                    <small class="text-muted">({{ r.method_name }})</small>
                  {% endif %}
                </td>
                <td>{{ r.reference or "--" }}</td>
                <td>
                  {% if r.receipt_path %}
                    <a class="btn btn-outline-secondary btn-sm" target="_blank"
                       href="{{ url_for('serve_uploaded_file', filename=r.receipt_path) }}">
                      <i class="bi bi-box-arrow-up-right"></i> Open
                    </a>
                  {% else %}
                    --
                  {% endif %}
                </td>
                <td>
                  {% set st=(r.status or 'submitted') %}
                  {% set sb='secondary' %}
                  {% if st=='approved' %}{% set sb='success' %}{% endif %}
                  {% if st=='rejected' %}{% set sb='danger' %}{% endif %}
                  <span class="badge bg-{{ sb }}"><i class="bi bi-dot"></i>{{ st|capitalize }}</span>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted py-3">
                <i class="bi bi-inbox"></i> No submissions yet.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script id="bankAccountsData" type="application/json">
  {{ bank_accounts|tojson|safe }}
</script>

<script>
  // Make all accounts (bank + mobile) available to JS as a JSON array
  const BANK_ACCOUNTS = JSON.parse(document.getElementById('bankAccountsData').textContent || '[]');

  // Controls
  const form               = document.getElementById('depositForm');
  const input              = document.getElementById('receipt');
  const img                = document.getElementById('preview');
  const pdfNote            = document.getElementById('pdfNote');
  const submitBtn          = document.getElementById('submitBtn');
  const btnSpinner         = document.getElementById('btnSpinner');
  const methodType         = document.getElementById('method_type');
  const methodName         = document.getElementById('method_name');
  const methodNameWrapper  = document.getElementById('methodNameWrapper');
  const methodNameLabel    = document.getElementById('method_name_label');
  const methodNameHelp     = document.getElementById('method_name_help');
  const bankAccountWrapper = document.getElementById('bankAccountWrapper');
  const bankAccountSelect  = document.getElementById('bank_account_id');

  // File preview
  input.addEventListener('change', () => {
    img.classList.add('d-none');
    pdfNote.classList.add('d-none');
    const file = input.files && input.files[0];
    if (!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'pdf') {
      pdfNote.classList.remove('d-none');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      img.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
  });

  function rebuildAccountOptions() {
    const methodVal = methodType.value; // "Bank" | "Mobile Money" | "Cash" | ""
    let allowedTypes = [];

    if (methodVal === 'Bank') {
      allowedTypes = ['bank'];
    } else if (methodVal === 'Mobile Money') {
      allowedTypes = ['mobile'];
    } else {
      allowedTypes = [];
    }

    // Reset select options
    bankAccountSelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = '-- Select Account / Wallet --';
    bankAccountSelect.appendChild(placeholder);

    if (!allowedTypes.length) {
      return; // For Cash or no method selected
    }

    BANK_ACCOUNTS.forEach(acc => {
      const t = (acc.account_type || 'bank').toLowerCase();
      if (allowedTypes.includes(t)) {
        const opt = document.createElement('option');
        opt.value = acc.id;
        opt.textContent = acc.label;
        bankAccountSelect.appendChild(opt);
      }
    });
  }

  function updateMethodUI() {
    const val = methodType.value;

    // Reset visibility and requirements
    bankAccountWrapper.classList.add('d-none');
    methodNameWrapper.classList.add('d-none');
    methodName.required = false;
    bankAccountSelect.required = false;
    bankAccountSelect.value = '';

    if (val === 'Bank' || val === 'Mobile Money') {
      // For Bank & MoMo: must pick an account / wallet
      rebuildAccountOptions();
      bankAccountWrapper.classList.remove('d-none');
      bankAccountSelect.required = true;
    } else if (val === 'Cash') {
      // Cash: account not needed, allow free text for cash office
      methodNameWrapper.classList.remove('d-none');
      methodNameLabel.textContent = 'Cash Office / Location (optional)';
      methodName.placeholder = 'e.g., Cash Office / Teller';
      methodNameHelp.textContent = 'Optional. You may specify the cash office or teller name.';
      methodName.required = false;
    }
  }

  methodType.addEventListener('change', updateMethodUI);
  // Initialize on load
  updateMethodUI();

  // Disable/Spinner on submit
  form.addEventListener('submit', () => {
    submitBtn.disabled = true;
    btnSpinner.style.display = 'inline-block';
  });
</script>
  {% include 'app_footer.html' %}

</body>
</html>

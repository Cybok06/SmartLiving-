{# templates/manager/deposits.html #}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manager Deposits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .card {
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.06);
    }
    .preview {
      max-width: 160px;
      max-height: 160px;
      border: 1px dashed #ced4da;
      border-radius: 10px;
      object-fit: contain;
    }
    .pill {
      display: inline-block;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: .75rem;
      background: #f1f3f5;
    }
  </style>
</head>
<body class="bg-light">
  {% include 'side_bar.html' %}

<div class="container py-4">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category=='danger' else category }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">Manager Deposits</h3>
    <div>
      <span class="pill me-2">Manager: <strong>{{ manager_name }}</strong></span>
      <span class="pill">Branch: <strong>{{ branch_name }}</strong></span>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card mb-4">
    <div class="card-body">
      <form action="{{ url_for('manager_deposits.submit_deposit') }}" method="POST" enctype="multipart/form-data" class="row g-3">

        <div class="col-12 col-md-4">
          <label class="form-label">Amount (GHS)</label>
          <input type="number" name="amount" step="0.01" min="0" class="form-control" required>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Method</label>
          <select name="method_type" id="method_type" class="form-select" required>
            <option value="" selected disabled>-- Select --</option>
            <option value="Bank">Bank</option>
            <option value="Mobile Money">Mobile Money</option>
          </select>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Name of Method</label>
          <input type="text" name="method_name" id="method_name" class="form-control"
                 placeholder="e.g., GCB / Ecobank / MTN MoMo / Vodafone Cash" required>
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Reference (optional)</label>
          <input type="text" name="reference" class="form-control" placeholder="Txn ID / Slip number">
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Notes (optional)</label>
          <input type="text" name="notes" class="form-control" placeholder="Any extra info">
        </div>

        <div class="col-12 col-md-6">
          <label class="form-label">Upload Receipt (Image/PDF)</label>
          <input type="file" name="receipt" id="receipt" accept=".png,.jpg,.jpeg,.webp,.pdf" class="form-control" required>
          <div class="form-text">Allowed: png, jpg, jpeg, webp, pdf</div>
        </div>

        <div class="col-12 col-md-6 d-flex align-items-end">
          <img id="preview" class="preview d-none" alt="preview">
          <span id="pdfNote" class="ms-3 text-muted d-none">PDF selected (no preview)</span>
        </div>

        <div class="col-12">
          <button class="btn btn-primary px-4">Submit Deposit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recent Submissions -->
  <div class="card">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0">Recent Submissions</h5>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Ref</th>
            <th>Receipt</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody>
          {% if recent %}
            {% for r in recent %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ (r.created_at | default('')) }}</td>
                <td>GHS {{ "%.2f"|format(r.amount|float) }}</td>
                <td>{{ r.method_type }} <small class="text-muted">({{ r.method_name }})</small></td>
                <td>{{ r.reference or "-" }}</td>
                <td>
                  {% if r.receipt_path %}
                    {# Your serve route is /uploads/<path> #}
                    <a class="btn btn-outline-secondary btn-sm" target="_blank"
                       href="{{ url_for('serve_uploaded_file', filename=r.receipt_path) }}">Open</a>
                  {% else %}
                    â€”
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-secondary">{{ r.status or 'submitted' }}</span>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" class="text-center text-muted py-3">No submissions yet.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  // Simple client preview for images
  const input = document.getElementById('receipt');
  const img   = document.getElementById('preview');
  const pdfNote = document.getElementById('pdfNote');

  input.addEventListener('change', () => {
    img.classList.add('d-none');
    pdfNote.classList.add('d-none');

    const file = input.files && input.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();
    if (ext === 'pdf') {
      pdfNote.classList.remove('d-none');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      img.classList.remove('d-none');
    };
    reader.readAsDataURL(file);
  });
</script>
</body>
</html>

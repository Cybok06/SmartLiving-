<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Product</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    body.dark-mode {
      background-color: #181818;
      color: #f0f0f0;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    body.dark-mode .container {
      background-color: #242424;
      color: #f0f0f0;
    }
    h2 {
      text-align: center;
      color: #4e54c8;
      margin-bottom: 25px;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0 15px;
      box-sizing: border-box;
    }
    button {
      background-color: #4e54c8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3a40a4;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
    }
    .inventory-item, .manager-item {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }
    body.dark-mode .inventory-item, 
    body.dark-mode .manager-item {
      background-color: #333;
      border-color: #555;
    }
    .inventory-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .qty-input {
      width: 60px;
      margin-top: 8px;
      display: none;
    }
    .select-all-btn {
      background-color: #ff9800;
      margin: 10px 0;
    }
    .flash {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      color: white;
    }
    .flash.success { background-color: #28a745; }
    .flash.danger { background-color: #dc3545; }

    #upload-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .spinner-border {
      width: 1.2rem;
      height: 1.2rem;
    }

    .jump-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #4e54c8;
      color: white;
      border-radius: 50%;
      border: none;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .qty-input { width: 100%; }
    }
    #loadingOverlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(255,255,255,0.8);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}
select.form-select {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  color: #333;
  padding: 10px;
  font-size: 16px;
  transition: border-color 0.3s, box-shadow 0.3s;
}

body.dark-mode select.form-select {
  background-color: #2a2a2a;
  border-color: #555;
  color: #f0f0f0;
}

select.form-select:focus {
  border-color: #4e54c8;
  box-shadow: 0 0 0 2px rgba(78, 84, 200, 0.3);
  outline: none;
}

#customProductType, #customCategory {
  background-color: #f9f9f9;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 10px;
  margin-top: -8px;
  font-size: 15px;
  color: #333;
}

body.dark-mode #customProductType,
body.dark-mode #customCategory {
  background-color: #333;
  border-color: #555;
  color: #f0f0f0;
}


  </style>
</head>
<body>
    {% include 'inventory_sidebar.html' %}


<div class="container">
  <button class="jump-btn" onclick="document.querySelector('.manager-item').scrollIntoView({behavior: 'smooth'})">➤</button>

  <h2>Add New Product</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" enctype="multipart/form-data" oninput="storeInputs()">
  <label>Product Name:</label>
  <input type="text" name="name" required id="name">

  <label>Product Type:</label>
<select name="product_type" id="product_type" class="form-select" onchange="toggleCustomInput(this, 'customProductType')">
  <option value="">-- Select existing --</option>
  {% for pt in product_types %}
    <option value="{{ pt }}">{{ pt }}</option>
  {% endfor %}
  <option value="__custom__">Add new product type</option>
</select>
<input type="text" id="customProductType" name="custom_product_type" placeholder="Enter new product type" style="display: none;">

<label>Category (Optional):</label>
<select name="category" id="category" class="form-select" onchange="toggleCustomInput(this, 'customCategory')">
  <option value="">-- Select existing --</option>
  {% for cat in categories %}
    <option value="{{ cat }}">{{ cat }}</option>
  {% endfor %}
  <option value="__custom__">Add new category</option>
</select>
<input type="text" id="customCategory" name="custom_category" placeholder="Enter new category" style="display: none;">


  <label>Package Name (Optional):</label>
  <input type="text" name="package_name" id="package_name">

  <label>Price (GHS):</label>
  <input type="number" step="0.01" name="price" required id="price">

  <label>Cash Price (GHS):</label>
  <input type="number" step="0.01" name="cash_price" required id="cash_price">

  <label>Upload Product Image:</label>
  <input type="file" id="image" accept="image/*" required>
  <input type="hidden" id="image_url" name="image_url">
  <div id="upload-status"></div>

  <label>Description:</label>
  <textarea name="description" rows="3" required id="description"></textarea>

  <label>Search Inventory Components:</label>
  <input type="text" class="search-bar" id="inventorySearch" placeholder="Search component by name...">

  <label>Select Inventory Components (with quantity):</label>
  <div class="grid" id="inventoryGrid">
    {% for key, inv in inventory.items() %}
      {% set encoded_key = key | urlencode %}
      <div class="inventory-item" data-name="{{ inv.name | lower }}">
        <img src="{{ inv.image_url }}" alt="Item">
        <div><strong>{{ inv.name }}</strong></div>
        <div>Price: GHS {{ inv.price }}</div>
        <div>Description: {{ inv.description }}</div>
        <input type="checkbox" name="components" value="{{ encoded_key }}" onchange="toggleQty(this)">
        <input type="number" name="qty_{{ encoded_key }}" class="qty-input" min="1" placeholder="Qty">
      </div>
    {% endfor %}
  </div>

  <label>Select Managers:</label>
  <button type="button" class="select-all-btn" onclick="selectAllManagers()">Select All Managers</button>
  <div class="grid">
    {% for manager in managers %}
      <div class="manager-item">
        <div><strong>{{ manager.name }}</strong></div>
        <small>{{ manager.branch }}</small>
        <input type="checkbox" class="manager-checkbox" name="managers" value="{{ manager._id }}">
      </div>
    {% endfor %}
  </div>

  <button type="submit">Add Product</button>
</form>

</div>
<div id="loadingOverlay">
  <div class="spinner-border text-primary spinner-border-lg" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>
<script>
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = document.getElementById('darkModeToggle');
    btn.textContent = document.body.classList.contains('dark-mode') ? '🌞' : '🌙';
  }

  function showLoading() {
    const overlay = document.getElementById("loadingOverlay");
    if (overlay) overlay.style.display = "flex";
  }

  function toggleQty(checkbox) {
    const qtyField = checkbox.nextElementSibling;
    qtyField.style.display = checkbox.checked ? 'inline-block' : 'none';
    if (!checkbox.checked) qtyField.value = '';
  }

  function selectAllManagers() {
    document.querySelectorAll('.manager-checkbox').forEach(cb => cb.checked = true);
  }

  function storeInputs() {
    const fields = ['name', 'product_type', 'price', 'cash_price', 'description'];
    fields.forEach(id => {
      const input = document.getElementById(id);
      if (input) localStorage.setItem(id, input.value);
    });
  }

  function loadInputs() {
    const fields = ['name', 'product_type', 'price', 'cash_price', 'description'];
    fields.forEach(id => {
      const input = document.getElementById(id);
      const saved = localStorage.getItem(id);
      if (saved && input) input.value = saved;
    });
  }

  function toggleCustomInput(selectEl, inputId) {
    const input = document.getElementById(inputId);
    if (selectEl.value === "__custom__") {
      input.style.display = "block";
      input.name = selectEl.name;
      selectEl.name = "old_" + selectEl.name;
    } else {
      input.style.display = "none";
      input.name = "ignore_" + selectEl.name;
      selectEl.name = input.name.replace("ignore_", "");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    loadInputs();

    const overlay = document.getElementById("loadingOverlay");
    if (overlay) overlay.style.display = "none";

    const inventorySearch = document.getElementById('inventorySearch');
    if (inventorySearch) {
      inventorySearch.addEventListener('input', function () {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#inventoryGrid .inventory-item').forEach(item => {
          const name = item.getAttribute('data-name');
          item.style.display = name.includes(query) ? 'block' : 'none';
        });
      });
    }

    // ✅ NEW: Upload to backend (Render Disk)
    const imageInput = document.getElementById('image');
    if (imageInput) {
      imageInput.addEventListener('change', async function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const uploadStatus = document.getElementById('upload-status');
        uploadStatus.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><span> Uploading image...</span>';

        const formData = new FormData();
        formData.append('image', file);

        try {
          const response = await fetch('/products/upload_image', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          if (data.success) {
            document.getElementById('image_url').value = data.image_url;
            uploadStatus.innerHTML = "✅ Image uploaded successfully.";
          } else {
            uploadStatus.innerHTML = "❌ Upload failed. Please try again.";
            console.error(data);
          }
        } catch (err) {
          uploadStatus.innerHTML = "❌ Upload failed. Network error.";
          console.error(err);
        }
      });
    }
  });

  // Hide overlay if navigating back
  window.addEventListener("pageshow", function () {
    const overlay = document.getElementById("loadingOverlay");
    if (overlay) overlay.style.display = "none";
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

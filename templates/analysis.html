<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg">

    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        main {
            margin-top: 80px;
            margin-bottom: 60px;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            font-weight: bold;
            animation: fadeIn 1s ease-in-out;
        }

        .chart-container {
            background: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: slideIn 0.7s ease-out;
        }

        canvas {
            max-width: 100%;
        }

        /* Loader */
        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            color: rgb(158, 15, 146);
            display: none;
            animation: pulse 1s infinite;
        }

        footer {
            background-color: rgb(158, 15, 146);
            color: white;
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
            animation: fadeIn 1s ease-in-out;
        }

        footer p {
            margin: 0;
        }

        /* Navbar Styles */
        .navbar {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.5);
            transition: background-color 0.3s ease-in-out;
        }

        .navbar-brand img {
            transition: transform 0.3s ease-in-out;
        }

        .navbar-brand:hover img {
            transform: scale(1.1);
        }

        .navbar-toggler-icon {
            transition: transform 0.3s ease-in-out;
        }

        .navbar-toggler-icon:hover {
            transform: rotate(90deg);
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #333;
            color: #f4f4f4;
        }

        body.dark-mode .chart-container {
            background-color: #444;
            color: white;
        }

        body.dark-mode footer {
            background-color: #222;
        }

        body.dark-mode .navbar {
            background-color: rgba(30, 30, 30, 0.7);
        }

        body.dark-mode .navbar a {
            color: #f4f4f4;
        }

        /* Animations */
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes slideIn {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Button Hover Effects */
        .nav-link {
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: #007bff;
        }
    </style>
</head>
<body>

{% include 'side_bar.html' %}


    <!-- Main content -->
    <main>
        <h1>CRM Analysis Dashboard</h1>

        <!-- Loading Spinner -->
        <div class="loader">
            <i class="fas fa-spinner fa-spin"></i> Loading data...
        </div>

        <div class="chart-container">
            <h3>Payment Trends (Last 30 Days)</h3>
            <canvas id="paymentTrendChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Amount Owing vs Amount Collected</h3>
            <canvas id="amountChart"></canvas>
        </div>

        <div class="chart-container">
            <h3>Most Purchased Products</h3>
            <canvas id="productChart"></canvas>
        </div>

       
        
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 SMART LIVING CRM. All Rights Reserved.</p>
    </footer>

    <!-- Bootstrap JS (Optional for functionality like toggling the navbar) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to toggle between light and dark mode
        function toggleMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const modeIcon = document.querySelector('.nav-link[onclick="toggleMode()"]');
            modeIcon.textContent = body.classList.contains('dark-mode') ? 'ðŸŒž' : 'ðŸŒ™';
        }
    
        // Show the loader initially
        document.querySelector('.loader').style.display = 'block';
    
        // Fetch data and render charts
        fetch('/analysis/report_data')
            .then(response => response.json())
            .then(data => {
                document.querySelector('.loader').style.display = 'none';
    
                // Payment Trends Chart
                const paymentLabels = data.payment_data.map(d => d.date);
                const paymentTotals = data.payment_data.map(d => d.total_payment);
    
                new Chart(document.getElementById('paymentTrendChart'), {
                    type: 'line',
                    data: {
                        labels: paymentLabels,
                        datasets: [{
                            label: 'Total Payments (GHC)',
                            data: paymentTotals,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
    
                // Amount Owing vs Collected Chart
                new Chart(document.getElementById('amountChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Amount Owing', 'Amount Collected'],
                        datasets: [{
                            label: 'GHC',
                            data: [data.total_debt, data.total_collected],
                            backgroundColor: ['#FF6384', '#4BC0C0']
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
    
                // Most Purchased Products Chart
                const productLabels = data.most_purchased_products.map(p => p.product);
                const productCounts = data.most_purchased_products.map(p => p.count);
    
                new Chart(document.getElementById('productChart'), {
                    type: 'bar',
                    data: {
                        labels: productLabels,
                        datasets: [{
                            label: 'Units Sold',
                            data: productCounts,
                            backgroundColor: '#FFCE56'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
    
                // Top Locations by Payment Activity Chart
                if (data.payments_by_location && data.payments_by_location.length > 0) {
                    const locationLabels = data.payments_by_location.map(loc => loc.location);
                    const locationTotals = data.payments_by_location.map(loc => loc.total_payment);
    
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    container.innerHTML = `
                        <h3>Top Locations by Payment Amount</h3>
                        <canvas id="locationChart"></canvas>
                    `;
                    document.querySelector('main').appendChild(container);
    
                    new Chart(document.getElementById('locationChart'), {
                        type: 'bar',
                        data: {
                            labels: locationLabels,
                            datasets: [{
                                label: 'Total Payments (GHC)',
                                data: locationTotals,
                                backgroundColor: '#8e44ad'
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
    
                // Most Occurring Locations Pie Chart
                if (data.most_occurring_locations && data.most_occurring_locations.length > 0) {
                    const locationNames = data.most_occurring_locations.map(loc => loc.location);
                    const locationCounts = data.most_occurring_locations.map(loc => loc.count);
    
                    const container = document.createElement('div');
                    container.className = 'chart-container';
                    container.innerHTML = `
                        <h3>Most Occurring Locations</h3>
                        <canvas id="locationPieChart"></canvas>
                    `;
                    document.querySelector('main').appendChild(container);
    
                    new Chart(document.getElementById('locationPieChart'), {
                        type: 'pie',
                        data: {
                            labels: locationNames,
                            datasets: [{
                                data: locationCounts,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#8e44ad'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Failed to load analysis data:', error);
                alert('Error loading data. Please check your backend.');
                document.querySelector('.loader').style.display = 'none';
            });
    </script>
    
    <script>
        window.cbConfig = {
          chatId: "acac0de2-5c91-4eae-9354-1376e3093d91"
        };
      </script>
      <script src="https://app.chatbit.co/embed.min.js" defer></script>
      {% include 'app_footer.html' %}

</body>
</html>

<!doctype html>
<html lang="en" data-color-scheme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Orders Inbox</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    html, body { background:#fff !important; }
    :root{
      --ring:#e9eef7;
      --muted:#64748b;
      --ink:#0f172a;
      --primary:#0d6efd;
      --shadow: 0 10px 26px rgba(2,6,23,.08);
    }
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--ink); }
    .container-xxl{ max-width: 1200px; }

    .topbar{
      position: sticky; top:0; z-index:50;
      background: rgba(255,255,255,.96);
      border-bottom: 1px solid var(--ring);
      backdrop-filter: blur(8px);
    }
    .brand{ font-weight: 900; letter-spacing:.2px; }
    .card-soft{
      border: 1px solid var(--ring);
      border-radius: 14px;
      box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:.4rem;
      border-radius:999px; padding:.2rem .6rem;
      background:#f1f5ff; border:1px solid #dbe7ff;
      font-size:.82rem; color:#0b3b52;
      white-space: nowrap;
    }
    .small-muted{ color:var(--muted); font-size:.9rem; }

    /* Drawer */
    .drawer{
      position: fixed; top:0; right:-460px;
      width: 460px; max-width: 100%;
      height: 100dvh; background:#fff;
      border-left: 1px solid var(--ring);
      z-index: 90;
      box-shadow: -10px 0 28px rgba(2,6,23,.10);
      transition: right .25s ease;
    }
    .drawer.open{ right:0; }
    .drawer-header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--ring);
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
    }
    .drawer-body{
      padding: 14px;
      overflow:auto;
      height: calc(100dvh - 58px);
    }
    .btn{ border-radius: 12px; }
    .form-control, .form-select{ border-radius: 12px; }
    .item-thumb{
      width: 38px;
      height: 38px;
      border-radius: 10px;
      object-fit: cover;
      background: #f1f5f9;
      border: 1px solid var(--ring);
      flex: 0 0 auto;
    }

    @media (max-width: 576px){
      .actions-wrap{ flex-direction: column; align-items: stretch !important; }
      .actions-wrap .btn{ width: 100%; }
    }
  </style>
</head>

<body>
    {% include 'inventory_sidebar.html' %}

  <div class="topbar py-2">
    <div class="container-xxl d-flex align-items-center justify-content-between gap-2">
      <div class="brand h5 mb-0">Orders Inbox</div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="openHistory">
          <i class="bi bi-clock-history"></i> History
        </button>
        <button class="btn btn-outline-danger btn-sm d-none" id="bulkDeliverBtn">
          <i class="bi bi-check2-all"></i> Deliver ALL orders
        </button>
        <button class="btn btn-outline-secondary btn-sm" id="exportPdfUndelivered">
          <i class="bi bi-file-earmark-pdf"></i> Undelivered PDF
        </button>
        <button class="btn btn-primary btn-sm" id="refresh">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <div class="container-xxl py-3">

    <div id="alertWrap" class="mb-3" style="display:none">
      <div id="alertBox" class="alert mb-0"></div>
    </div>

    <div id="inboxHeader" class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
      <div>
        <div class="h5 mb-1">Incoming Orders</div>
        <div class="small-muted">Undelivered and Delivered sections. Orders are grouped -- open "View Items" to deliver/postpone.</div>
      </div>

      <div class="d-flex gap-2" style="min-width: 280px;">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input id="q" class="form-control" placeholder="Search order / branch / item"/>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="tabs">
      <li class="nav-item">
        <button class="nav-link active" data-state="undelivered" type="button">
          Undelivered <span class="ms-1 pill" id="countUndelivered">0</span>
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-state="delivered" type="button">
          Delivered <span class="ms-1 pill" id="countDelivered">0</span>
        </button>
      </li>
    </ul>

    <!-- List -->
    <div id="inboxCard" class="card-soft">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="small-muted" id="listHint">Showing undelivered orders.</div>
          <div class="pill"><i class="bi bi-inboxes"></i> <span id="listCount">0</span></div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr class="small text-muted">
                <th style="width:52px;">#</th>
                <th>Order</th>
                <th>Branch</th>
                <th>Manager</th>
                <th class="text-end">Items</th>
                <th class="text-end">Remaining</th>
                <th>Status</th>
                <th style="min-width:170px;" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>

        <div id="empty" class="text-center py-5" style="display:none">
          <i class="bi bi-inboxes fs-2"></i>
          <div class="mt-2 fw-semibold">No orders</div>
          <div class="small-muted">Try another search or switch tab.</div>
        </div>
      </div>
    </div>

    <!-- History -->
    <div id="historyWrap" class="d-none">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
        <div>
          <div class="h5 mb-1">Orders History</div>
          <div class="small-muted">Closed orders only.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="backToInbox">
            <i class="bi bi-arrow-left"></i> Inbox
          </button>
        </div>
      </div>

      <div class="card-soft">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="small-muted" id="historyHint">Showing recent history.</div>
            <div class="pill"><i class="bi bi-clock-history"></i> <span id="historyCount">0</span></div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr class="small text-muted">
                  <th style="width:52px;">#</th>
                  <th>Order</th>
                  <th>Branch</th>
                  <th>Manager</th>
                  <th class="text-end">Items</th>
                  <th>Closed At</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="historyList"></tbody>
            </table>
          </div>
          <div id="historyEmpty" class="text-center py-5 d-none">
            <i class="bi bi-clock-history fs-2"></i>
            <div class="mt-2 fw-semibold">No history yet</div>
          </div>
          <div class="d-flex align-items-center justify-content-between mt-3">
            <button class="btn btn-outline-secondary btn-sm" id="historyPrev">Prev</button>
            <div class="small-muted">Page <span id="historyPage">1</span> / <span id="historyPages">1</span></div>
            <button class="btn btn-outline-secondary btn-sm" id="historyNext">Next</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div>
        <div class="fw-bold" id="dwTitle">Order</div>
        <div class="small-muted" id="dwMeta">--</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="dwClose"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="drawer-body">
      <div class="d-flex gap-2 mb-3 actions-wrap align-items-center justify-content-between">
        <button class="btn btn-success" id="deliverAllBtn">
          <i class="bi bi-check2-all"></i> Deliver ALL remaining
        </button>
        <button class="btn btn-outline-secondary" id="reloadDetailBtn">
          <i class="bi bi-arrow-clockwise"></i> Reload
        </button>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="forceDeliverToggle">
        <label class="form-check-label" for="forceDeliverToggle">
          Force deliver if stock is insufficient
        </label>
      </div>

      <div id="dwBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);

    let STATE = "undelivered";
    let LAST = { undelivered: [], delivered: [] };
    let CURRENT_ORDER_ID = null;
    let MODE = "inbox";
    let HISTORY_PAGE = 1;
    let HISTORY_PAGES = 1;
    const HISTORY_PAGE_SIZE = 20;
    const forceToggle = $('forceDeliverToggle');

    function showAlert(msg, type='danger'){
      $('alertBox').className = `alert alert-${type}`;
      $('alertBox').textContent = msg;
      $('alertWrap').style.display = '';
      setTimeout(()=> $('alertWrap').style.display='none', 4500);
    }

    async function readResponseMessage(res, fallback){
      const text = await res.text();
      if (!text) return fallback;
      try{
        const parsed = JSON.parse(text);
        if (parsed && typeof parsed === 'object'){
          return parsed.message || fallback;
        }
      }catch(e){ /* ignore parse */ }
      return text;
    }

    async function parseResponse(res, fallback){
      const text = await res.text();
      if (!text) return { ok: res.ok, message: fallback };
      try{
        const parsed = JSON.parse(text);
        if (parsed && typeof parsed === 'object'){
          return {
            ok: typeof parsed.ok === 'boolean' ? parsed.ok : res.ok,
            message: parsed.message || fallback
          };
        }
      }catch(e){ /* ignore parse */ }
      return { ok: res.ok, message: text || fallback };
    }

    function forceEnabled(){
      return !!forceToggle?.checked;
    }

    function esc(s){
      return String(s||'').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function setTabActive(){
      document.querySelectorAll('#tabs .nav-link').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.state === STATE);
      });
      $('listHint').textContent = STATE === 'undelivered'
        ? "Showing undelivered orders."
        : "Showing delivered orders.";
      $('bulkDeliverBtn').classList.toggle('d-none', STATE !== 'undelivered');
    }

    async function loadCounts(){
      try{
        const r = await fetch(`/inventory/orders/counts`);
        const j = await r.json();
        if(!j.ok) return;
        $('countUndelivered').textContent = j.undelivered || 0;
        $('countDelivered').textContent = j.delivered || 0;
      }catch(e){}
    }

    function renderList(rows){
      const tb = $('list');
      tb.innerHTML = '';
      $('empty').style.display = rows.length ? 'none' : '';
      $('listCount').textContent = rows.length;

      let idx = 1;
      rows.forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-muted">${idx++}</td>
          <td class="text-nowrap">
            <code>${esc(o._id)}</code>
            <div class="small text-muted">${esc(o.updated_at || '')}</div>
            <div class="small text-muted">Submitted: ${esc(o.created_at || '')}</div>
          </td>
          <td><span class="pill"><i class="bi bi-shop"></i> ${esc(o.branch||'-')}</span></td>
          <td>${esc(o.manager_name || '-')}</td>
          <td class="text-end">${o.items_count || 0}</td>
          <td class="text-end fw-semibold">${o.remaining_total || 0}</td>
          <td>
            <span class="badge ${o.status==='closed' ? 'text-bg-success' : o.status==='partially_delivered' ? 'text-bg-warning' : 'text-bg-secondary'}">
              ${esc(o.status || 'open')}
            </span>
          </td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm view" data-id="${esc(o._id)}">
              <i class="bi bi-eye"></i> View Items
            </button>
          </td>
        `;
        tr.querySelector('.view').addEventListener('click', ()=> openOrder(o._id));
        tb.appendChild(tr);
      });
    }

    function setMode(mode){
      MODE = mode;
      const inboxOn = MODE === 'inbox';
      $('inboxHeader').classList.toggle('d-none', !inboxOn);
      $('tabs').classList.toggle('d-none', !inboxOn);
      $('inboxCard').classList.toggle('d-none', !inboxOn);
      $('historyWrap').classList.toggle('d-none', inboxOn);
      $('openHistory').classList.toggle('d-none', !inboxOn);
      $('exportPdfUndelivered').classList.toggle('d-none', !inboxOn);
      $('bulkDeliverBtn').classList.toggle('d-none', !inboxOn || STATE !== 'undelivered');
      if (inboxOn){
        closeDrawer();
      }
    }

    async function loadList(){
      const q = ($('q').value||'').trim();
      const r = await fetch(`/inventory/orders/orders?state=${encodeURIComponent(STATE)}&q=${encodeURIComponent(q)}`);
      const j = await r.json();
      if(!j.ok){
        showAlert(j.message || 'Failed to load orders');
        return;
      }
      LAST[STATE] = j.results || [];
      renderList(LAST[STATE]);
      await loadCounts();
    }

    async function loadHistory(){
      const r = await fetch(`/inventory/orders/history?page=${HISTORY_PAGE}&page_size=${HISTORY_PAGE_SIZE}`);
      const j = await r.json();
      if(!j.ok){
        showAlert(j.message || 'Failed to load history');
        return;
      }
      HISTORY_PAGES = j.pages || 1;
      $('historyPage').textContent = HISTORY_PAGE;
      $('historyPages').textContent = HISTORY_PAGES;
      $('historyCount').textContent = (j.results || []).length;
      const tb = $('historyList');
      tb.innerHTML = '';
      $('historyEmpty').classList.toggle('d-none', (j.results || []).length > 0);
      let idx = 1 + (HISTORY_PAGE - 1) * HISTORY_PAGE_SIZE;
      (j.results || []).forEach(o=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-muted">${idx++}</td>
          <td class="text-nowrap">
            <code>${esc(o._id)}</code>
          </td>
          <td><span class="pill"><i class="bi bi-shop"></i> ${esc(o.branch||'-')}</span></td>
          <td>${esc(o.manager_name || '-')}</td>
          <td class="text-end">${(o.items || []).length}</td>
          <td>${esc(o.closed_at || '')}</td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm view" data-id="${esc(o._id)}">
              <i class="bi bi-eye"></i> View Items
            </button>
          </td>
        `;
        tr.querySelector('.view').addEventListener('click', ()=> openOrder(o._id));
        tb.appendChild(tr);
      });
      $('historyPrev').disabled = HISTORY_PAGE <= 1;
      $('historyNext').disabled = HISTORY_PAGE >= HISTORY_PAGES;
    }

    function openDrawer(){
      $('drawer').classList.add('open');
      $('drawer').setAttribute('aria-hidden','false');
    }
    function closeDrawer(){
      $('drawer').classList.remove('open');
      $('drawer').setAttribute('aria-hidden','true');
      CURRENT_ORDER_ID = null;
      $('dwBody').innerHTML = '';
    }
    $('dwClose').addEventListener('click', closeDrawer);

    async function openOrder(orderId){
      CURRENT_ORDER_ID = orderId;
      openDrawer();
      await loadOrderDetail(orderId);
    }

    async function loadOrderDetail(orderId){
      $('dwBody').innerHTML = `<div class="text-muted">Loading...</div>`;
      try{
        const r = await fetch(`/inventory/orders/detail?order_id=${encodeURIComponent(orderId)}`);
        const j = await r.json();
        if(!j.ok) throw new Error(j.message || 'Failed to load order');
        const o = j.order;

        $('dwTitle').textContent = `Order ${o._id}`;
        const created = o.created_at ? `Submitted: ${o.created_at}` : 'Submitted: -';
        $('dwMeta').textContent = `${o.branch || '-'} -  ${o.manager_name || '-'} -  Status: ${o.status || '-'} -  ${created}`;

        const items = o.items || [];
        const html = `
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr class="small text-muted">
                  <th>Item</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Delivered</th>
                  <th class="text-end">Remaining</th>
                  <th style="min-width:220px;" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(it=>{
                  const remaining = it.remaining_qty || 0;
                  const disabled = remaining <= 0 ? 'disabled' : '';
                  const manualBadge = it.is_manual ? `<span class="badge text-bg-secondary ms-2">Manual</span>` : '';
                  return `
                    <tr>
                      <td>
                        <div class="d-flex gap-2 align-items-center">
                          ${it.image_url ? `<img class="item-thumb" src="${esc(it.image_url)}" alt="">` : `<div class="item-thumb"></div>`}
                          <div>
                            <div class="fw-semibold">${esc(it.name || '-')}${manualBadge}</div>
                            <div class="small text-muted">${esc(it.sku || '')}</div>
                            ${it.expected_date ? `<div class="small text-muted">Expected: ${esc(it.expected_date)}</div>` : ``}
                          </div>
                        </div>
                      </td>
                      <td class="text-end">${it.qty || 0}</td>
                      <td class="text-end">${it.delivered_qty || 0}</td>
                      <td class="text-end fw-semibold">${remaining}</td>
                      <td class="text-end">
                        <div class="d-flex flex-column gap-2 align-items-end">
                          <div class="input-group input-group-sm" style="max-width:220px;">
                            <input class="form-control deliverQty" type="number" min="1" max="${remaining}" value="${remaining}" ${disabled}
                              data-line="${esc(it.line_id)}">
                            <button class="btn btn-success deliverBtn" ${disabled} data-line="${esc(it.line_id)}">Deliver</button>
                          </div>
                          <div class="input-group input-group-sm" style="max-width:220px;">
                            <input class="form-control postponeDate" type="date" ${disabled} data-line="${esc(it.line_id)}">
                            <button class="btn btn-warning postponeBtn" ${disabled} data-line="${esc(it.line_id)}">Postpone</button>
                          </div>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        $('dwBody').innerHTML = html;

        // Bind deliver/postpone buttons
        function findDeliverInput(lineId){
          let direct = null;
          try{
            const escId = (CSS && CSS.escape) ? CSS.escape(lineId) : lineId.replace(/"/g, '\\"');
            direct = $('dwBody').querySelector(`.deliverQty[data-line="${escId}"]`);
          }catch(e){
            direct = null;
          }
          if (direct) return direct;
          return Array.from($('dwBody').querySelectorAll('.deliverQty'))
            .find(el => el.dataset.line === lineId);
        }

        $('dwBody').querySelectorAll('.deliverBtn').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const lineId = btn.dataset.line;
            const qtyInput = findDeliverInput(lineId);
            if (!qtyInput) return showAlert('Delivery input not found.');
            const qty = parseInt(qtyInput.value || '0', 10);
            if(!qty || qty <= 0) return showAlert('Enter qty to deliver');

            try{
              const force = forceEnabled();
              const rr = await fetch('/inventory/orders/line/deliver', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ order_id: CURRENT_ORDER_ID, line_id: lineId, qty, force })
              });
              const jj = await parseResponse(rr, rr.ok ? 'Delivered.' : `Deliver failed (${rr.status || 0})`);
              if(!rr.ok || !jj.ok){
                if (rr.status === 409 && !force){
                  return showAlert('Insufficient warehouse stock -- enable Force Deliver to bypass.', 'warning');
                }
                return showAlert(jj.message || 'Deliver failed');
              }

              showAlert('Delivered.', 'success');
              await loadOrderDetail(CURRENT_ORDER_ID);
              if (MODE === 'inbox') await loadList();
            }catch(err){
              showAlert(err.message || 'Deliver failed');
            }
          });
        });

        $('dwBody').querySelectorAll('.postponeBtn').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const lineId = btn.dataset.line;
            let dateInput = null;
            try{
              const escId = (CSS && CSS.escape) ? CSS.escape(lineId) : lineId.replace(/"/g, '\\"');
              dateInput = $('dwBody').querySelector(`.postponeDate[data-line="${escId}"]`);
            }catch(e){
              dateInput = null;
            }
            if (!dateInput){
              dateInput = Array.from($('dwBody').querySelectorAll('.postponeDate'))
                .find(el => el.dataset.line === lineId);
            }
            const to_date = dateInput.value;
            if(!to_date) return showAlert('Pick a new expected date');

            const rr = await fetch('/inventory/orders/line/postpone', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ order_id: CURRENT_ORDER_ID, line_id: lineId, to_date, reason: "Rescheduled from inbox" })
            });
            const jj = await parseResponse(rr, rr.ok ? 'Postponed.' : `Postpone failed (${rr.status || 0})`);
            if(!rr.ok || !jj.ok) return showAlert(jj.message || 'Postpone failed');

            showAlert('Postponed.', 'success');
            await loadOrderDetail(CURRENT_ORDER_ID);
            if (MODE === 'inbox') await loadList();
          });
        });

      }catch(err){
        $('dwBody').innerHTML = `<div class="alert alert-danger">${esc(err.message || 'Failed')}</div>`;
      }
    }

    $('reloadDetailBtn').addEventListener('click', ()=>{
      if(CURRENT_ORDER_ID) loadOrderDetail(CURRENT_ORDER_ID);
    });

    $('deliverAllBtn').addEventListener('click', async ()=>{
      if(!CURRENT_ORDER_ID) return;
      try{
        const force = forceEnabled();
        const rr = await fetch('/inventory/orders/order/deliver_all', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ order_id: CURRENT_ORDER_ID, force })
        });
        const jj = await parseResponse(rr, rr.ok ? 'Delivered.' : `Deliver all failed (${rr.status || 0})`);
        if(!rr.ok || !jj.ok){
          if (rr.status === 409 && !force){
            return showAlert('Insufficient warehouse stock -- enable Force Deliver to bypass.', 'warning');
          }
          return showAlert(jj.message || 'Deliver all failed');
        }
        showAlert('All remaining items delivered.', 'success');
        await loadOrderDetail(CURRENT_ORDER_ID);
        if (MODE === 'inbox') await loadList();
      }catch(err){
        showAlert(err.message || 'Deliver all failed');
      }
    });

    $('bulkDeliverBtn').addEventListener('click', async ()=>{
      if(STATE !== 'undelivered') return;
      const list = LAST.undelivered || [];
      if(!list.length) return showAlert('No undelivered orders to deliver.', 'warning');
      const ok = confirm(`Deliver ALL remaining items for ${list.length} orders?`);
      if(!ok) return;

      let delivered = 0;
      let failed = 0;
      let lastError = '';
      let idx = 0;
      for (const o of list){
        idx += 1;
        $('listHint').textContent = `Delivering ${idx}/${list.length}...`;
        try{
          const force = forceEnabled();
          const rr = await fetch('/inventory/orders/order/deliver_all', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ order_id: o._id, force })
          });
          const jj = await parseResponse(rr, rr.ok ? 'Delivered.' : `Deliver all failed (${rr.status || 0})`);
          if(!rr.ok || !jj.ok){
            if (rr.status === 409 && !force){
              failed += 1;
              lastError = 'Insufficient warehouse stock -- enable Force Deliver to bypass.';
              continue;
            }
            failed += 1;
            lastError = jj.message || `Deliver failed (${rr.status || 0})`;
          }else{
            delivered += 1;
          }
        }catch(err){
          failed += 1;
          lastError = err.message || 'Deliver failed';
        }
      }
      showAlert(`Bulk deliver complete. Delivered: ${delivered}, Failed: ${failed}${lastError ? ` -- ${lastError}` : ''}`, failed ? 'warning' : 'success');
      $('listHint').textContent = STATE === 'undelivered'
        ? "Showing undelivered orders."
        : "Showing delivered orders.";
      await loadCounts();
      await loadList();
    });

    $('openHistory').addEventListener('click', async ()=>{
      setMode('history');
      await loadHistory();
    });
    $('backToInbox').addEventListener('click', async ()=>{
      setMode('inbox');
      setTabActive();
      await loadList();
    });

    $('historyPrev').addEventListener('click', async ()=>{
      if (HISTORY_PAGE <= 1) return;
      HISTORY_PAGE -= 1;
      await loadHistory();
    });
    $('historyNext').addEventListener('click', async ()=>{
      if (HISTORY_PAGE >= HISTORY_PAGES) return;
      HISTORY_PAGE += 1;
      await loadHistory();
    });

    // Tabs
    document.querySelectorAll('#tabs .nav-link').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        STATE = btn.dataset.state;
        setTabActive();
        loadList();
      });
    });

    // Search debounce
    let t = null;
    $('q').addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(()=> loadList(), 300);
    });

    $('refresh').addEventListener('click', ()=> loadList());

    $('exportPdfUndelivered').addEventListener('click', ()=>{
      // ALWAYS undelivered PDF, grouped by branch on the server
      const q = ($('q').value||'').trim();
      const url = `/inventory/orders/export/undelivered.pdf?q=${encodeURIComponent(q)}`;
      window.open(url, "_blank");
    });

    // Init
    (async function init(){
      setMode('inbox');
      setTabActive();
      await loadCounts();
      await loadList();
    })();
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

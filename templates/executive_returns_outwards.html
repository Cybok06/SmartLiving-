<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Executive Returns Outwards</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png">
</head>
<body class="bg-slate-50 text-slate-900">
  {% include 'executive_sidebar.html' %}

  <main class="min-h-screen p-5 lg:p-8 acc-with-sidebar space-y-6">
    <header class="flex flex-col gap-2">
      <h1 class="text-3xl font-extrabold">Returns Outwards</h1>
      <p class="text-sm text-slate-600">Goods issued out (warranty/replacement) tracking.</p>
    </header>

    <section class="rounded-xl bg-white border border-slate-200 p-4 space-y-4">
      <div class="grid gap-3 md:grid-cols-2">
        <div>
          <label class="text-xs text-slate-500">Start</label>
          <input id="filterStart" type="date" value="{{ start }}" class="w-full rounded-lg border-slate-200">
        </div>
        <div>
          <label class="text-xs text-slate-500">End</label>
          <input id="filterEnd" type="date" value="{{ end }}" class="w-full rounded-lg border-slate-200">
        </div>
        <div>
          <label class="text-xs text-slate-500">Company</label>
          <input id="filterCompany" type="text" value="{{ company }}" class="w-full rounded-lg border-slate-200" placeholder="Company name">
        </div>
        <div>
          <label class="text-xs text-slate-500">Status</label>
          <select id="filterStatus" class="w-full rounded-lg border-slate-200">
            {% for option in ['posted', 'draft', 'all'] %}
            <option value="{{ option }}" {% if status == option %}selected{% endif %}>{{ option.title() }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="applyFilters" class="rounded-lg bg-slate-900 text-white px-4 py-2 text-sm font-semibold">Filter</button>
        <button id="exportCsv" class="rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">Export CSV</button>
      </div>
    </section>

    <section class="rounded-xl bg-white border border-slate-200 p-4 space-y-3">
      <h2 class="text-lg font-semibold">New Return Outwards</h2>
      <form id="returnsForm" class="space-y-3">
        <div class="grid gap-3 md:grid-cols-3">
          <div>
            <label class="text-xs text-slate-500">Date</label>
            <input type="date" name="date" value="{{ today }}" class="w-full rounded-lg border-slate-200" required>
          </div>
          <div>
            <label class="text-xs text-slate-500">Company name</label>
            <input type="text" name="company_name" class="w-full rounded-lg border-slate-200" required>
          </div>
          <div>
            <label class="text-xs text-slate-500">Reason</label>
            <select name="reason" class="w-full rounded-lg border-slate-200">
              <option value="Warranty">Warranty</option>
              <option value="Replacement">Replacement</option>
              <option value="Goodwill">Goodwill</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Status</label>
          <select name="status" class="w-full rounded-lg border-slate-200">
            <option value="posted">Posted</option>
            <option value="draft">Draft</option>
          </select>
        </div>
        <div class="space-y-2">
          <div class="grid gap-2 md:grid-cols-5">
            <div>
              <label class="text-xs text-slate-500">Product</label>
              <input id="productInput" list="prodList" class="w-full rounded-lg border-slate-200" placeholder="Search product">
              <datalist id="prodList">
                {% for prod in products %}
                  <option data-price="{{ prod.cost_price }}" value="{{ prod._id }}|{{ prod.name }}">{{ prod.name }}</option>
                {% endfor %}
              </datalist>
            </div>
            <div>
              <label class="text-xs text-slate-500">Qty</label>
              <input id="itemQty" type="number" min="0.01" step="0.01" class="w-full rounded-lg border-slate-200">
            </div>
            <div>
              <label class="text-xs text-slate-500">Unit Cost</label>
              <input id="itemCost" type="number" min="0" step="0.01" class="w-full rounded-lg border-slate-200">
            </div>
            <div>
              <label class="text-xs text-slate-500">&nbsp;</label>
              <button type="button" id="addItemBtn" class="w-full rounded-lg bg-slate-900 text-white px-3 py-2 text-sm font-semibold">Add Item</button>
            </div>
          </div>
          <div class="overflow-auto border rounded-lg border-slate-200">
            <table class="w-full text-sm">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-2 py-1 text-left">Product</th>
                  <th class="px-2 py-1 text-right">Qty</th>
                  <th class="px-2 py-1 text-right">Unit Cost</th>
                  <th class="px-2 py-1 text-right">Line Total</th>
                </tr>
              </thead>
              <tbody id="itemsTable" class="text-slate-700">
                <tr><td colspan="4" class="text-center text-xs text-slate-400 py-4">Add items above</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <input type="hidden" name="items" id="itemsField">
        <button type="submit" class="rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-semibold">Save Returns Outwards</button>
      </form>
    </section>

    <section class="rounded-xl bg-white border border-slate-200 p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Recent Returns</h2>
        <span class="text-xs text-slate-500">Showing last 30 days</span>
      </div>
      <div class="mt-3 overflow-auto">
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-2 py-2">Date</th>
              <th class="px-2 py-2">Company</th>
              <th class="px-2 py-2">Reason</th>
              <th class="px-2 py-2">Items</th>
              <th class="px-2 py-2">Total</th>
              <th class="px-2 py-2">Status</th>
              <th class="px-2 py-2">Created by</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr class="border-b border-slate-100">
              <td class="px-2 py-2">{{ row.date }}</td>
              <td class="px-2 py-2">{{ row.company_name }}</td>
              <td class="px-2 py-2">{{ row.reason }}</td>
              <td class="px-2 py-2">{{ row.items_count }}</td>
              <td class="px-2 py-2">GHS {{ row.total_cost|round(2) }}</td>
              <td class="px-2 py-2">{{ row.status }}</td>
              <td class="px-2 py-2">{{ row.created_by }}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-xs text-slate-400 py-4">No returns recorded yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const items = [];
    function refreshItems() {
      const tbody = document.getElementById("itemsTable");
      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-xs text-slate-400 py-4">Add items above</td></tr>';
      } else {
        tbody.innerHTML = items.map(item => `
          <tr>
            <td class="px-2 py-1">${item.product_name}</td>
            <td class="px-2 py-1 text-right">${item.qty}</td>
            <td class="px-2 py-1 text-right">GHS ${item.unit_cost.toFixed(2)}</td>
            <td class="px-2 py-1 text-right">GHS ${(item.qty * item.unit_cost).toFixed(2)}</td>
          </tr>
        `).join("");
      }
      document.getElementById("itemsField").value = JSON.stringify(items);
    }

    document.getElementById("addItemBtn").addEventListener("click", () => {
      const prod = document.getElementById("productInput").value.trim();
      const qty = parseFloat(document.getElementById("itemQty").value);
      const cost = parseFloat(document.getElementById("itemCost").value);
      if (!prod || isNaN(qty) || qty <= 0 || isNaN(cost)) {
        return alert("Provide product, qty, and unit cost.");
      }
      const [prodId, prodName] = prod.split("|");
      items.push({
        product_id: prodId,
        product_name: prodName || prodId,
        qty,
        unit_cost: cost,
      });
      document.getElementById("productInput").value = "";
      document.getElementById("itemQty").value = "";
      document.getElementById("itemCost").value = "";
      refreshItems();
    });

    document.getElementById("returnsForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!items.length) {
        return alert("Add at least one item.");
      }
      const formData = new FormData(event.target);
      const payload = {
        company_name: formData.get("company_name"),
        reason: formData.get("reason"),
        status: formData.get("status"),
        date: formData.get("date"),
        items: items,
      };
      const res = await fetch("{{ url_for('executive_returns_outwards.add') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (data.ok) {
        location.reload();
      } else {
        alert(data.message || "Failed to save.");
      }
    });

    document.getElementById("exportCsv").addEventListener("click", () => {
      const start = document.getElementById("filterStart").value;
      const end = document.getElementById("filterEnd").value;
      const company = document.getElementById("filterCompany").value;
      const status = document.getElementById("filterStatus").value;
      const params = new URLSearchParams({start, end, company_name: company, status, export: "1"});
      window.location = "{{ url_for('executive_returns_outwards.page') }}?" + params.toString();
    });

    document.getElementById("applyFilters").addEventListener("click", () => {
      const start = document.getElementById("filterStart").value;
      const end = document.getElementById("filterEnd").value;
      const company = document.getElementById("filterCompany").value;
      const status = document.getElementById("filterStatus").value;
      const params = new URLSearchParams({start, end, company_name: company, status});
      window.location = "{{ url_for('executive_returns_outwards.page') }}?" + params.toString();
    });
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

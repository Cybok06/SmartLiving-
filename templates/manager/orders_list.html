<!-- orders_list.html (create order is NOW a separate page; no inline create panel here) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>My Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .badge-status { text-transform: capitalize; }
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  </style>
</head>
<body class="bg-light">
  {% include 'manager_sidebar.html' %}

  <div class="container py-4">
    <div id="statusWrap" class="mb-3" style="display:none">
      <div id="statusAlert" class="alert" role="alert"></div>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h4 mb-0">My Orders</h1>
      <div class="d-flex gap-2">
        <a href="/manager/orders/create" class="btn btn-primary">+ New Order</a>
        <button id="refresh" class="btn btn-outline-secondary">Refresh</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row gy-2 align-items-end">
          <div class="col-12 col-md-2">
            <label class="form-label mb-1">Status</label>
            <select id="status" class="form-select">
              <option value="">All</option>
              <option value="open">Open</option>
              <option value="partially_delivered">Partially delivered</option>
              <option value="closed">Closed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Date from</label>
            <input id="dateFrom" type="date" class="form-control">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Date to</label>
            <input id="dateTo" type="date" class="form-control">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Sort</label>
            <select id="sort" class="form-select">
              <option value="desc">Newest → Oldest</option>
              <option value="asc">Oldest → Newest</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <button id="apply" class="btn btn-primary w-100">Apply</button>
          </div>
          <div class="col-12 col-md-2 d-flex align-items-center">
            <span class="text-muted small ms-md-3">Tip: click "View details" to see all lines.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- List -->
    <div id="list" class="vstack gap-3"></div>
  </div>

  <!-- Modal: order details -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="orderMeta" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width:36%">Item</th>
                  <th style="width:10%">Qty</th>
                  <th style="width:14%">Delivered</th>
                  <th style="width:16%">Status</th>
                  <th style="width:18%">Expected</th>
                  <th style="width:6%">Line</th>
                </tr>
              </thead>
              <tbody id="orderLines"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" data-bs-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let ORDERS = [];

function showStatus(msg, type='success'){
  const wrap = document.getElementById('statusWrap');
  const al = document.getElementById('statusAlert');
  al.className = `alert alert-${type}`;
  al.textContent = msg;
  wrap.style.display = '';
  setTimeout(()=>{ wrap.style.display='none'; }, 4000);
}

function esc(s){
  return String(s||'').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function badge(status) {
  const map = { open:'bg-secondary', partially_delivered:'bg-warning', closed:'bg-success', cancelled:'bg-dark' };
  const cls = map[status] || 'bg-secondary';
  return `<span class="badge ${cls} badge-status">${esc(status || 'open')}</span>`;
}
function lineBadge(status) {
  const map = { pending:'bg-secondary', postponed:'bg-warning', delivered:'bg-success' };
  const cls = map[status] || 'bg-secondary';
  return `<span class="badge ${cls}">${esc(status||'pending')}</span>`;
}

function queryParams(){
  const p = new URLSearchParams();
  const status = document.getElementById('status').value;
  const df = document.getElementById('dateFrom').value;
  const dt = document.getElementById('dateTo').value;
  const so = document.getElementById('sort').value;
  if (status) p.set('status', status);
  if (df) p.set('date_from', df);
  if (dt) p.set('date_to', dt);
  p.set('sort', so || 'desc');
  return p.toString();
}

async function load() {
  try{
    const r = await fetch(`/manager/orders/list?` + queryParams());
    const j = await r.json();
    if (!j.ok) { showStatus(j.message || 'Failed to load orders', 'danger'); return; }
    ORDERS = j.results || [];
    renderList();
  }catch(e){
    showStatus('Failed to load orders', 'danger');
  }
}

function renderList() {
  const root = document.getElementById('list');
  root.innerHTML = '';
  if (!ORDERS.length) {
    root.innerHTML = `<div class="text-center text-muted py-5">No orders yet. Click <strong>+ New Order</strong> to create one.</div>`;
    return;
  }
  ORDERS.forEach(o=>{
    const items = o.items || [];
    const delivered = items.filter(i=>i.status==='delivered').length;
    const total = items.length;

    const el = document.createElement('div');
    el.className = 'card shadow-sm';
    el.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <div class="fw-semibold">Order</div>
            <code>${esc(o._id)}</code>
            ${badge(o.status)}
          </div>
          <div class="text-muted small">Updated: ${o.updated_at ? new Date(o.updated_at).toLocaleString() : ''}</div>
        </div>

        <div class="mt-2 small text-muted truncate">${esc(o.notes || '')}</div>

        <div class="mt-3 row g-3">
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 bg-light">
              <div class="text-muted small">Lines</div>
              <div class="fs-5">${total}</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="border rounded p-2 bg-light">
              <div class="text-muted small">Delivered lines</div>
              <div class="fs-5">${delivered}</div>
            </div>
          </div>
          <div class="col-12 col-md-6 text-end">
            <button class="btn btn-sm btn-outline-primary view">View details</button>
          </div>
        </div>
      </div>
    `;
    el.querySelector('.view').onclick = ()=> openModal(o);
    root.appendChild(el);
  });
}

function openModal(order) {
  const meta = document.getElementById('orderMeta');
  const lines = document.getElementById('orderLines');

  meta.innerHTML = `
    <div class="row g-2">
      <div class="col-md-4"><strong>Order ID:</strong> <code>${esc(order._id)}</code></div>
      <div class="col-md-4"><strong>Status:</strong> ${badge(order.status)}</div>
      <div class="col-md-4"><strong>Created:</strong> ${order.created_at ? new Date(order.created_at).toLocaleString() : ''}</div>
      <div class="col-12"><strong>Notes:</strong> ${esc(order.notes || '-')}</div>
    </div>
  `;

  lines.innerHTML = (order.items||[]).map(it=>`
    <tr>
      <td class="truncate" title="${esc(it.name||'')}">${esc(it.name||'')}</td>
      <td>${Number(it.qty||0)}</td>
      <td>${Number(it.delivered_qty||0)}</td>
      <td>${lineBadge(it.status)}</td>
      <td>${esc(it.expected_date||'')}</td>
      <td><code class="small">${esc(it.line_id||'')}</code></td>
    </tr>
  `).join('');

  const modal = new bootstrap.Modal(document.getElementById('orderModal'));
  modal.show();
}

document.getElementById('refresh').onclick = load;
document.getElementById('apply').onclick = load;
document.getElementById('status').onchange = load;

load();
</script>
  {% include 'app_footer.html' %}

</body>
</html>

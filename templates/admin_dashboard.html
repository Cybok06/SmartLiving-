<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin -  Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" />
  <style>
    :root{
      --ink:#0b3b52; --muted:#64748b; --ring:#e9eef5; --soft:#f6f8fb; --brand:#0ea5e9;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
    }
    body{ background:#f7fbfe; color:var(--ink); }
    .card{ border-radius:18px; box-shadow:0 8px 24px rgba(2,12,27,.06); border:1px solid var(--ring); }
    .hero{
      border-radius:22px; padding:24px; position:relative; overflow:hidden;
      background: radial-gradient(1200px 400px at -10% -40%, #dbeafe, transparent 60%),
                  linear-gradient(135deg, #eff6ff 0%, #fdf2f8 100%);
      border:1px solid var(--ring);
    }
    .hero h2{ margin:0; }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; background:#eef2ff; border:1px solid #e0e7ff; color:#1e3a8a; padding:.25rem .6rem; border-radius:999px; font-size:.8rem; font-weight:600; }
    .kpi{
      border-radius:16px; padding:16px; background:#fff; border:1px solid var(--ring);
    }
    .kpi .label{ color:var(--muted); font-size:.9rem; }
    .kpi .value{ font-size:1.6rem; font-weight:800; }
    .kpi.bad .value{ color:var(--bad); }
    .kpi.warn .value{ color:var(--warn); }
    .kpi.ok .value{ color:var(--ok); }
    .status-badge{ font-weight:600; }
    .status-Assigned{ background:#fff7ed; color:#b45309; }
    .status-In\ Progress{ background:#ecfeff; color:#0369a1; }
    .status-Waiting\ for\ Customer{ background:#fef9c3; color:#854d0e; }
    .status-Resolved{ background:#dcfce7; color:#166534; }
    .status-Closed{ background:#e5e7eb; color:#374151; }
    .table thead th{ background:#eef2ff; }
    .search-card{ border-style:dashed; }
    .avatar{
      width:56px; height:56px; border-radius:50%; object-fit:cover; border:3px solid #fff; box-shadow:0 6px 18px rgba(2,12,27,.10);
    }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <div class="container py-4" style="max-width: 1200px;">

    <!-- HERO -->
    <div class="hero mb-4">
      <div class="d-flex align-items-center gap-3">
        <img class="avatar"
             src="{{ (admin.image_url or 'https://ui-avatars.com/api/?name=' ~ (admin.name or 'Admin')|urlencode) }}"
             alt="Admin">
        <div>
          <h2>
            Welcome, {{ (admin.name or 'Admin').split(' ')[0] }}
          </h2>
          <div class="mt-1 d-flex flex-wrap gap-2">
            {% if admin.role %}<span class="chip"><i class="bi bi-shield-lock"></i>{{ admin.role|capitalize }}</span>{% endif %}
            {% if admin.branch %}<span class="chip"><i class="bi bi-shop"></i>{{ admin.branch }}</span>{% endif %}
            {% if admin.email %}<span class="chip"><i class="bi bi-envelope"></i>{{ admin.email }}</span>{% endif %}
          </div>
        </div>
        <div class="ms-auto d-none d-md-block">
          <a href="/complaints" class="btn btn-primary">Go to Complaints</a>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="kpi bad h-100">
          <div class="label">Open Complaints</div>
          <div class="value" id="kpiOpen">{{ stats.open }}</div>
          <small class="text-muted">Not Resolved / Closed</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi warn h-100">
          <div class="label">Breaching SLA</div>
          <div class="value" id="kpiBreach">{{ stats.breaching }}</div>
          <small class="text-muted">Past SLA due date</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi ok h-100">
          <div class="label">Resolved (30 days)</div>
          <div class="value">{{ stats.resolved_30 }}</div>
          <small class="text-muted">Last 30 days</small>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi h-100">
          <div class="label">Today</div>
          <div class="value">{{ stats.opened_today }} / {{ stats.closed_today }}</div>
          <small class="text-muted">Opened / Closed</small>
        </div>
      </div>
    </div>

    <!-- Search + Top Issues -->
    <div class="row g-3 mb-4">
      <div class="col-lg-7">
        <div class="card p-3 search-card">
          <form action="/complaints" method="get" class="d-flex gap-2">
            <input type="text" class="form-control" name="q" placeholder="Search complaints by ticket, name, phone, issueâ€¦" />
            <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i> Search</button>
          </form>
          <small class="text-muted ms-1">Tip: Try ticket number like <code>INC-20251108-003</code></small>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card p-3 h-100">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Top Issue Types</strong>
            <a class="small" href="/complaints">View all</a>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% if issue_tops and issue_tops|length>0 %}
              {% for t in issue_tops %}
                <span class="chip">{{ t.issue }} -  {{ t.count }}</span>
              {% endfor %}
            {% else %}
              <span class="text-muted">No data yet.</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Recent complaints -->
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="m-0">Recent Complaints</h5>
        <a href="/complaints" class="btn btn-sm btn-outline-primary">Open Complaints Hub</a>
      </div>
      <div class="table-responsive mt-2">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Ticket</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Phone</th>
              <th>Issue</th>
              <th>SLA Due</th>
              <th>Status</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for r in recent %}
            <tr>
              <td class="fw-semibold">{{ r.ticket_no }}</td>
              <td>{{ r.date_reported or '' }}</td>
              <td>{{ r.customer_name or '' }}</td>
              <td>{{ r.customer_phone or '' }}</td>
              <td>{{ r.issue_type or '' }}</td>
              <td>{{ r.sla_due or '' }}</td>
              <td><span class="badge status-badge status-{{ (r.status or '')|replace(' ','\\ ') }}">{{ r.status or '' }}</span></td>
              <td class="text-end">
                <a class="btn btn-sm btn-primary" href="/complaints?q={{ r.ticket_no|urlencode }}">View</a>
              </td>
            </tr>
            {% endfor %}
            {% if not recent or recent|length == 0 %}
            <tr><td colspan="8" class="text-center text-muted">No complaints yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="py-2"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Live-refresh KPIs using your existing /admin-complaints/unresolved_count JSON
    async function refreshComplaintKPIs(){
      try{
        const res = await fetch("/admin-complaints/unresolved_count", { credentials: "same-origin" });
        if(!res.ok) return;
        const d = await res.json();
        if(!d.ok) return;
        const openEl = document.getElementById("kpiOpen");
        const breachEl = document.getElementById("kpiBreach");
        if(openEl) openEl.textContent = Number(d.open || 0);
        if(breachEl) breachEl.textContent = Number(d.breaching || 0);
      }catch(e){}
    }
    document.addEventListener("DOMContentLoaded", ()=>{
      refreshComplaintKPIs();
      setInterval(refreshComplaintKPIs, 30000);
    });
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

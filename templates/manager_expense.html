<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manager Â· Expenses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg">

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#0d6efd; --primary-100:#e7f1ff;
      --card:#ffffff; --bg:#f7fafc;
    }
    body{ background: var(--bg); color: var(--ink); }
    .page-head{ background:#fff; border-bottom:1px solid var(--line); }
    .card{ background: var(--card); border:1px solid var(--line); box-shadow: 0 4px 14px rgba(2,6,23,.05); }
    .form-control, .form-select{ border-color:#dbe3ef; }
    .form-control:focus, .form-select:focus{ border-color: var(--primary); box-shadow: 0 0 0 .2rem rgba(13,110,253,.15); }
    .btn-primary{ background: var(--primary); border-color: var(--primary); }
    .badge-soft{ background: var(--primary-100); color: var(--primary); border:1px solid #cfe1ff; font-weight:600; }
    .badge-pending{ background:#fff7ed; color:#b45309; border:1px solid #fde68a; font-weight:600; }
    .badge-approved{ background:#ecfdf5; color:#047857; border:1px solid #a7f3d0; font-weight:600; }
    .table thead th{ color:#334155; font-weight:700; background:#f8fafc; border-bottom:1px solid var(--line); }
    .table tbody td{ border-top:1px solid var(--line) }
    .help-hint{ color:var(--muted) }

    /* Slide-in form panel */
    .drawer-overlay{
      position: fixed; inset: 0; background: rgba(15,23,42,.35); display:none; z-index: 1050;
    }
    .drawer-overlay.show{ display:block; }
    .drawer{
      position: fixed; right: -420px; top: 0; height: 100%; width: 420px; max-width: 90vw;
      background: #fff; border-left:1px solid var(--line); box-shadow: -8px 0 24px rgba(2,6,23,.12);
      transition: right .3s ease; z-index: 1051; display:flex; flex-direction:column;
    }
    .drawer.show{ right: 0; }
    .drawer-header{
      padding: 14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between;
    }
    .drawer-body{ padding: 16px; overflow: auto; }
  </style>
</head>
<body>
    {% include 'manager_sidebar.html' %}

  <!-- Topbar -->
  <div class="page-head">
    <div class="container py-3 d-flex align-items-center justify-content-between">
      <h3 class="m-0"> </h3>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" id="openDrawer"><i class="bi bi-plus-lg me-1"></i> Add Expense</button>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('login.logout') }}">Logout</a>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- KPI CARDS -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="text-muted m-0">Today</h6>
              <span class="badge badge-soft">All statuses</span>
            </div>
            <div class="display-6 fw-bold mt-1">GHS <span id="kpiToday">0.00</span></div>
            <small class="text-muted">Includes Approved & Unapproved</small>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="text-muted m-0">This Week</h6>
              <span class="badge badge-soft">All statuses</span>
            </div>
            <div class="display-6 fw-bold mt-1">GHS <span id="kpiWeek">0.00</span></div>
            <small class="text-muted">Mon-Today (UTC)</small>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="text-muted m-0">This Month</h6>
              <span class="badge badge-soft">All statuses</span>
            </div>
            <div class="display-6 fw-bold mt-1">GHS <span id="kpiMonth">0.00</span></div>
            <small class="text-muted">Calendar month (UTC)</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Top Categories -- Last 7 Days</h5>
              <span class="badge text-bg-primary" id="total7">Total: GHS 0.00</span>
            </div>
            <canvas id="chart7"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Top Categories -- Last 30 Days</h5>
              <span class="badge text-bg-primary" id="total30">Total: GHS 0.00</span>
            </div>
            <canvas id="chart30"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Recent Expenses (Last 30 Days)</h5>
          <span class="badge text-bg-info">Total: GHS {{ total_last30 }}</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width:110px">Date</th>
                <th style="width:95px">Time</th>
                <th>Category</th>
                <th>Description</th>
                <th style="width:140px">Status</th>
                <th class="text-end" style="width:140px">Amount (GHS)</th>
              </tr>
            </thead>
            <tbody id="rows">
              {% for r in rows %}
              <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.time }}</td>
                <td>{{ r.category }}</td>
                <td>{{ r.description }}</td>
                <td>
                  {% if r.status == 'Approved' %}
                    <span class="badge badge-approved">Approved</span>
                  {% else %}
                    <span class="badge badge-pending">Unapproved</span>
                  {% endif %}
                </td>
                <td class="text-end">{{ r.amount }}</td>
              </tr>
              {% endfor %}
              {% if rows|length == 0 %}
              <tr><td colspan="6" class="text-center text-muted py-4">No expenses recorded yet.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer (slide-in form) -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-header">
      <h5 class="m-0">Add Expense</h5>
      <button class="btn-close" id="closeDrawer" aria-label="Close"></button>
    </div>
    <div class="drawer-body">
      <div class="help-hint mb-2">New expenses are saved as <span class="badge badge-pending">Unapproved</span>.</div>
      <form id="expense-form" class="row g-3">
        <div class="col-12">
          <label class="form-label">Date</label>
          <input type="date" class="form-control" name="date" value="{{ today }}" required>
        </div>
        <div class="col-12">
          <label class="form-label">Category</label>
          <select class="form-select" name="category" required>
            <option value="" disabled selected>Choose...</option>
            {% for c in categories %}
            <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Amount (GHS)</label>
          <input type="number" step="0.01" class="form-control" name="amount" placeholder="0.00" required>
        </div>
        <div class="col-12">
          <label class="form-label">Description</label>
          <input type="text" class="form-control" name="description" placeholder="Optional note">
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-primary" type="submit"><i class="bi bi-check2 me-1"></i> Save Expense</button>
          <span id="form-status" class="mt-2"></span>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---- Drawer controls
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('drawerOverlay');
    const openBtn = document.getElementById('openDrawer');
    const closeBtn = document.getElementById('closeDrawer');
    function openDrawer(){ drawer.classList.add('show'); overlay.classList.add('show'); }
    function closeDrawer(){ drawer.classList.remove('show'); overlay.classList.remove('show'); }
    openBtn.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', closeDrawer);
    overlay.addEventListener('click', closeDrawer);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('show')) closeDrawer(); });

    // ---- helpers
    function fmt(n){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function notify(msg, ok=true){
      $("#form-status").text(msg).css("color", ok ? "#0d6efd" : "#dc2626");
      setTimeout(()=>$("#form-status").text(""), 3500);
    }

    // ---- KPIs (All statuses). Change &status=Approved if you want approved-only.
    function loadKpis(){
      $.getJSON(`/manager-expense/stats?range=today&status=All`,  r => { if(r?.ok) $("#kpiToday").text(fmt(r.total)); });
      $.getJSON(`/manager-expense/stats?range=week&status=All`,   r => { if(r?.ok) $("#kpiWeek").text(fmt(r.total));  });
      $.getJSON(`/manager-expense/stats?range=month&status=All`,  r => { if(r?.ok) $("#kpiMonth").text(fmt(r.total)); });
    }

    // ---- charts (Approved only as discussed)
    let chart7, chart30;
    function loadChart(rangeKey, canvasId, totalId){
      $.getJSON(`/manager-expense/stats?range=${rangeKey}&status=Approved`, (res)=>{
        if(!res.ok) return;
        const labels = res.by_category.map(x=>x.category);
        const data   = res.by_category.map(x=>x.total);
        const ctx = document.getElementById(canvasId).getContext("2d");
        if(canvasId === "chart7" && chart7) chart7.destroy();
        if(canvasId === "chart30" && chart30) chart30.destroy();
        const cfg = {
          type: "bar",
          data: { labels, datasets: [{ label: "GHS", data }] },
          options: {
            responsive: true,
            plugins: { legend: { display:false }, tooltip: { callbacks:{ label:(c)=>`GHS ${fmt(c.raw)}` } } },
            scales: { y: { beginAtZero:true } }
          }
        };
        if(canvasId === "chart7") chart7 = new Chart(ctx, cfg); else chart30 = new Chart(ctx, cfg);
        $(`#${totalId}`).text(`Total: GHS ${fmt(res.total)}`);
      });
    }

    // initial load
    loadKpis();
    loadChart("last7",  "chart7",  "total7");
    loadChart("last30", "chart30", "total30");

    // ---- submit form (AJAX)
    $("#expense-form").on("submit", function(e){
      e.preventDefault();
      const fd = new FormData(this);
      $.ajax({
        url: "/manager-expense/create",
        method: "POST",
        data: fd, processData: false, contentType: false,
        success: (res)=>{
          if(res?.ok){
            notify(res.message, true);
            // prepend new row
            const r = res.item;
            const tr = `<tr>
              <td>${r.date}</td><td>${r.time}</td><td>${r.category}</td>
              <td>${r.description || ""}</td>
              <td><span class="badge badge-pending">Unapproved</span></td>
              <td class="text-end">${r.amount}</td>
            </tr>`;
            $("#rows").prepend(tr);

            // refresh KPIs and charts
            loadKpis();
            loadChart("last7",  "chart7",  "total7");
            loadChart("last30", "chart30", "total30");

            // reset a few inputs
            this.amount.value = "";
            this.description.value = "";
            // keep drawer open for rapid entries, or close:
            // closeDrawer();
          }else{
            notify(res?.message || "Failed to save.", false);
          }
        },
        error: (xhr)=> notify(xhr?.responseJSON?.message || "Failed to save.", false)
      });
    });
  </script>
  {% include 'app_footer.html' %}

</body>
</html>

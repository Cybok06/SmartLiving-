<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Executive — Sales Close</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --soft:#f6f8fb; --brand:#0d6efd;
      --ok:#16a34a; --ok-bg:#e7f8ec; --danger:#b91c1c; --danger-bg:#fdecec;
    }
    body{ background:var(--soft); color:var(--ink); }
    .page-wrap{ max-width:1200px; margin:40px auto; padding:0 16px; }

    .card-summary .icon{
      width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      margin-right:12px;flex:0 0 auto;font-size:1.25rem
    }
    .stat{ font-weight:800; font-size:1.6rem; line-height:1; letter-spacing:.2px }
    .substat{ font-size:.875rem; color:var(--muted) }
    .muted{ color:var(--muted) }

    .stat-close{ color:var(--ok) }
    .card-close .icon{ background:var(--ok-bg); color:var(--ok) }

    .stat-unclose{ color:var(--danger) }
    .card-unclose .icon{ background:var(--danger-bg); color:var(--danger) }

    .role-badge{ font-size:.7rem; padding:.2rem .45rem; border-radius:.35rem }
    .role-admin{ background:#eef2ff; color:#3730a3 }
    .role-manager{ background:#ecfeff; color:#155e75 }
    .role-agent{ background:#fefce8; color:#854d0e }

    .user-card .amt{ font-size:1.7rem; font-weight:800; letter-spacing:.3px }
    .user-card .meta{ font-size:.9rem; color:var(--muted) }

    .search-wrap .form-control{ border-radius:10px }

    .spinner { display:inline-block; width:1rem; height:1rem; border:.2rem solid rgba(255,255,255,.35); border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 575.98px){
      .stat{ font-size:1.35rem }
      .page-wrap{ margin:20px auto; }
    }

    /* History table */
    #historyTable thead th{ position:sticky; top:0; background:#fff; z-index:2 }
  </style>
</head>
<body>

  {% include 'executive_sidebar.html' %}

<div class="page-wrap">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">Executive — Sales Close</h3>
    <div class="muted small">Welcome, <span class="fw-semibold">{{ executive_name }}</span> · Today: <span class="fw-semibold">{{ today }}</span></div>
  </div>

  <!-- Summary cards: Close (green) and Unclose (red) -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100 card-summary card-close">
        <div class="card-body d-flex align-items-center">
          <div class="icon"><i class="bi bi-bank2"></i></div>
          <div>
            <div class="muted">Close Total (Executive Account)</div>
            <div class="stat stat-close" id="closeTotal">GHS {{ close_total }}</div>
            <div class="substat">Total credited to your account (all time)</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100 card-summary card-unclose">
        <div class="card-body d-flex align-items-center">
          <div class="icon"><i class="bi bi-exclamation-octagon"></i></div>
          <div>
            <div class="muted">Unclose Total (Everyone)</div>
            <div class="stat stat-unclose" id="uncloseTotal">GHS {{ unclose_total }}</div>
            <div class="substat">Sum of all Admin + Manager + Agent balances (all dates)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts -->
  <div id="alertHost"></div>

  <!-- Toolbar -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="fw-bold">Accounts — Highest Balances First</div>
    <div class="search-wrap" style="max-width: 260px;">
      <input type="search" id="userSearch" class="form-control form-control-sm" placeholder="Search any user...">
    </div>
  </div>

  <!-- Admins -->
  <div class="mb-2 d-flex align-items-center gap-2">
    <span class="badge role-badge role-admin">Admins</span>
    <span class="muted small">Withdraw directly from admin accounts</span>
  </div>
  <div class="row g-3" id="adminsGrid">
    {% if admins|length == 0 %}
      <div class="col-12"><div class="alert alert-info">No admins found.</div></div>
    {% else %}
      {% for u in admins %}
      <div class="col-12 col-md-6 col-lg-4 user-col"
           data-name="{{ u.name|lower }}" data-phone="{{ u.phone|lower }}" data-role="admin" data-available="{{ u.available_num }}">
        <div class="card user-card shadow-sm h-100" data-user-id="{{ u._id }}" data-role="admin">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ u.name }}</div>
                <div class="meta">{{ u.phone or '—' }}</div>
              </div>
              <span class="badge bg-light text-dark">All dates</span>
            </div>

            <div class="mt-3 muted">Total Available</div>
            <div class="amt" id="bal-{{ u._id }}">GHS {{ u.available }}</div>

            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm withdraw-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}"
                      data-user-phone="{{ u.phone|e }}"
                      data-role="admin"
                      data-available="{{ u.available }}">
                <i class="bi bi-cash-coin"></i> Withdraw
              </button>

              <button class="btn btn-outline-secondary btn-sm history-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}">
                <i class="bi bi-clock-history"></i> History
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Managers -->
  <div class="mt-4 mb-2 d-flex align-items-center gap-2">
    <span class="badge role-badge role-manager">Managers</span>
    <span class="muted small">Withdraw from manager accounts</span>
  </div>
  <div class="row g-3" id="managersGrid">
    {% if managers|length == 0 %}
      <div class="col-12"><div class="alert alert-info">No managers found.</div></div>
    {% else %}
      {% for u in managers %}
      <div class="col-12 col-md-6 col-lg-4 user-col"
           data-name="{{ u.name|lower }}" data-phone="{{ u.phone|lower }}" data-role="manager" data-available="{{ u.available_num }}">
        <div class="card user-card shadow-sm h-100" data-user-id="{{ u._id }}" data-role="manager">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ u.name }}</div>
                <div class="meta">{{ u.phone or '—' }}</div>
              </div>
              <span class="badge bg-light text-dark">All dates</span>
            </div>

            <div class="mt-3 muted">Total Available</div>
            <div class="amt" id="bal-{{ u._id }}">GHS {{ u.available }}</div>

            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm withdraw-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}"
                      data-user-phone="{{ u.phone|e }}"
                      data-role="manager"
                      data-available="{{ u.available }}">
                <i class="bi bi-cash-coin"></i> Withdraw
              </button>

              <button class="btn btn-outline-secondary btn-sm history-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}">
                <i class="bi bi-clock-history"></i> History
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% endif %}
  </div>

  <!-- Agents -->
  <div class="mt-4 mb-2 d-flex align-items-center gap-2">
    <span class="badge role-badge role-agent">Agents</span>
    <span class="muted small">Withdraw from agent accounts</span>
  </div>
  <div class="row g-3" id="agentsGrid">
    {% if agents|length == 0 %}
      <div class="col-12"><div class="alert alert-info">No agents found.</div></div>
    {% else %}
      {% for u in agents %}
      <div class="col-12 col-md-6 col-lg-4 user-col"
           data-name="{{ u.name|lower }}" data-phone="{{ u.phone|lower }}" data-role="agent" data-available="{{ u.available_num }}">
        <div class="card user-card shadow-sm h-100" data-user-id="{{ u._id }}" data-role="agent">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-semibold">{{ u.name }}</div>
                <div class="meta">{{ u.phone or '—' }}</div>
              </div>
              <span class="badge bg-light text-dark">All dates</span>
            </div>

            <div class="mt-3 muted">Total Available</div>
            <div class="amt" id="bal-{{ u._id }}">GHS {{ u.available }}</div>

            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm withdraw-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}"
                      data-user-phone="{{ u.phone|e }}"
                      data-role="agent"
                      data-available="{{ u.available }}">
                <i class="bi bi-cash-coin"></i> Withdraw
              </button>

              <button class="btn btn-outline-secondary btn-sm history-btn"
                      data-user-id="{{ u._id }}"
                      data-user-name="{{ u.name|e }}">
                <i class="bi bi-clock-history"></i> History
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<!-- Withdraw Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Withdraw from <span id="mUserName">User</span> <span class="badge ms-2 role-badge" id="mUserRoleBadge"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="withdrawForm">
        <div class="modal-body">
          <input type="hidden" name="target_id" id="mUserId">
          <div class="row g-3">
            <div class="col-12">
              <div class="small text-muted">Phone</div>
              <div class="fw-semibold" id="mUserPhone">—</div>
            </div>
            <div class="col-12">
              <div class="small text-muted">Total Available (all dates)</div>
              <div class="fw-bold">GHS <span id="mUserAvail">0.00</span></div>
            </div>
            <div class="col-12">
              <label class="form-label">Amount (GHS)</label>
              <div class="input-group">
                <input type="number" name="amount" id="mAmount" class="form-control" step="0.01" min="0.01" required>
                <button class="btn btn-outline-secondary" type="button" id="mMaxBtn">Max</button>
              </div>
              <div class="form-text">This credits your executive account and debits the user’s account.</div>
            </div>
            <div class="col-12">
              <label class="form-label">Note (optional)</label>
              <input type="text" name="note" id="mNote" class="form-control" placeholder="e.g., Collection">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted">Today: <span class="fw-semibold">{{ today }}</span></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" id="mSubmitBtn" class="btn btn-primary">
            <span class="label">Withdraw</span>
            <span class="spinner ms-2" style="display:none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header">
        <h5 class="modal-title">Withdrawal History — <span id="hUserName">User</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="historyEmpty" class="text-center text-muted" style="display:none;">No withdrawals yet.</div>
        <div class="table-responsive" id="historyWrap" style="max-height:420px; overflow:auto; display:none;">
          <table class="table table-sm align-middle" id="historyTable">
            <thead>
              <tr>
                <th style="min-width:120px">Date</th>
                <th style="min-width:100px">Time</th>
                <th style="min-width:140px">Amount (GHS)</th>
                <th style="min-width:200px">Note</th>
                <th style="min-width:160px">By</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="small text-muted" id="historyCount">0 records</div>
      </div>
    </div>
  </div>
</div>

<!-- Data for JS -->
<script id="admins-data" type="application/json">{{ admins | tojson }}</script>
<script id="managers-data" type="application/json">{{ managers | tojson }}</script>
<script id="agents-data" type="application/json">{{ agents | tojson }}</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const admins   = JSON.parse(document.getElementById('admins-data').textContent || '[]');
  const managers = JSON.parse(document.getElementById('managers-data').textContent || '[]');
  const agents   = JSON.parse(document.getElementById('agents-data').textContent || '[]');

  // Build a single map for quick access by id
  const userMap = {};
  [...admins, ...managers, ...agents].forEach(u => { userMap[String(u._id)] = u; });

  // UI bits
  const alertHost   = document.getElementById('alertHost');
  const searchInput = document.getElementById('userSearch');

  const adminsGrid   = document.getElementById('adminsGrid');
  const managersGrid = document.getElementById('managersGrid');
  const agentsGrid   = document.getElementById('agentsGrid');

  const withdrawModalEl = document.getElementById('withdrawModal');
  const withdrawModal   = new bootstrap.Modal(withdrawModalEl);

  const mUserName  = document.getElementById('mUserName');
  const mUserPhone = document.getElementById('mUserPhone');
  const mUserAvail = document.getElementById('mUserAvail');
  const mUserId    = document.getElementById('mUserId');
  const mUserRoleBadge = document.getElementById('mUserRoleBadge');
  const mAmount    = document.getElementById('mAmount');
  const mMaxBtn    = document.getElementById('mMaxBtn');
  const mNote      = document.getElementById('mNote');
  const mSubmitBtn = document.getElementById('mSubmitBtn');
  const mLabel     = mSubmitBtn.querySelector('.label');
  const mSpin      = mSubmitBtn.querySelector('.spinner');

  const uncloseTotalEl = document.getElementById('uncloseTotal');
  const closeTotalEl   = document.getElementById('closeTotal');

  const historyModalEl = document.getElementById('historyModal');
  const historyModal   = new bootstrap.Modal(historyModalEl);
  const hUserName      = document.getElementById('hUserName');
  const historyTbody   = document.getElementById('historyTbody');
  const historyWrap    = document.getElementById('historyWrap');
  const historyEmpty   = document.getElementById('historyEmpty');
  const historyCount   = document.getElementById('historyCount');

  function showAlert(kind, message){
    const wrap = document.createElement('div');
    wrap.className = `alert alert-${kind} alert-dismissible fade show`;
    wrap.role = 'alert';
    wrap.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    alertHost.innerHTML = '';
    alertHost.appendChild(wrap);
    setTimeout(()=>{ try{ bootstrap.Alert.getOrCreateInstance(wrap).close(); }catch(e){} }, 5000);
  }

  function setLoading(on){
    mSubmitBtn.disabled = !!on;
    mSpin.style.display = on ? 'inline-block' : 'none';
    mLabel.textContent  = on ? 'Processing...' : 'Withdraw';
  }

  // Search/filter across all grids
  searchInput?.addEventListener('input', ()=>{
    const q = searchInput.value.trim().toLowerCase();
    [adminsGrid, managersGrid, agentsGrid].forEach(grid=>{
      grid.querySelectorAll('.user-col').forEach(col=>{
        const name  = col.dataset.name || '';
        const phone = col.dataset.phone || '';
        col.style.display = (name.includes(q) || phone.includes(q)) ? '' : 'none';
      });
    });
  });

  // Resort a grid by data-available desc
  function resortGrid(grid){
    const cols = Array.from(grid.querySelectorAll('.user-col'));
    cols.sort((a,b)=> (parseFloat(b.dataset.available || '0') - parseFloat(a.dataset.available || '0')));
    cols.forEach(c => grid.appendChild(c));
  }

  // Role badge color helper
  function roleBadgeClass(role){
    if(role === 'admin') return 'role-badge role-admin';
    if(role === 'manager') return 'role-badge role-manager';
    return 'role-badge role-agent';
  }

  // Delegated click handlers (withdraw / history) for each grid
  [adminsGrid, managersGrid, agentsGrid].forEach(grid=>{
    grid.addEventListener('click', (e)=>{
      const wbtn = e.target.closest('.withdraw-btn');
      if(wbtn){
        const id   = wbtn.dataset.userId;
        const name = wbtn.dataset.userName || 'User';
        const phone= wbtn.dataset.userPhone || '—';
        const role = wbtn.dataset.role || '';
        const avail= wbtn.dataset.available || '0.00';

        mUserId.value = id;
        mUserName.textContent = name;
        mUserPhone.textContent = phone;
        mUserAvail.textContent = avail;
        mUserRoleBadge.className = roleBadgeClass(role);
        mUserRoleBadge.textContent = role ? role.toUpperCase() : '';

        mAmount.value = '';
        mNote.value   = '';

        withdrawModal.show();
        setTimeout(()=> mAmount.focus(), 200);
        return;
      }

      const hbtn = e.target.closest('.history-btn');
      if(hbtn){
        const id   = hbtn.dataset.userId;
        const name = hbtn.dataset.userName || 'User';

        hUserName.textContent = name;
        historyTbody.innerHTML = '';
        historyEmpty.style.display = 'none';
        historyWrap.style.display  = 'none';
        historyCount.textContent = 'Loading...';

        (async ()=>{
          try{
            const resp = await fetch(`/executive-close/user/${id}/withdrawals`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
            const data = await resp.json().catch(()=> ({}));
            if(resp.ok && data && data.ok){
              const rows = data.withdrawals || [];
              if(rows.length === 0){
                historyEmpty.style.display = 'block';
                historyWrap.style.display  = 'none';
                historyCount.textContent = '0 records';
              }else{
                const frag = document.createDocumentFragment();
                rows.forEach(r=>{
                  const tr = document.createElement('tr');
                  const amt = (typeof r.amount === 'number' ? r.amount : parseFloat(r.amount || '0')).toFixed(2);
                  tr.innerHTML = `
                    <td>${r.date || ''}</td>
                    <td>${r.time || ''}</td>
                    <td class="fw-semibold">GHS ${amt}</td>
                    <td>${(r.note || '').replace(/</g,'&lt;')}</td>
                    <td>${(r.by_name || '')}${r.by_role ? ' · ' + r.by_role : ''}</td>
                  `;
                  frag.appendChild(tr);
                });
                historyTbody.appendChild(frag);
                historyWrap.style.display  = 'block';
                historyEmpty.style.display = 'none';
                historyCount.textContent = rows.length + ' record' + (rows.length===1?'':'s');
              }
            }else{
              historyEmpty.style.display = 'block';
              historyWrap.style.display  = 'none';
              historyCount.textContent = '0 records';
            }
          }catch(err){
            console.error(err);
            historyEmpty.style.display = 'block';
            historyWrap.style.display  = 'none';
            historyCount.textContent = '0 records';
          }
          historyModal.show();
        })();

        return;
      }
    });
  });

  // Max button -> set amount to available
  mMaxBtn.addEventListener('click', ()=>{
    const raw = (mUserAvail.textContent || '0').replaceAll(',', '').trim();
    const num = parseFloat(raw);
    if(!isNaN(num) && num > 0){
      mAmount.value = num.toFixed(2);
      mAmount.focus();
    }
  });

  // Submit modal form
  document.getElementById('withdrawForm').addEventListener('submit', async (e)=>{
    e.preventDefault();

    const target_id = mUserId.value;
    const amount = parseFloat(mAmount.value || '0');

    if(!target_id){ showAlert('warning','No user selected.'); return; }
    if(!(amount > 0)){ showAlert('warning','Enter a positive amount.'); return; }

    const fd = new FormData();
    fd.set('target_id', target_id);
    fd.set('amount', amount);
    fd.set('note', mNote.value || '');

    setLoading(true);
    try{
      const resp = await fetch("{{ url_for('executive_sales_close.executive_withdraw') }}", {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: fd
      });
      const data = await resp.json().catch(()=> ({}));

      if(resp.ok && data && data.ok){
        // Update user card balance
        const balEl = document.getElementById('bal-' + target_id);
        if(balEl && data.available){
          balEl.textContent = 'GHS ' + data.available;
        }

        // Update the column's data-available for sorting
        const col = document.querySelector(`.user-col [data-user-id="${target_id}"]`)?.closest('.user-col');
        if(col && data.available){
          const num = parseFloat(String(data.available).replaceAll(',', '')) || 0;
          col.dataset.available = num.toString();

          // Resort the correct grid
          const role = col.dataset.role || col.querySelector('[data-role]')?.dataset.role;
          if(role === 'admin'){ resortGrid(adminsGrid); }
          else if(role === 'manager'){ resortGrid(managersGrid); }
          else { resortGrid(agentsGrid); }
        }

        // Update button dataset available for next modal opens
        const btn = document.querySelector(`.withdraw-btn[data-user-id="${target_id}"]`);
        if(btn && data.available){ btn.dataset.available = data.available; }

        // Update modal info too
        if(data.available){ mUserAvail.textContent = data.available; }

        // Update top cards
        if(data.unclose_total){ uncloseTotalEl.textContent = 'GHS ' + data.unclose_total; }
        if(data.close_total){   closeTotalEl.textContent   = 'GHS ' + data.close_total;   }

        showAlert('success', (data.message || 'Withdrawal successful.') + (data.debited_date ? ` (debited ${data.debited_date})` : ''));
        bootstrap.Modal.getInstance(withdrawModalEl)?.hide();
      }else{
        showAlert('danger', (data && data.message) || 'Withdrawal failed.');
      }
    }catch(err){
      console.error(err);
      showAlert('danger', 'Network error. Please try again.');
    }finally{
      setLoading(false);
    }
  });

  // Initial resort (server already sorted, but ensure on load)
  [adminsGrid, managersGrid, agentsGrid].forEach(resortGrid);
})();
</script>
</body>
</html>

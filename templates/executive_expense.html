<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Executive Â· Expenses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png"/>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --primary:#0d6efd; --primary-100:#e7f1ff;
      --card:#ffffff; --bg:#f7fafc;
    }
    body{
      background:var(--bg);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    }
    .page-head{
      background:#fff;
      border-bottom:1px solid var(--line);
    }
    .card{
      background:#fff;
      border:1px solid var(--line);
      box-shadow:0 4px 14px rgba(2,6,23,.05);
      border-radius:0.75rem;
    }
    .form-select,.form-control{
      border-color:#dbe3ef;
      border-radius:0.6rem;
      font-size:0.875rem;
    }
    .form-select:focus,.form-control:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 .2rem rgba(13,110,253,.15);
    }
    .badge-soft{
      background:var(--primary-100);
      color:var(--primary);
      border:1px solid #cfe1ff;
      font-weight:600;
    }
    .badge-pending{
      background:#fff7ed;
      color:#b45309;
      border:1px solid #fde68a;
      font-weight:600;
    }
    .badge-approved{
      background:#ecfdf5;
      color:#047857;
      border:1px solid #a7f3d0;
      font-weight:600;
    }
    .table thead th{
      background:#f8fafc;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .btn-pill-group .btn{
      border-radius:999px !important;
      font-size:0.78rem;
      padding:.35rem .85rem;
    }
  </style>
</head>
<body>
  {% include 'executive_sidebar.html' %}

  <!-- Topbar -->
  <div class="page-head">
    <div class="container py-3 d-flex align-items-center justify-content-between">
      <div>
        <h5 class="m-0 fw-semibold">Branches Expenses</h5>
        <small class="text-muted">Approve and monitor managers' expenses by branch and custom date ranges.</small>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="text-muted small">Signed in as <strong>{{ executive_name }}</strong></span>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('login.logout') }}">Logout</a>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <!-- Filters -->
    <div class="card mb-3">
      <div class="card-body">
        <form id="filters" class="row g-3 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Branch</label>
            <select class="form-select" name="branch">
              <option value="">All Branches</option>
              {% for b in branches %}
                <option value="{{ b.name }}">{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Manager</label>
            <select class="form-select" name="manager_id">
              <option value="">All Managers</option>
              {% for m in managers %}
                <option value="{{ m._id }}">{{ m.name }}{% if m.branch %} -- {{ m.branch }}{% endif %}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Range</label>
            <select class="form-select" name="range">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="last7">Last 7 Days</option>
              <option value="last30" selected>Last 30 Days</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Status</label>
            <select class="form-select" name="status">
              <option>Unapproved</option>
              <option>Approved</option>
              <option>All</option>
            </select>
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label">From</label>
            <input type="date" class="form-control" name="start" />
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label">To</label>
            <input type="date" class="form-control" name="end" />
          </div>
          <div class="col-12 d-flex justify-content-between align-items-center mt-2">
            <div class="btn-pill-group btn-group" role="group" aria-label="Status quick toggle">
              <button type="button" data-status="Unapproved" class="btn btn-sm btn-outline-primary active">Unapproved</button>
              <button type="button" data-status="Approved" class="btn btn-sm btn-outline-primary">Approved</button>
              <button type="button" data-status="All" class="btn btn-sm btn-outline-primary">History</button>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-light btn-sm" type="button" id="btnClearDates">Clear dates</button>
              <button class="btn btn-primary" type="submit"><i class="bi bi-filter me-1"></i> Apply Filters</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-muted m-0">
              Filtered Window
              <span class="badge badge-soft ms-1" id="kpi-status">Unapproved</span>
            </h6>
            <div class="display-6 fw-bold mt-1">GHS <span id="kpiFiltered">0.00</span></div>
            <small class="text-muted">
              Total expense for selected branch/manager, status and date range.
            </small>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-muted m-0">Unapproved Count</h6>
            <div class="display-6 fw-bold mt-1"><span id="kpiCount">0</span></div>
            <small class="text-muted">Number of rows currently displayed in the table.</small>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="text-muted m-0">Last Refresh</h6>
            <div class="display-6 fw-bold mt-1"><span id="kpiRefresh">-</span></div>
            <small class="text-muted">When the data was last refreshed.</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Top Categories (Filtered)</h5>
              <span class="badge text-bg-primary" id="totalCat">Total: GHS 0.00</span>
            </div>
            <canvas id="chartCategories"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Branches with Highest Expense (Filtered)</h5>
              <span class="badge text-bg-primary" id="totalBranch">Total: GHS 0.00</span>
            </div>
            <canvas id="chartBranches"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Unapproved Expenses (Default View)</h5>
          <span class="badge text-bg-info" id="tableCount">0 items</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Manager</th>
                <th>Branch</th>
                <th>Category</th>
                <th>Description</th>
                <th>Status</th>
                <th class="text-end">Amount (GHS)</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="rows">
              {% for r in rows %}
                <tr data-id="{{ r._id }}">
                  <td>{{ r.date }}</td>
                  <td>{{ r.time }}</td>
                  <td>{{ r.manager_name }}</td>
                  <td>{{ r.branch }}</td>
                  <td>{{ r.category }}</td>
                  <td>{{ r.description }}</td>
                  <td>
                    {% if r.status == 'Approved' %}
                      <span class="badge badge-approved">Approved</span>
                    {% else %}
                      <span class="badge badge-pending">Unapproved</span>
                    {% endif %}
                  </td>
                  <td class="text-end">{{ r.amount }}</td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-success approve-btn" {% if r.status == 'Approved' %}disabled{% endif %}>Approve</button>
                    <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    function fmt(n){
      return Number(n || 0).toLocaleString(undefined,{
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }

    const $filters = $("#filters");

    function buildQuery(){
      const f = $filters[0];
      const params = new URLSearchParams();
      params.set("branch", f.branch.value || "");
      params.set("manager_id", f.manager_id.value || "");
      params.set("status", f.status.value || "Unapproved");
      params.set("range", f.range.value || "last30");

      if (f.range.value === "custom") {
        if (f.start.value) params.set("start", f.start.value);
        if (f.end.value) params.set("end", f.end.value);
      } else {
        // ensure custom dates are not accidentally sent
        params.delete("start");
        params.delete("end");
      }
      return params.toString();
    }

    function markRefresh(){
      const now = new Date();
      $("#kpiRefresh").text(now.toLocaleTimeString());
    }

    // KPI - filtered total and count
    function loadKPIs(currentRowCount){
      const f = $filters[0];
      const status = f.status.value || "Unapproved";
      $("#kpi-status").text(status);

      const qs = buildQuery();
      $.getJSON(`/executive-expense/stats?${qs}`, (r)=>{
        if (!r?.ok) return;
        $("#kpiFiltered").text(fmt(r.total));
      });

      if (typeof currentRowCount === "number") {
        $("#kpiCount").text(currentRowCount);
      }
    }

    let chartCat, chartBranch;

    function loadCharts(){
      const qs = buildQuery();

      // categories
      $.getJSON(`/executive-expense/stats?group=category&${qs}`, (r)=>{
        if(!r?.ok) return;
        const ctx = document.getElementById("chartCategories").getContext("2d");
        if(chartCat) chartCat.destroy();
        chartCat = new Chart(ctx, {
          type: "bar",
          data: {
            labels: r.items.map(x=>x.name),
            datasets: [{label:"GHS", data:r.items.map(x=>x.total)}]
          },
          options: {
            responsive:true,
            plugins:{ legend:{display:false} },
            scales:{ y:{ beginAtZero:true } }
          }
        });
        $("#totalCat").text(`Total: GHS ${fmt(r.total)}`);
      });

      // branches
      $.getJSON(`/executive-expense/stats?group=branch&${qs}`, (r)=>{
        if(!r?.ok) return;
        const ctx = document.getElementById("chartBranches").getContext("2d");
        if(chartBranch) chartBranch.destroy();
        chartBranch = new Chart(ctx, {
          type: "bar",
          data: {
            labels: r.items.map(x=>x.name),
            datasets: [{label:"GHS", data:r.items.map(x=>x.total)}]
          },
          options: {
            responsive:true,
            plugins:{ legend:{display:false} },
            scales:{ y:{ beginAtZero:true } }
          }
        });
        $("#totalBranch").text(`Total: GHS ${fmt(r.total)}`);
      });
    }

    function loadTable(){
      const qs = buildQuery();
      $.getJSON(`/executive-expense/list?${qs}`, (r)=>{
        if(!r?.ok) return;
        const tbody = $("#rows").empty();
        r.rows.forEach(row=>{
          tbody.append(`<tr data-id="${row._id}">
            <td>${row.date || ""}</td>
            <td>${row.time || ""}</td>
            <td>${row.manager_name || ""}</td>
            <td>${row.branch || ""}</td>
            <td>${row.category || ""}</td>
            <td>${row.description || ""}</td>
            <td>${
              row.status === "Approved"
              ? '<span class="badge badge-approved">Approved</span>'
              : '<span class="badge badge-pending">Unapproved</span>'
            }</td>
            <td class="text-end">${row.amount}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-success approve-btn" ${row.status === "Approved" ? "disabled":""}>Approve</button>
              <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
            </td>
          </tr>`);
        });
        $("#tableCount").text(`${r.rows.length} items`);
        loadKPIs(r.rows.length);
        markRefresh();
      });
    }

    // Approve
    $(document).on("click", ".approve-btn", function(){
      const $tr = $(this).closest("tr");
      const id = $tr.data("id");
      $.post("/executive-expense/approve", {id}, (res)=>{
        if(res?.ok){
          loadTable();
          loadCharts();
        }else{
          alert(res?.message || "Could not approve.");
        }
      }).fail(()=>alert("Could not approve."));
    });

    // Delete
    $(document).on("click", ".delete-btn", function(){
      if(!confirm("Delete this expense?")) return;
      const $tr = $(this).closest("tr");
      const id = $tr.data("id");
      $.post("/executive-expense/delete", {id}, (res)=>{
        if(res?.ok){
          $tr.remove();
          loadTable();
          loadCharts();
        }else{
          alert(res?.message || "Could not delete.");
        }
      }).fail(()=>alert("Could not delete."));
    });

    // Filters submit
    $("#filters").on("submit", function(e){
      e.preventDefault();
      loadTable();
      loadCharts();
    });

    // Status pill toggles
    $(".btn-pill-group .btn").on("click", function(){
      $(".btn-pill-group .btn").removeClass("active");
      $(this).addClass("active");
      const status = $(this).data("status");
      $filters[0].status.value = status;
      // optional: auto-submit when toggled
      $("#filters").trigger("submit");
    });

    // Clear dates
    $("#btnClearDates").on("click", function(){
      $filters[0].start.value = "";
      $filters[0].end.value = "";
      if ($filters[0].range.value === "custom") {
        // keep as custom but empty dates; or switch back to last30
        $filters[0].range.value = "last30";
      }
      $("#filters").trigger("submit");
    });

    // If range is switched away from custom, clear dates visually
    $filters.find("select[name='range']").on("change", function(){
      if(this.value !== "custom"){
        $filters[0].start.value = "";
        $filters[0].end.value = "";
      }
    });

    // Initial load (page already has default rows = unapproved last30)
    $(function(){
      const initialCount = $("#rows tr").length;
      $("#tableCount").text(`${initialCount} items`);
      $("#kpiCount").text(initialCount);
      markRefresh();
      loadKPIs(initialCount);
      loadCharts();
    });
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

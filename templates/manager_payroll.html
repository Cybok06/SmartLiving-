<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Manager Payroll</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="icon"
        href="https://imagedelivery.net/h9fmMoa1o2c2P55TcWJGOg/8744779c-1300-4a50-49de-b143d24da300/public"
        type="image/png"/>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --bg:#f8fafc;
      --soft:#f1f5f9;
      --brand:#0b63ce;
    }

    html, body { height: 100%; }
    html{ scroll-behavior: smooth; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
      margin: 0;
    }

    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
    }
    .toolbar .group{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .summary{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 12px;
    }
    .summary .row{ gap: 12px; }
    .summary .item{ font-size:.9rem; color: var(--muted); }
    .summary .item b{ color: var(--ink); }

    .mini{
      display:flex;
      gap:12px;
      align-items:center;
      padding: 8px 10px;
      background: var(--soft);
      border-radius: 10px;
      font-size:.88rem;
      color: var(--muted);
    }
    .mini b{ color: var(--ink); }

    .table-wrap{
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }

    table{ width:100%; border-collapse: collapse; }
    thead th{
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 10px 8px;
      font-size:.78rem;
      text-transform: uppercase;
      letter-spacing:.06em;
      color: var(--muted);
    }
    tbody td{
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      font-size:.9rem;
    }
    tbody tr:nth-child(2n){ background: #fafafa; }

    .mono{ font-variant-numeric: tabular-nums; }

    .skeleton{
      height: 12px;
      border-radius: 8px;
      background: linear-gradient(90deg, #eef2f7, #f8fafc, #eef2f7);
      background-size: 220% 100%;
      animation: shimmer 1s linear infinite;
    }
    @keyframes shimmer{
      0%{ background-position: 100% 0; }
      100%{ background-position: -120% 0; }
    }

    .modal-header{ border-bottom: 1px solid var(--border); }
    .modal-footer{ border-top: 1px solid var(--border); }

    .tab-strip{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .tab-btn{
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:10px;
      font-size:.88rem;
      color: var(--muted);
    }
    .tab-btn.active{
      color: var(--ink);
      border-color: var(--brand);
      box-shadow: 0 1px 0 rgba(11,99,206,.08);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h3 class="m-0">Manager Payroll</h3>
      <div class="small text-muted">{{ manager_name }}</div>
    </div>

    <div class="toolbar mt-3">
      <div class="group">
        <div>
          <div class="small text-muted">Month</div>
          <input type="month" class="form-control form-control-sm" id="monthSelect" value="{{ today_iso[:7] }}">
        </div>
        <div>
          <div class="small text-muted">Status</div>
          <span class="badge text-bg-light border" id="statusBadge">Draft</span>
        </div>
      </div>

      <div class="group">
        <div>
          <div class="small text-muted">Search</div>
          <input class="form-control form-control-sm" id="searchInput" placeholder="Search name or branch">
        </div>
        <button class="btn btn-sm btn-outline-secondary" id="btnSave" data-auto-spinner="1">
          <i class="bi bi-cloud-arrow-up me-1"></i>Save Draft
        </button>
        <button class="btn btn-sm btn-success" id="btnSubmit" data-auto-spinner="1">
          <i class="bi bi-send-check me-1"></i>Submit
        </button>
      </div>
    </div>

    <div class="tab-strip">
      <button class="tab-btn active" data-tab="section-payroll" data-auto-spinner="1">Payroll</button>
      <button class="tab-btn" data-tab="section-manual" data-auto-spinner="1">Manual Payroll</button>
      <button class="tab-btn" data-tab="section-deductions" data-auto-spinner="1">Deduction History</button>
    </div>

    <div id="section-payroll">
    <div class="summary mt-3">
      <div class="row align-items-center">
        <div class="col-12 col-lg-8">
          <div class="d-flex flex-wrap gap-3">
            <div class="item">Month: <b id="sumMonth">N/A</b></div>
            <div class="item">Submitted: <b class="mono" id="sumSubmitted">GHS 0.00</b></div>
            <div class="item">Final Gross: <b class="mono" id="sumFinal">GHS 0.00</b></div>
            <div class="item">Net: <b class="mono" id="sumNet">GHS 0.00</b></div>
            <div class="item">Agents: <b id="sumAgents">0</b></div>
            <div class="item">Edited: <b id="sumEdited">0</b></div>
          </div>
        </div>
        <div class="col-12 col-lg-4 d-flex gap-2 mt-2 mt-lg-0">
          <div class="mini flex-grow-1">
            <span>Top Paid:</span> <b id="topPaid">N/A</b>
          </div>
          <div class="mini flex-grow-1">
            <span>Lowest Paid:</span> <b id="lowPaid">N/A</b>
          </div>
        </div>
      </div>
    </div>

    <div class="table-wrap mt-3">
      <div style="max-height: 560px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Employee</th>
              <th class="text-end">Manager Amount</th>
              <th class="text-end">HR Final</th>
              <th class="text-end">Deductions</th>
              <th class="text-end">Net</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody id="payrollBody"></tbody>
        </table>
      </div>
    </div>
    </div>

    <div id="section-manual" style="display:none;">
      <div class="table-wrap mt-3">
        <div class="p-3 border-bottom">
          <div class="fw-semibold">Manual Payroll</div>
          <div class="small text-muted">Manual payroll entries are managed by HR.</div>
        </div>
        <div class="p-3 text-muted small">
          This section is read-only for managers.
        </div>
      </div>
    </div>

    <div id="section-deductions" style="display:none;">
      <div class="table-wrap mt-3">
        <div class="p-3 border-bottom">
          <div class="fw-semibold">Deduction History</div>
          <div class="small text-muted">View deductions for agents in the selected month.</div>
        </div>
        <div class="p-3">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-5">
              <label class="small text-muted mb-1">Agent</label>
              <select class="form-select form-select-sm" id="dedViewEmployee">
                <option value="">Select agent</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="small text-muted mb-1">Month</label>
              <input class="form-control form-control-sm" id="dedViewMonth" readonly>
            </div>
            <div class="col-12 col-md-4">
              <div class="small text-muted mb-1">Total Deductions</div>
              <div class="fw-semibold mono" id="dedViewTotal">GHS 0.00</div>
            </div>
          </div>
          <div class="mt-3" id="dedViewList">No deductions selected.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:2000;">
    <div class="toast" id="appToast">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Ready</div>
        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const monthSelect = document.getElementById("monthSelect");
    const statusBadge = document.getElementById("statusBadge");
    const searchInput = document.getElementById("searchInput");
    const btnSave = document.getElementById("btnSave");
    const btnSubmit = document.getElementById("btnSubmit");

    const sumMonth = document.getElementById("sumMonth");
    const sumSubmitted = document.getElementById("sumSubmitted");
    const sumFinal = document.getElementById("sumFinal");
    const sumNet = document.getElementById("sumNet");
    const sumAgents = document.getElementById("sumAgents");
    const sumEdited = document.getElementById("sumEdited");
    const topPaid = document.getElementById("topPaid");
    const lowPaid = document.getElementById("lowPaid");

    const payrollBody = document.getElementById("payrollBody");
    const dedViewEmployee = document.getElementById("dedViewEmployee");
    const dedViewMonth = document.getElementById("dedViewMonth");
    const dedViewTotal = document.getElementById("dedViewTotal");
    const dedViewList = document.getElementById("dedViewList");

    const toastEl = document.getElementById("appToast");
    const toastMsg = document.getElementById("toastMsg");
    const toast = new bootstrap.Toast(toastEl, {delay: 2200});

    let STATE = {
      month: "",
      rows: [],
      editable: false,
      payroll: null
    };

    function notify(msg){ toastMsg.innerText = msg; toast.show(); }
    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
    function money(n){ try{ return "GHS " + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }catch(e){ return "GHS " + Number(n||0).toFixed(2); } }
    function setBtnLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading) {
        if (btn.dataset.loading === "1") return;
        btn.dataset.loading = "1";
        btn.disabled = true;
        const spin = document.createElement("span");
        spin.className = "spinner-border spinner-border-sm ms-2 btn-spin";
        spin.setAttribute("role", "status");
        spin.setAttribute("aria-hidden", "true");
        btn.appendChild(spin);
      } else {
        btn.dataset.loading = "0";
        btn.disabled = false;
        const spin = btn.querySelector(".btn-spin");
        if (spin) spin.remove();
      }
    }

    function setActiveTab(targetId){
      const tabs = document.querySelectorAll(".tab-btn");
      tabs.forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === targetId));
      const sections = ["section-payroll", "section-manual", "section-deductions"];
      sections.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = (id === targetId) ? "" : "none";
      });
      const target = document.getElementById(targetId);
      if (target) target.scrollIntoView({behavior: "smooth", block: "start"});
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      if (btn.classList.contains("btn-close")) return;
      if (!btn.dataset.autoSpinner) return;
      if (btn.dataset.loading === "1") return;
      setBtnLoading(btn, true);
      setTimeout(() => setBtnLoading(btn, false), 700);
    });

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");
        if (target) setActiveTab(target);
      });
    });

    function renderSkeleton(){
      payrollBody.innerHTML = `<tr><td colspan="6" class="py-4">
        <div class="d-flex align-items-center gap-2 text-muted">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>Please wait...</span>
        </div>
      </td></tr>`;
    }

    function renderRows(){
      const q = (searchInput.value || "").toLowerCase().trim();
      const rows = STATE.rows.filter(r => {
        if(!q) return true;
        return String(r.agent_name||"").toLowerCase().includes(q) || String(r.agent_branch||"").toLowerCase().includes(q);
      });

      if(!rows.length){
        payrollBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No payroll rows found.</td></tr>`;
        return;
      }

      payrollBody.innerHTML = rows.map(r => {
        const dedTotal = Number(r.item_deductions_total || 0) + Number(r.global_deductions_total || 0);
        const hrFinal = (r.hr_amount === null || r.hr_amount === undefined || r.hr_amount === "") ? r.manager_amount : r.hr_amount;

        return `
          <tr>
            <td>
              <div class="fw-semibold">${esc(r.agent_name || "Agent")}</div>
              <div class="small text-muted">${esc(r.agent_branch || "")}</div>
            </td>
            <td class="text-end mono">
              <input class="form-control form-control-sm text-end" data-agent="${esc(r.agent_id)}" data-field="amount"
                value="${Number(r.manager_amount || 0).toFixed(2)}" ${STATE.editable ? "" : "disabled"}>
            </td>
            <td class="text-end mono">${money(hrFinal || 0)}</td>
            <td class="text-end mono">${money(dedTotal)}</td>
            <td class="text-end fw-semibold mono">${money(r.net_pay || 0)}</td>
            <td>
              <input class="form-control form-control-sm" data-agent="${esc(r.agent_id)}" data-field="note"
                value="${esc(r.manager_note || "")}" ${STATE.editable ? "" : "disabled"}>
            </td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("[data-field='amount']").forEach(inp => {
        inp.addEventListener("input", () => {
          const aid = inp.dataset.agent;
          const row = STATE.rows.find(x => x.agent_id === aid);
          if(row){ row.manager_amount = Number(inp.value || 0); }
        });
      });

      document.querySelectorAll("[data-field='note']").forEach(inp => {
        inp.addEventListener("input", () => {
          const aid = inp.dataset.agent;
          const row = STATE.rows.find(x => x.agent_id === aid);
          if(row){ row.manager_note = inp.value || ""; }
        });
      });
    }

    function renderDeductionViewer(){
      if (!dedViewEmployee || !dedViewList) return;
      if (dedViewMonth) dedViewMonth.value = STATE.month || "";
      const rows = STATE.rows || [];
      const current = dedViewEmployee.value || "";

      dedViewEmployee.innerHTML = `<option value="">Select agent</option>` + rows.map(r =>
        `<option value="${esc(r.agent_id)}">${esc(r.agent_name || "Agent")}</option>`
      ).join("");

      if (!current) {
        dedViewList.innerText = "No deductions selected.";
        if (dedViewTotal) dedViewTotal.innerText = "GHS 0.00";
        return;
      }

      const row = rows.find(r => r.agent_id === current);
      const deds = (row && row.deductions) ? row.deductions : [];
      if (!deds.length) {
        dedViewList.innerText = "No deductions found.";
        if (dedViewTotal) dedViewTotal.innerText = "GHS 0.00";
        return;
      }

      const total = deds.reduce((sum, d) => sum + Number(d.amount || 0), 0);
      if (dedViewTotal) dedViewTotal.innerText = money(total);
      dedViewList.innerHTML = deds.map(d => (
        `<div class="d-flex justify-content-between border-bottom py-1">
          <div>${esc(d.reason || "Deduction")}</div>
          <div class="mono">${money(d.amount || 0)}</div>
        </div>`
      )).join("");
    }

    function updateSummary(){
      const rows = STATE.rows || [];
      let submitted = 0;
      let final = 0;
      let net = 0;
      let edited = 0;

      rows.forEach(r => {
        submitted += Number(r.manager_amount || 0);
        final += Number(r.gross_final || 0);
        net += Number(r.net_pay || 0);
        if (r.changed_by_hr) edited += 1;
      });

      sumMonth.innerText = STATE.month || "N/A";
      sumSubmitted.innerText = money(submitted);
      sumFinal.innerText = money(final);
      sumNet.innerText = money(net);
      sumAgents.innerText = rows.length;
      sumEdited.innerText = edited;

      const sorted = rows.slice().sort((a,b) => Number(b.net_pay||0) - Number(a.net_pay||0));
      const top = sorted[0];
      const low = sorted[sorted.length - 1];
      topPaid.innerText = top ? `${top.agent_name} - ${money(top.net_pay)}` : "N/A";
      lowPaid.innerText = low ? `${low.agent_name} - ${money(low.net_pay)}` : "N/A";
    }

    function setStatus(status){
      statusBadge.innerText = status || "Draft";
    }

    async function loadMonth(month){
      if(!month) return;
      STATE.month = month;
      renderSkeleton();

      const res = await fetch(`/manager/payroll/month/${encodeURIComponent(month)}`);
      const data = await res.json();
      if(!data.ok){
        payrollBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">${esc(data.message || "Failed to load.")}</td></tr>`;
        return;
      }

      STATE.rows = data.rows || [];
      STATE.editable = data.editable;
      STATE.payroll = data.payroll || null;

      setStatus(data.payroll?.status || "Draft");
      btnSave.disabled = !STATE.editable;
      btnSubmit.disabled = !STATE.editable;

      updateSummary();
      renderRows();
      renderDeductionViewer();
    }

    async function saveDraft(){
      if(!STATE.month) return notify("Select a month first.");
      if(!STATE.editable) return notify("Payroll is locked.");

      const payload = {
        month: STATE.month,
        items: (STATE.rows || []).map(r => ({
          agent_id: r.agent_id,
          agent_name: r.agent_name,
          agent_image_url: r.agent_image_url,
          agent_branch: r.agent_branch,
          manager_amount: Number(r.manager_amount || 0),
          manager_note: r.manager_note || ""
        }))
      };

      setBtnLoading(btnSave, true);
      try {
        const res = await fetch(`/manager/payroll/save`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!data.ok) return notify(data.message || "Save failed.");

        notify("Draft saved.");
        await loadMonth(STATE.month);
      } finally {
        setBtnLoading(btnSave, false);
      }
    }

    async function submitPayroll(){
      if(!STATE.month) return notify("Select a month first.");
      if(!STATE.editable) return notify("Payroll is locked.");

      setBtnLoading(btnSubmit, true);
      try {
        const res = await fetch(`/manager/payroll/submit`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({month: STATE.month})
        });
        const data = await res.json();
        if(!data.ok) return notify(data.message || "Submit failed.");

        notify("Payroll submitted to HR.");
        await loadMonth(STATE.month);
      } finally {
        setBtnLoading(btnSubmit, false);
      }
    }

    searchInput.addEventListener("input", renderRows);
    monthSelect.addEventListener("change", () => loadMonth(monthSelect.value));
    btnSave.addEventListener("click", saveDraft);
    btnSubmit.addEventListener("click", submitPayroll);
    if (dedViewEmployee) {
      dedViewEmployee.addEventListener("change", renderDeductionViewer);
    }

    (async function init(){
      STATE.month = monthSelect.value;
      await loadMonth(STATE.month);
    })();
  </script>
  {% include 'app_footer.html' %}

</body>
</html>

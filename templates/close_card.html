<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Close Card – Smart Living</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="icon"
          href="https://imagedelivery.net/h9fmMoa1o2c2P55TcWJGOg/10283f28-b9a0-4100-b254-19a854386800/public"
          type="image/png">
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#fff; --soft:#f8fafc; --brand:#0d6efd
    }
    body{ background:var(--soft); color:var(--ink) }
    .card{ border:1px solid var(--line); box-shadow:0 6px 18px rgba(2,6,23,.06) }
    .muted{ color:var(--muted) }
    .pill{ background:#e7f1ff; color:#0b63d1; border-radius:999px; padding:.2rem .6rem; font-size:.8rem }
    .prod-card{ cursor:pointer; transition:transform .1s ease }
    .prod-card:hover{ transform:translateY(-2px) }
    .selected{ outline:2px solid #0d6efd; outline-offset:2px }
    .totals small{ color:var(--muted) }
    .totals .v{ font-weight:700 }
    .btn-wide{ min-width: 220px }
    .search-empty{ color:var(--muted); font-style:italic }
    .suggest-img{ width:56px; height:56px; border-radius:10px; object-fit:cover; background:#f1f1f1 }
    @media (prefers-reduced-motion: reduce){ .prod-card{ transition:none } }
  </style>
</head>
<body>
    {% if session.get('manager_id') %}
      {% include 'manager_sidebar.html' %}
    {% else %}
      {% include 'side_bar.html' %}
    {% endif %}

<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-2 mb-0">Close Card</h3>
    <span class="pill">
      {% if session.get('manager_id') %}Manager{% else %}Agent{% endif %}
    </span>
  </div>

  <!-- Search -->
  <div class="card p-3 mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-12 col-md-8">
        <label class="form-label mb-1">Search customer by name or phone</label>
        <input id="q" class="form-control form-control-lg" placeholder="e.g. Gifty or 0503..." autocomplete="off"/>
      </div>
      <div class="col-12 col-md-4 d-grid">
        <button id="btnSearch" class="btn btn-primary btn-lg">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
    </div>
    <div id="searchSpinner" class="d-none mt-2">
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      <span class="small muted">Searching customers...</span>
    </div>
    <div class="small muted mt-2">Only your customers are searchable (session-scoped).</div>
  </div>

  <!-- Results -->
  <div id="results"></div>

  <!-- Close panel -->
  <div id="closePanel" class="card p-3 mt-3 d-none">
    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <label class="form-label">Product to stop</label>
        <select id="prodSelect" class="form-select form-select-lg"></select>
      </div>

      <div class="col-12 col-lg-6 totals">
        <div class="row g-2">
          <div class="col-6">
            <div class="form-label">
              Amount Kept <small class="text-muted">(default 2/3 of paid)</small>
            </div>
            <div class="input-group">
              <span class="input-group-text">GHS</span>
              <input
                id="twoThirds"
                type="number"
                step="0.01"
                min="0"
                class="form-control form-control-lg bg-light"
                placeholder="0.00"
              />
            </div>
          </div>
          <div class="col-6">
            <div class="form-label">
              Forfeited Amount <small class="text-muted">(default 1/3)</small>
            </div>
            <div class="input-group">
              <span class="input-group-text">GHS</span>
              <input
                id="oneThird"
                type="number"
                step="0.01"
                min="0"
                class="form-control form-control-lg bg-light"
                placeholder="0.00"
              />
            </div>
          </div>
        </div>
        <div class="small muted mt-1">
          You can manually adjust these amounts. Total kept + forfeited cannot exceed what the customer has paid on this card.
        </div>
      </div>

      <div class="col-12 d-flex gap-2">
        <button id="btnSuggest" class="btn btn-outline-primary btn-wide" disabled>
          <i class="bi bi-lightbulb"></i> Suggest Products
        </button>
        <button id="btnClose" class="btn btn-danger btn-wide" disabled>
          <i class="bi bi-x-octagon"></i> Close Card
        </button>
        <div id="execMsg" class="ms-2 small"></div>
      </div>
    </div>
  </div>

  <!-- Suggestions -->
  <div id="suggestionsWrap" class="card p-3 mt-3 d-none">
    <h6 class="mb-3">Products you can buy with the budget</h6>
    <input id="suggestFilter" class="form-control mb-2" placeholder="Search product by name..."/>
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <div class="small text-muted">Selected total: <span id="selectedTotal">GHS 0.00</span></div>
      <div class="small text-muted">Budget: <span id="selectedBudget">GHS 0.00</span></div>
      <div class="small text-danger" id="selectedError"></div>
      <div class="ms-auto d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="prevPage" disabled>Prev</button>
        <span class="small text-muted" id="pageInfo">Page 1</span>
        <button class="btn btn-outline-secondary btn-sm" id="nextPage" disabled>Next</button>
      </div>
    </div>
    <div id="suggestions"></div>
    <div class="mt-3" id="selectionWrap">
      <h6 class="mb-2">Selected Products</h6>
      <div id="selectedList" class="small text-muted">No selections yet.</div>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="confirmLabel">Confirm Close</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="btnConfirm" class="btn btn-danger">Yes, Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let current = null; // {customer_id, name, phone_number, purchases[]}
  let picks = { product_index: null, target_product_ids: [] };
  let lastTotalPaid = 0; // total paid on selected product (from suggest API)
  let lastSuggestions = [];
  let lastBudget = 0;
  let syncLock = false;
  let suggestTimer = null;
  let currentPage = 1;
  let totalPages = 1;
  let selectedMap = {};

  const fmt = v => 'GHS ' + Number(v||0).toFixed(2);

  const $q = document.getElementById('q');
  const $btnSearch = document.getElementById('btnSearch');
  const $results = document.getElementById('results');
  const $panel = document.getElementById('closePanel');
  const $prod = document.getElementById('prodSelect');
  const $two = document.getElementById('twoThirds');
  const $one = document.getElementById('oneThird');
  const $btnSuggest = document.getElementById('btnSuggest');
  const $btnClose = document.getElementById('btnClose');
  const $execMsg = document.getElementById('execMsg');
  const $searchSpinner = document.getElementById('searchSpinner');

  const $sWrap = document.getElementById('suggestionsWrap');
  const $sugs = document.getElementById('suggestions');
  const $sFilter = document.getElementById('suggestFilter');
  const $selectedTotal = document.getElementById('selectedTotal');
  const $selectedBudget = document.getElementById('selectedBudget');
  const $selectedError = document.getElementById('selectedError');
  const $selectedList = document.getElementById('selectedList');
  const $prevPage = document.getElementById('prevPage');
  const $nextPage = document.getElementById('nextPage');
  const $pageInfo = document.getElementById('pageInfo');
  const $selectionWrap = document.getElementById('selectionWrap');

  async function searchCustomers(){
    const q = $q.value.trim();
    $results.innerHTML = ''; $panel.classList.add('d-none'); $sWrap.classList.add('d-none');
    current = null; picks = {product_index:null, target_product_ids:[]};
    lastTotalPaid = 0;
    lastBudget = 0;
    lastSuggestions = [];
    $sFilter.value = '';
    selectedMap = {};
    if(!q) return;
    $btnSearch.disabled = true;
    $searchSpinner.classList.remove('d-none');
    try {
      const res = await fetch(`/close_card/search_customers?q=${encodeURIComponent(q)}`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const data = await res.json();
      if(!data.ok){
        $results.innerHTML = `<div class="alert alert-danger">${data.message||'Search failed'}</div>`;
        return;
      }
      if(!data.results.length){
        $results.innerHTML = `<div class="text-muted fst-italic">No customers found.</div>`;
        return;
      }

      const html = data.results.map((c, i)=>{
        const pic = c.image_url
          ? `<img src="${c.image_url}" class="rounded me-3" style="width:56px;height:56px;object-fit:cover">`
          : `<div class="rounded me-3 bg-light" style="width:56px;height:56px"></div>`;
        const prods = c.purchases.map(p=>`${p.name} Aú Paid ${fmt(p.paid)} / Total ${fmt(p.total)}`).join('<br>');
        return `
          <div class="card p-3 mb-2">
            <div class="d-flex align-items-center">
              ${pic}
              <div class="flex-grow-1">
                <div><strong>${c.name}</strong> <span class="text-muted">${c.phone_number||''}</span></div>
                <div class="small muted mt-1">${prods || 'No purchases'}</div>
              </div>
              <div><button class="btn btn-outline-primary btn-sm" data-pick="${i}"><i class="bi bi-check2-circle"></i> Select</button></div>
            </div>
          </div>`;
      }).join('');
      $results.innerHTML = html;

      $results.querySelectorAll('[data-pick]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = Number(btn.getAttribute('data-pick'));
          current = data.results[i];
          hydrateUI(current);
          $btnClose.scrollIntoView({behavior: 'smooth', block: 'center'});
        });
      });
    } finally {
      $btnSearch.disabled = false;
      $searchSpinner.classList.add('d-none');
    }
  }

  function hydrateUI(cust){
    const opts = cust.purchases.map((p,i)=>`<option value="${i}">${p.name} — Paid ${fmt(p.paid)} / Total ${fmt(p.total)}</option>`).join('');
    $prod.innerHTML = `<option value="" disabled selected>Choose product to stop</option>` + opts;
    $panel.classList.remove('d-none');
    $two.value = '';
    $one.value = '';
    $btnSuggest.disabled = true;
    $btnClose.disabled = true;
    $sWrap.classList.add('d-none');
    $execMsg.innerHTML = '';
    picks = {product_index:null, target_product_ids:[]};
    lastTotalPaid = 0;
    lastBudget = 0;
    lastSuggestions = [];
    $sFilter.value = '';
    currentPage = 1;
    totalPages = 1;
    selectedMap = {};
    renderSelected();

    $prod.onchange = async ()=>{
      const idx = Number($prod.value);
      picks.product_index = Number.isNaN(idx) ? null : idx;
      $btnSuggest.disabled = (picks.product_index === null);
      $btnClose.disabled = (picks.product_index === null);
      $sWrap.classList.add('d-none');
      $execMsg.innerHTML = '';

      if (picks.product_index !== null) {
        await fetchSuggestions();
      }
    };
  }

  async function fetchSuggestions(budgetOverride, pageOverride){
    if (!current || picks.product_index === null) return;
    const budgetParam = (typeof budgetOverride === 'number' && !Number.isNaN(budgetOverride))
      ? `&budget=${encodeURIComponent(budgetOverride.toFixed(2))}` : '';
    const pageParam = pageOverride ? `&page=${encodeURIComponent(pageOverride)}` : '';
    const url = `/close_card/suggest_products?customer_id=${encodeURIComponent(current.customer_id)}&product_index=${picks.product_index}${budgetParam}${pageParam}&limit=20`;
    const res = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    const data = await res.json();
    if(!data.ok){
      $two.value = '';
      $one.value = '';
      lastTotalPaid = 0;
      lastBudget = 0;
      lastSuggestions = [];
      currentPage = 1;
      totalPages = 1;
      renderPagination();
      return;
    }
    lastTotalPaid = Number(data.total_paid || 0);
    $two.value = Number(data.budget || 0).toFixed(2);
    $one.value = Number(data.forfeited || 0).toFixed(2);
    currentPage = Number(data.page || 1);
    totalPages = Number(data.total_pages || 1);
    // Preload suggestions area (without forcing display yet)
    renderSuggestions(data);
  }

  function syncAmounts(source){
    if (syncLock) return;
    syncLock = true;
    const total = Number(lastTotalPaid || 0);
    let kept = parseFloat($two.value || '0');
    let forfeited = parseFloat($one.value || '0');
    if (Number.isNaN(kept)) kept = 0;
    if (Number.isNaN(forfeited)) forfeited = 0;

    if (total <= 0) {
      kept = 0;
      forfeited = 0;
    } else if (source === 'kept') {
      kept = Math.max(0, Math.min(kept, total));
      forfeited = Math.max(0, total - kept);
    } else if (source === 'forfeited') {
      forfeited = Math.max(0, Math.min(forfeited, total));
      kept = Math.max(0, total - forfeited);
    }

    $two.value = kept.toFixed(2);
    $one.value = forfeited.toFixed(2);
    syncLock = false;

    scheduleSuggestRefresh(kept);
  }

  function scheduleSuggestRefresh(kept){
    if (picks.product_index === null) return;
    if (suggestTimer) clearTimeout(suggestTimer);
    suggestTimer = setTimeout(() => {
      fetchSuggestions(kept, 1);
      $sWrap.classList.remove('d-none');
    }, 350);
  }

  function renderSuggestions(data){
    if(!data || !Array.isArray(data.suggestions)) return;
    lastSuggestions = data.suggestions;
    lastBudget = Number(data.budget || 0);
    $selectedBudget.textContent = fmt(lastBudget);
    applySuggestionFilter(lastBudget);
    renderPagination();
  }

  function applySuggestionFilter(budget){
    const term = ($sFilter.value || '').trim().toLowerCase();
    const rowsData = lastSuggestions.filter(s => !term || String(s.name || '').toLowerCase().includes(term));
    if(!rowsData.length){
      $sugs.innerHTML = `<div class="text-muted">No products fit the budget (${fmt(budget)}).</div>`;
      return;
    }
    const rows = rowsData.map(s=>{
      const img = s.image_url ? `<img src="${s.image_url}" class="suggest-img me-2">` : `<div class="suggest-img me-2"></div>`;
      const checked = selectedMap[s._id] ? 'checked' : '';
      const qtyVal = selectedMap[s._id]?.qty || 1;
      return `
        <label class="list-group-item d-flex align-items-center">
          <input class="form-check-input me-2" type="checkbox" name="suggestPick" value="${s._id}" ${checked}>
          ${img}
          <div>
            <div><strong>${s.name}</strong></div>
            <div class="small text-muted">${s.category||''}</div>
            <div class="small text-muted">Qty: ${Number.isFinite(s.qty) ? s.qty : (s.qty ?? 'N/A')}</div>
          </div>
          <div class="ms-auto fw-bold">${fmt(s.price)}</div>
          <input class="form-control form-control-sm ms-2" style="width:90px" min="1" step="1" type="number" value="${qtyVal}" data-qty="${s._id}" ${checked ? '' : 'disabled'}>
        </label>`;
    }).join('');
    $sugs.innerHTML = `<div class="list-group">${rows}</div>`;
    $sugs.querySelectorAll('input[name="suggestPick"]').forEach(r=>{
      r.addEventListener('change', ()=> handlePickChange(r.value, r.checked));
    });
    $sugs.querySelectorAll('input[data-qty]').forEach(inp=>{
      inp.addEventListener('input', ()=> handleQtyChange(inp.getAttribute('data-qty'), inp.value));
    });
  }

  function selectedTotal(){
    return Object.values(selectedMap).reduce((acc, it) => acc + (Number(it.price || 0) * Number(it.qty || 0)), 0);
  }

  function handlePickChange(id, checked){
    const item = lastSuggestions.find(s => s._id === id);
    const price = Number(item?.price || 0);
    const total = selectedTotal();
    const nextTotal = checked ? (total + price) : (total - price);
    if (checked && nextTotal > (lastBudget + 0.01)) {
      $selectedError.textContent = 'Selection exceeds budget.';
      setTimeout(() => { $selectedError.textContent = ''; }, 1500);
      return;
    }
    if (checked) {
      if (!picks.target_product_ids.includes(id)) picks.target_product_ids.push(id);
      if (item) selectedMap[id] = { _id: item._id, name: item.name, price: item.price, qty: selectedMap[id]?.qty || 1 };
    } else {
      picks.target_product_ids = picks.target_product_ids.filter(pid => pid !== id);
      delete selectedMap[id];
    }
    const qtyInput = $sugs.querySelector(`input[data-qty="${id}"]`);
    if (qtyInput) qtyInput.disabled = !checked;
    renderSelected();
    $selectionWrap.scrollIntoView({behavior: 'smooth', block: 'start'});
  }

  function handleQtyChange(id, rawQty){
    const item = selectedMap[id];
    if (!item) return;
    let qty = parseInt(rawQty, 10);
    if (Number.isNaN(qty) || qty < 1) qty = 1;

    const total = selectedTotal();
    const currentItemTotal = Number(item.price || 0) * Number(item.qty || 0);
    const maxAvailable = lastBudget - (total - currentItemTotal);
    const maxQty = Number(item.price || 0) > 0 ? Math.max(1, Math.floor(maxAvailable / Number(item.price || 0))) : qty;

    if ((Number(item.price || 0) * qty) > maxAvailable + 0.01) {
      qty = maxQty;
      $selectedError.textContent = 'Quantity adjusted to fit budget.';
      setTimeout(() => { $selectedError.textContent = ''; }, 1500);
    }

    item.qty = qty;
    const qtyInput = $sugs.querySelector(`input[data-qty="${id}"]`);
    if (qtyInput) qtyInput.value = qty;
    renderSelected();
  }

  function renderSelected(){
    const items = Object.values(selectedMap);
    const total = items.reduce((acc, it) => acc + (Number(it.price || 0) * Number(it.qty || 0)), 0);
    $selectedTotal.textContent = fmt(total);
    $selectedBudget.textContent = fmt(lastBudget);
    if (!items.length) {
      $selectedList.textContent = 'No selections yet.';
      return;
    }
    $selectedList.innerHTML = items.map(it => `<div>${it.name} - ${it.qty} x ${fmt(it.price)}</div>`).join('');
  }

  function renderPagination(){
    $pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    $prevPage.disabled = (currentPage <= 1);
    $nextPage.disabled = (currentPage >= totalPages);
  }

  document.getElementById('btnSuggest').addEventListener('click', async ()=>{
    if(!current || picks.product_index===null) return;
    const kept = parseFloat($two.value || '0');
    await fetchSuggestions(Number.isNaN(kept) ? undefined : kept, currentPage);
    $sWrap.classList.remove('d-none');
  });

  // Close with confirm
  document.getElementById('btnClose').addEventListener('click', async ()=>{
    if(!current || picks.product_index===null) return;

    const kept = Number.parseFloat($two.value || '0');
    const forfeited = Number.parseFloat($one.value || '0');
    const selectedTotalValue = selectedTotal();

    if (Number.isNaN(kept) || Number.isNaN(forfeited) || kept < 0 || forfeited < 0) {
      $execMsg.innerHTML = '<span class="text-danger">Enter valid non-negative amounts for kept and forfeited.</span>';
      return;
    }
    if (lastTotalPaid > 0 && (kept + forfeited) > (lastTotalPaid + 0.01)) {
      $execMsg.innerHTML = `<span class="text-danger">Kept + forfeited (${fmt(kept+forfeited)}) cannot exceed total paid on this card (${fmt(lastTotalPaid)}).</span>`;
      return;
    }
    if (selectedTotalValue > (kept + 0.01)) {
      $execMsg.innerHTML = `<span class="text-danger">Selected products total (${fmt(selectedTotalValue)}) exceeds kept amount (${fmt(kept)}).</span>`;
      return;
    }

    const body = `
      <div class="mb-2"><strong>Customer:</strong> ${current.name} <span class="text-muted">(${current.phone_number||''})</span></div>
      <div class="mb-2"><strong>Stopping:</strong> ${current.purchases[picks.product_index].name}</div>
      <div class="mb-2"><strong>Amount kept:</strong> ${fmt(kept)}</div>
      <div class="mb-2"><strong>Forfeited amount:</strong> ${fmt(forfeited)}</div>
      <div class="small text-muted">This keeps the customer and payments and marks only this product as closed.</div>`;
    document.getElementById('confirmBody').innerHTML = body;
    const modal = new bootstrap.Modal('#confirmModal'); modal.show();
    document.getElementById('btnConfirm').onclick = async ()=>{
      modal.hide();
      await executeClose(kept, forfeited);
    };
  });

  async function executeClose(kept, forfeited){
    $execMsg.innerHTML = '<span class="text-muted">Processing…</span>';
    const payload = {
      customer_id: current.customer_id,
      product_index: picks.product_index,
      note: '',
      target_products: Object.values(selectedMap).map(it => ({ id: it._id, qty: it.qty })),
      two_thirds_budget: kept,
      one_third_forfeited: forfeited
    };
    const res = await fetch('/close_card/execute', {
      method:'POST',
      headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!data.ok){
      $execMsg.innerHTML = `<span class="text-danger">${data.message||'Failed.'}</span>`;
      return;
    }
    $execMsg.innerHTML = `<span class="text-success"><i class="bi bi-check2-circle"></i> ${data.message}</span>`;
    // Reset UI
    current = null; picks = {product_index:null, target_product_ids:[]};
    lastTotalPaid = 0;
    lastBudget = 0;
    lastSuggestions = [];
    currentPage = 1;
    totalPages = 1;
    selectedMap = {};
    document.getElementById('q').value = '';
    document.getElementById('results').innerHTML = '';
    document.getElementById('closePanel').classList.add('d-none');
    document.getElementById('suggestionsWrap').classList.add('d-none');
  }

  // Events
  $btnSearch.addEventListener('click', searchCustomers);
  $q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ searchCustomers(); } });
  $sFilter.addEventListener('input', ()=> applySuggestionFilter(lastBudget));
  $two.addEventListener('input', ()=> syncAmounts('kept'));
  $one.addEventListener('input', ()=> syncAmounts('forfeited'));
  $prevPage.addEventListener('click', async ()=>{
    if (currentPage <= 1) return;
    const kept = parseFloat($two.value || '0');
    await fetchSuggestions(Number.isNaN(kept) ? undefined : kept, currentPage - 1);
    applySuggestionFilter(lastBudget);
  });
  $nextPage.addEventListener('click', async ()=>{
    if (currentPage >= totalPages) return;
    const kept = parseFloat($two.value || '0');
    await fetchSuggestions(Number.isNaN(kept) ? undefined : kept, currentPage + 1);
    applySuggestionFilter(lastBudget);
  });
</script>
  {% include 'app_footer.html' %}

</body>
</html>

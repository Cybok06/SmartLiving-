<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin - Customer Transfer Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --bg-color: #f5f7fb;
      --card-bg: #ffffff;
      --text-color: #111827;
      --muted-color: #6b7280;
      --border-color: rgba(15, 23, 42, 0.08);
    }

    body.dark-mode {
      --bg-color: #020617;
      --card-bg: #0b1120;
      --text-color: #f9fafb;
      --muted-color: #9ca3af;
      --border-color: rgba(148, 163, 184, 0.3);
    }

    body {
      background: radial-gradient(circle at top left, #e0ecff 0, #f5f7fb 45%, #edf2ff 100%);
      color: var(--text-color);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body.dark-mode {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
    }

    .card {
      border-radius: .9rem;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }

    .card-header {
      border-bottom: 0;
      background: transparent;
      padding-bottom: .35rem;
      color: var(--text-color);
    }

    .text-muted {
      color: var(--muted-color) !important;
    }

    .badge-soft {
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 600;
      background: rgba(59,130,246,.08);
      color: #1d4ed8;
    }

    body.dark-mode .badge-soft {
      background: rgba(59,130,246,.22);
      color: #bfdbfe;
    }

    .table,
    .table th,
    .table td {
      color: var(--text-color);
    }

    .table-light {
      background-color: rgba(148, 163, 184, 0.15) !important;
      color: var(--text-color) !important;
    }

    body.dark-mode .table-light {
      background-color: rgba(15, 23, 42, 0.9) !important;
      color: var(--text-color) !important;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      padding: .18rem .6rem;
      border-radius: 999px;
      font-size: .72rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted-color);
    }

    .chip i {
      font-size: .8rem;
    }

    .role-pill {
      display: inline-flex;
      align-items: center;
      padding: .12rem .5rem;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 500;
    }

    .role-admin {
      background-color: rgba(59,130,246,.12);
      color: #1d4ed8;
    }

    .role-manager {
      background-color: rgba(16,185,129,.12);
      color: #047857;
    }

    .role-executive {
      background-color: rgba(234,179,8,.12);
      color: #92400e;
    }

    .fade-soft {
      animation: fadeSoft .3s ease-out;
    }

    @keyframes fadeSoft {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
      {% include 'admin_sidebar.html' %}

<div class="container-fluid py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0 fw-semibold">Admin - Customer Transfer Logs</h3>
      <small class="text-muted">
        Full history of customer transfers across all managers, agents and branches.
      </small>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a href="{{ url_for('admin_transfer_customer.admin_transfer_page') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to admin transfer
      </a>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleTheme()">
        <i id="themeIcon" class="bi bi-moon-stars"></i>
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Filters</span>
      <small class="text-muted">Narrow down logs by manager, agents, role or date range.</small>
    </div>
    <div class="card-body">
      <form class="row g-3 align-items-end" method="get">
        <div class="col-md-3">
          <label class="form-label">Manager</label>
          <select name="manager_id" class="form-select">
            <option value="">All managers</option>
            {% for m in managers %}
              <option value="{{ m.id }}" {% if filter_manager_id == m.id %}selected{% endif %}>
                {{ m.name }}{% if m.branch %} - {{ m.branch }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">From agent</label>
          <select name="from_agent_id" class="form-select">
            <option value="">Any</option>
            {% for a in agents %}
              <option value="{{ a.id }}" {% if filter_from_agent_id == a.id %}selected{% endif %}>
                {{ a.name }}{% if a.branch %} - {{ a.branch }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">To agent</label>
          <select name="to_agent_id" class="form-select">
            <option value="">Any</option>
            {% for a in agents %}
              <option value="{{ a.id }}" {% if filter_to_agent_id == a.id %}selected{% endif %}>
                {{ a.name }}{% if a.branch %} - {{ a.branch }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Performed by role</label>
          <select name="performed_by_role" class="form-select">
            <option value="">Any</option>
            <option value="admin" {% if filter_performed_by_role == 'admin' %}selected{% endif %}>Admin</option>
            <option value="manager" {% if filter_performed_by_role == 'manager' %}selected{% endif %}>Manager</option>
            <option value="executive" {% if filter_performed_by_role == 'executive' %}selected{% endif %}>Executive</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date from</label>
          <input type="date" name="date_from" class="form-control" value="{{ filter_date_from }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Date to</label>
          <input type="date" name="date_to" class="form-control" value="{{ filter_date_to }}">
        </div>

        <div class="col-md-6 text-md-end">
          <button type="submit" class="btn btn-primary me-2">
            <i class="bi bi-funnel me-1"></i> Apply filters
          </button>
          <a href="{{ url_for('admin_transfer_logs.admin_transfer_logs_page') }}" class="btn btn-outline-secondary">
            Clear
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Logs table -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Transfer history</span>
      <small class="text-muted">
        Showing {{ logs|length }} record(s).
      </small>
    </div>
    <div class="card-body">
      {% if not logs %}
        <div class="text-muted small">
          No logs found for the selected filters.
        </div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Date / Time</th>
                <th>From agent</th>
                <th>To agent</th>
                <th>Performed by</th>
                <th>Counts</th>
                <th>Customers (sample)</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
                <tr class="fade-soft">
                  <td>
                    <div class="fw-semibold">{{ log.performed_at_str }}</div>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ log.from_agent_name or '-' }}</div>
                    <div class="text-muted small">
                      {{ log.from_agent_branch or 'Branch: -' }}
                    </div>
                  </td>
                  <td>
                    <div class="fw-semibold">{{ log.to_agent_name or '-' }}</div>
                    <div class="text-muted small">
                      {{ log.to_agent_branch or 'Branch: -' }}
                    </div>
                  </td>
                  <td>
                    <div class="fw-semibold">
                      {{ log.performed_by_name or '-' }}
                    </div>
                    <div class="small mt-1">
                      {% set r = (log.performed_by_role or '').lower() %}
                      <span class="role-pill
                        {% if r == 'admin' %}role-admin{% elif r == 'manager' %}role-manager{% elif r == 'executive' %}role-executive{% endif %}">
                        {{ r|capitalize if r else 'Unknown' }}
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      <strong>{{ log.updated_customers }}</strong> updated
                      {% if log.selection_count is not none %}
                        / {{ log.selection_count }} selected
                      {% endif %}
                      <br>
                      <span class="text-muted">
                        Matched: {{ log.total_customers }}
                      </span>
                    </div>
                  </td>
                  <td>
                    <div class="small">
                      <strong>{{ log.customer_count }}</strong> customer(s)
                      {% if log.sample_customers %}
                        <br>
                        <span class="text-muted">
                          e.g. {{ log.sample_customers }}
                          {% if log.customer_count > 3 %}
                            &nbsp;and {{ log.customer_count - 3 }} moreâ€¦
                          {% endif %}
                        </span>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- JS: Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function toggleTheme(){
    const body = document.body;
    const isDark = body.classList.toggle("dark-mode");
    const icon = document.getElementById("themeIcon");
    if(icon){
      if(isDark){
        icon.classList.remove("bi-moon-stars");
        icon.classList.add("bi-sun");
      }else{
        icon.classList.remove("bi-sun");
        icon.classList.add("bi-moon-stars");
      }
    }
    try{
      localStorage.setItem("meetingTheme", isDark ? "dark" : "light");
    }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", () => {
    try{
      const saved = localStorage.getItem("meetingTheme");
      if(saved === "dark"){
        document.body.classList.add("dark-mode");
        const icon = document.getElementById("themeIcon");
        if(icon){
          icon.classList.remove("bi-moon-stars");
          icon.classList.add("bi-sun");
        }
      }
    }catch(e){}
  });
</script>
  {% include 'app_footer.html' %}

</body>
</html>

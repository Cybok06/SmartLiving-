<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Assign Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg">
  <style>
    body { background:#f7f8fa; color:#212529; }
    .page-header { position: sticky; top: 8px; z-index: 10; background:#f7f8fa; padding-bottom:.5rem; }
    .card { border:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(16,24,40,.04); }
    .table thead th { background:#0d6efd; color:#fff; }
    .badge-ok { background:#198754; }
    .badge-warn { background:#ffc107; color:#212529; }
    .form-note { font-size:.875rem; color:#6b7280; }
  </style>
</head>
<body>

  {% include 'inventory_sidebar.html' %}

  <main class="inv-content">
    <div class="inv-page">

      <!-- Header -->
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
          <h2 class="mb-2">Assign Products</h2>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-primary btn-sm"
               href="{{ url_for('assign.list_assignments',
                                export=1,
                                branch=request.args.get('branch',''),
                                manager_id=request.args.get('manager_id',''),
                                product_id=request.args.get('product_id',''),
                                q=request.args.get('q','')) }}">
              Export CSV
            </a>
          </div>
        </div>
      </div>

      {% if role in ['inventory','admin'] %}
      <!-- Assign form -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="mb-3">New / Additional Assignment</h5>
          <form class="row g-3" method="POST" action="{{ url_for('assign.create_or_increment_assignment') }}">
            <div class="col-12 col-md-4">
              <label class="form-label">Manager</label>
              <select name="manager_id" class="form-select" required>
                <option value="">Select manager…</option>
                {% for m in managers %}
                  <option value="{{ m._id }}">{{ m.name }} — {{ m.branch }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Product</label>
              <select name="product_id" class="form-select" required>
                <option value="">Select product…</option>
                {% for p in products %}
                  <option value="{{ p._id }}">{{ p.name }}{% if p.sku %} ({{ p.sku }}){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label">Quantity</label>
              <input type="number" name="qty" class="form-control" min="1" placeholder="e.g. 20" required>
            </div>
            <div class="col-12">
              <label class="form-label">Note <span class="form-note">(optional)</span></label>
              <input type="text" name="note" class="form-control" placeholder="Reason or memo">
            </div>
            <div class="col-12">
              <button class="btn btn-primary">Save Assignment</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

      <!-- Filters -->
      <div class="card mb-3">
        <div class="card-body">
          <form class="row g-2" method="GET" action="{{ url_for('assign.list_assignments') }}">
            <div class="col-12 col-md-3">
              <input type="text" name="q" class="form-control" placeholder="Search (manager/branch/product)"
                     value="{{ request.args.get('q','') }}">
            </div>
            {% if role in ['inventory','admin'] %}
              <div class="col-12 col-md-3">
                <select name="branch" class="form-select">
                  <option value="">All branches</option>
                  {% for b in branches %}
                    <option value="{{ b }}" {% if request.args.get('branch') == b %}selected{% endif %}>{{ b }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-3">
                <select name="manager_id" class="form-select">
                  <option value="">All managers</option>
                  {% for m in managers %}
                    <option value="{{ m._id }}" {% if request.args.get('manager_id') == m._id %}selected{% endif %}>{{ m.name }} — {{ m.branch }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            <div class="col-12 col-md-3">
              <select name="product_id" class="form-select">
                <option value="">All products</option>
                {% for p in products %}
                  <option value="{{ p._id }}" {% if request.args.get('product_id') == p._id %}selected{% endif %}>{{ p.name }}{% if p.sku %} ({{ p.sku }}){% endif %}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 d-flex gap-2 mt-1">
              <button class="btn btn-primary">Apply</button>
              <a class="btn btn-outline-secondary" href="{{ url_for('assign.list_assignments') }}">Reset</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Assignments table -->
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Branch</th>
                  <th>Manager</th>
                  <th>Product</th>
                  <th>SKU</th>
                  <th class="text-end">Assigned</th>
                  <th class="text-end">Sent</th>
                  <th class="text-end">Remaining</th>
                  <th>Updated</th>
                  {% if role in ['inventory','admin'] %}<th style="width: 220px;">Actions</th>{% endif %}
                </tr>
              </thead>
              <tbody>
                {% if assignments and assignments|length > 0 %}
                  {% for a in assignments %}
                    <tr>
                      <td>{{ loop.index }}</td>
                      <td>{{ a.manager_branch or '—' }}</td>
                      <td>{{ a.manager_name or '—' }}</td>
                      <td>{{ a.product_name or '—' }}</td>
                      <td>{{ a.product_sku or '—' }}</td>
                      <td class="text-end">{{ a.assigned_total or 0 }}</td>
                      <td class="text-end">{{ a.sent_total or 0 }}</td>
                      <td class="text-end">
                        {% if (a.remaining or 0) > 0 %}
                          <span class="badge badge-warn">{{ a.remaining }}</span>
                        {% else %}
                          <span class="badge badge-ok">0</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if a.updated_at %}{{ a.updated_at.strftime('%Y-%m-%d %H:%M') }}{% else %}—{% endif %}
                      </td>

                      {% if role in ['inventory','admin'] %}
                      <td>
                        <div class="d-flex flex-wrap gap-2">
                          <!-- Send -->
                          <button type="button" class="btn btn-success btn-sm"
                                  data-bs-toggle="modal"
                                  data-bs-target="#sendModal"
                                  data-id="{{ a._id }}"
                                  data-product="{{ a.product_name }}"
                                  data-manager="{{ a.manager_name }}"
                                  data-remaining="{{ a.remaining }}">
                            Send
                          </button>
                          <!-- History -->
                          <button type="button" class="btn btn-outline-secondary btn-sm"
                                  data-bs-toggle="modal"
                                  data-bs-target="#historyModal"
                                  data-id="{{ a._id }}">
                            History
                          </button>
                        </div>
                      </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="10" class="text-center py-4">No assignments yet.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Send Modal -->
      <div class="modal fade" id="sendModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <form class="modal-content" method="POST" action="{{ url_for('assign.send_from_assignment') }}">
            <div class="modal-header">
              <h5 class="modal-title">Send Units</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="assignment_id" id="send-assign-id">
              <div class="mb-2">
                <div class="small text-muted">Product:</div>
                <div id="send-product" class="fw-semibold">—</div>
              </div>
              <div class="mb-2">
                <div class="small text-muted">Manager:</div>
                <div id="send-manager" class="fw-semibold">—</div>
              </div>
              <div class="mb-3">
                <div class="small text-muted">Remaining available:</div>
                <div id="send-remaining" class="badge bg-info">0</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Quantity to send</label>
                <input type="number" min="1" class="form-control" name="send_qty" id="send-qty" required>
                <div class="form-text">Must be ≤ remaining.</div>
              </div>
              <div class="mb-1">
                <label class="form-label">Note <span class="form-note">(optional)</span></label>
                <input type="text" name="note" class="form-control" placeholder="Dispatch reference or memo">
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-success">Confirm Send</button>
            </div>
          </form>
        </div>
      </div>

      <!-- History Modal -->
      <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Assignment History</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="history-body" class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead>
                    <tr><th>#</th><th>Type</th><th>Qty</th><th>By</th><th>Time</th><th>Note</th></tr>
                  </thead>
                  <tbody id="history-rows">
                    <tr><td colspan="6" class="text-center py-3">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
    // Populate Send modal
    const sendModal = document.getElementById('sendModal');
    sendModal?.addEventListener('show.bs.modal', function (event) {
      const btn = event.relatedTarget;
      const id  = btn.getAttribute('data-id');
      const prod= btn.getAttribute('data-product');
      const mgr = btn.getAttribute('data-manager');
      const rem = parseInt(btn.getAttribute('data-remaining') || '0', 10);

      this.querySelector('#send-assign-id').value = id;
      this.querySelector('#send-product').textContent = prod || '—';
      this.querySelector('#send-manager').textContent = mgr || '—';
      this.querySelector('#send-remaining').textContent = rem;
      const qtyEl = this.querySelector('#send-qty');
      qtyEl.value = '';
      qtyEl.max = rem > 0 ? rem : 0;
    });

    // Load History modal
    const histModal = document.getElementById('historyModal');
    histModal?.addEventListener('show.bs.modal', function (event) {
      const btn = event.relatedTarget;
      const id  = btn.getAttribute('data-id');
      const tbody = this.querySelector('#history-rows');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">Loading…</td></tr>';

      fetch(`/assignments/history/${id}`)
        .then(r => r.json())
        .then(({history}) => {
          if (!history || !history.length){
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">No history.</td></tr>';
            return;
          }
          tbody.innerHTML = history.map((h, i) => `
            <tr>
              <td>${i+1}</td>
              <td>${h.type}</td>
              <td>${h.qty}</td>
              <td>${h.by}</td>
              <td>${h.at}</td>
              <td>${h.note || ''}</td>
            </tr>
          `).join('');
        })
        .catch(() => {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-danger">Failed to load.</td></tr>';
        });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

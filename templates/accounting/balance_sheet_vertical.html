<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Balance Sheet (Vertical) - TRUEtype Services</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link rel="icon"
          href="https://imagedelivery.net/h9fmMoa1o2c2P55TcWJGOg/10283f28-b9a0-4100-b254-19a854386800/public"
          type="image/png">
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          fontFamily: { display: ["Inter", "sans-serif"] },
          boxShadow: { soft: "0 6px 20px rgba(15,23,42,0.08)" }
        }
      }
    }
  </script>

  <style>
    @media print {
      #toolbar, #accSidebar, #accSidebarToggle, #accSidebarBackdrop { display:none !important; }
      body { background:#fff !important; }
      main { padding:0 !important; margin:0 !important; }
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-slate-950 font-display text-slate-900 dark:text-slate-100">
  {% include 'accounting/sidebar.html' %}

  <main class="min-h-screen p-4 sm:p-6 lg:p-10 acc-with-sidebar">
    <div class="mx-auto max-w-4xl">

      <!-- Toolbar -->
      <div id="toolbar" class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between mb-6">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Balance Sheet</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">
            Vertical format (like standard accounting statement layout).
          </p>
        </div>

        <div class="flex flex-wrap gap-2 sm:justify-end">
          <select id="sheetSelector"
                  class="rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 px-3 py-2 text-sm">
            <option value="">New sheet...</option>
          </select>

          <button id="btnSaveSheet"
                  class="rounded-lg bg-slate-900 text-white px-4 py-2 text-sm font-semibold hover:bg-slate-800">
            Save Sheet
          </button>

          <button id="btnExportCsv"
                  class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-2 text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-800">
            Export Excel
          </button>

          <button id="btnPrint"
                  class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 py-2 text-sm font-semibold hover:bg-slate-50 dark:hover:bg-slate-800">
            Print/PDF
          </button>
        </div>
      </div>

      <!-- Statement sheet -->
      <section class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-soft p-5 sm:p-7">
        <div class="text-center mb-4">
          <div class="font-bold text-lg sm:text-xl" id="coName">XYZ Ltd.</div>
          <div class="font-semibold" id="stmtTitle">Balance Sheet as at <span id="asAtText"></span></div>
        </div>

        <!-- Report View -->
        <div class="rounded-2xl bg-slate-50 dark:bg-slate-950/80 border border-slate-200 dark:border-slate-800 p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Report View</p>
              <p class="text-sm text-slate-600 dark:text-slate-300">Fixed/Non Current Assets (data-driven)</p>
            </div>
            <span class="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
              <span class="material-symbols-outlined text-base leading-none">sticky_note_2</span>
              Data from Fixed Assets register
            </span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-xs">
              <thead>
                <tr class="text-left text-slate-500 dark:text-slate-400 uppercase tracking-wide text-[11px]">
                  <th class="py-1 pr-2">Fixed/Non Current Assets</th>
                  <th class="py-1 px-2 text-right">GHA›</th>
                  <th class="py-1 px-2 text-right">GHA›</th>
                  <th class="py-1 pl-2 text-right">GHA›</th>
                </tr>
              </thead>
              <tbody>
                {% for category in fixed_asset_categories %}
                  <tr class="odd:bg-white even:bg-slate-50 dark:odd:bg-slate-900 dark:even:bg-slate-950">
                    <td class="py-1 pr-2 text-slate-800 dark:text-slate-100 pl-4">{{ category }}</td>
                    <td class="py-1 px-2 text-right text-slate-800 dark:text-slate-100 tabular-nums">
                      {{ "{:,.2f}".format(fixed_asset_totals.get(category, 0.0)) }}
                    </td>
                    <td class="py-1 px-2 text-right text-slate-800 dark:text-slate-100 tabular-nums"></td>
                    <td class="py-1 pl-2 text-right text-slate-800 dark:text-slate-100 tabular-nums"></td>
                  </tr>
                {% endfor %}
                <tr class="border-t border-slate-200 dark:border-slate-800">
                  <td class="py-2 pr-2 text-xs uppercase tracking-wide font-semibold text-slate-900 dark:text-slate-100">Total Fixed Assets</td>
                  <td class="py-2 px-2 text-right text-xs font-semibold text-slate-900 dark:text-slate-100"></td>
                  <td class="py-2 px-2 text-right text-xs font-semibold text-slate-900 dark:text-slate-100 tabular-nums">
                    {{ "{:,.2f}".format(fixed_asset_total) }}
                  </td>
                  <td class="py-2 pl-2 text-right text-xs font-semibold text-slate-900 dark:text-slate-100"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Meta -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-5">
          <div>
            <label class="text-xs text-slate-500">Sheet name</label>
            <input id="sheetName"
                   class="mt-1 w-full rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2 text-sm"
                   placeholder="e.g. Dec 2025"/>
          </div>
          <div>
            <label class="text-xs text-slate-500">As at</label>
            <input id="asOfDate" type="date"
                   value="{{ sheet.as_of_date or today }}"
                   class="mt-1 w-full rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2 text-sm"/>
          </div>
          <div>
            <label class="text-xs text-slate-500">Currency</label>
            <select id="currency"
                    class="mt-1 w-full rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2 text-sm">
              <option value="GHS">GHS</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="GBP">GBP</option>
            </select>
          </div>
        </div>

        <!-- Vertical table -->
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-slate-200 dark:border-slate-800">
                <th class="text-left py-2 pr-2 w-[55%]"></th>
                <th class="text-right py-2 px-2 w-[15%]" id="colAmt">GH¢</th>
                <th class="text-right py-2 px-2 w-[15%]">GH¢</th>
                <th class="text-right py-2 pl-2 w-[15%]">GH¢</th>
              </tr>
            </thead>
            <tbody id="stmtBody"></tbody>
          </table>
        </div>

        <!-- Hidden export form -->
        <form id="exportForm" method="POST" action="{{ url_for('acc_balance_sheet.balance_sheet_export_csv') }}" class="hidden">
          <input type="hidden" name="payload" id="exportPayload">
        </form>
      </section>

      <!-- hidden JSON -->
      <div id="balanceSheetData"
          data-sheet='{{ (sheet or {})|tojson|safe }}'
          data-sheets='{{ (sheet_options or [])|tojson|safe }}'
          data-fixed-asset-totals='{{ fixed_asset_totals|tojson|safe }}'
          data-fixed-asset-categories='{{ fixed_asset_categories|tojson|safe }}'
          data-current-asset-totals='{{ current_asset_totals|tojson|safe }}'
          data-current-asset-lines='{{ current_asset_lines|tojson|safe }}'
          data-current-liab-totals='{{ current_liab_totals|tojson|safe }}'
          data-current-liab-lines='{{ current_liab_lines|tojson|safe }}'
          data-equity-totals='{{ equity_totals|tojson|safe }}'
          data-equity-lines='{{ equity_lines|tojson|safe }}'
          data-lt-liab-totals='{{ lt_liab_totals|tojson|safe }}'
          data-lt-liab-lines='{{ lt_liab_lines|tojson|safe }}'
          data-total-fixed='{{ fixed_asset_total }}'
          data-total-cur-assets='{{ current_asset_total }}'
          data-total-cur-liab='{{ current_liab_total }}'
          data-working-capital='{{ working_capital }}'
          data-net-total-assets='{{ net_total_assets }}'
          data-total-equity='{{ equity_total }}'
          data-total-loan='{{ lt_liab_total }}'
          data-capital-employed='{{ capital_employed }}'
           style="display:none;"></div>
    </div>
  </main>

  <script>
    (function(){
      const dataEl = document.getElementById("balanceSheetData");
      const rawSheet  = dataEl?.getAttribute("data-sheet")  || "{}";
      const rawSheets = dataEl?.getAttribute("data-sheets") || "[]";

      let currentSheet = {};
      let sheetOptions = [];

      try { currentSheet = JSON.parse(rawSheet); } catch(e){ currentSheet = {}; }
      try { sheetOptions = JSON.parse(rawSheets); } catch(e){ sheetOptions = []; }

      if (!currentSheet.lines) currentSheet.lines = [];
      if (!currentSheet.totals) currentSheet.totals = {assets:0, liabilities:0, equity:0, liab_plus_equity:0};

      const sheetSelector = document.getElementById("sheetSelector");
      const sheetNameEl   = document.getElementById("sheetName");
      const asOfDateEl    = document.getElementById("asOfDate");
      const currencyEl    = document.getElementById("currency");
      const stmtBody      = document.getElementById("stmtBody");
      const asAtText      = document.getElementById("asAtText");
      const colAmt        = document.getElementById("colAmt");

      const btnSaveSheet  = document.getElementById("btnSaveSheet");
      const btnExportCsv  = document.getElementById("btnExportCsv");
      const btnPrint      = document.getElementById("btnPrint");

      const exportForm    = document.getElementById("exportForm");
      const exportPayload = document.getElementById("exportPayload");

      const baseUrl = "{{ url_for('acc_balance_sheet.balance_sheet_page') }}";

      const parseJson = (value, fallback) => {
        try {
          return JSON.parse(value);
        } catch (err) {
          return fallback;
        }
      };

      const fixedTotals   = parseJson(dataEl?.getAttribute("data-fixed-asset-totals") || "{}", {});
      const fixedCats     = parseJson(dataEl?.getAttribute("data-fixed-asset-categories") || "[]", []);
      const curAssetTotals = parseJson(dataEl?.getAttribute("data-current-asset-totals") || "{}", {});
      const curAssetLines  = parseJson(dataEl?.getAttribute("data-current-asset-lines") || "[]", []);
      const curLiabTotals  = parseJson(dataEl?.getAttribute("data-current-liab-totals") || "{}", {});
      const curLiabLines   = parseJson(dataEl?.getAttribute("data-current-liab-lines") || "[]", []);
      const equityTotals   = parseJson(dataEl?.getAttribute("data-equity-totals") || "{}", {});
      const equityLines    = parseJson(dataEl?.getAttribute("data-equity-lines") || "[]", []);
      const ltLiabTotals   = parseJson(dataEl?.getAttribute("data-lt-liab-totals") || "{}", {});
      const ltLiabLines    = parseJson(dataEl?.getAttribute("data-lt-liab-lines") || "[]", []);

      const totalFixed     = Number(dataEl?.getAttribute("data-total-fixed") || 0);
      const totalCurAssets = Number(dataEl?.getAttribute("data-total-cur-assets") || 0);
      const totalCurLiab   = Number(dataEl?.getAttribute("data-total-cur-liab") || 0);
      const workingCapital = Number(dataEl?.getAttribute("data-working-capital") || 0);
      const netTotalAssets = Number(dataEl?.getAttribute("data-net-total-assets") || 0);
      const totalEquity    = Number(dataEl?.getAttribute("data-total-equity") || 0);
      const totalLoan      = Number(dataEl?.getAttribute("data-total-loan") || 0);
      const capitalEmployed= Number(dataEl?.getAttribute("data-capital-employed") || 0);

      function money(n){
        n = Number(n || 0);
        const sign = n < 0 ? "-" : "";
        n = Math.abs(n);
        return sign + n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
      }

      function setMeta(){
        sheetNameEl.value = currentSheet.name || "";
        asOfDateEl.value  = currentSheet.as_of_date || asOfDateEl.value || "";
        currencyEl.value  = (currentSheet.currency || "GHS").toUpperCase();
        asAtText.textContent = asOfDateEl.value || "";
        colAmt.textContent = currencyEl.value === "GHS" ? "GH¢" : currencyEl.value;
      }

      function row(label, col1="", col2="", col3="", opts={}){
        const tr = document.createElement("tr");
        if (opts.topGap) tr.className = "border-t border-slate-200 dark:border-slate-800";
        const td0 = document.createElement("td");
        td0.className = (opts.bold ? "font-semibold " : "") + "py-1 pr-2";
        td0.style.paddingLeft = opts.indent ? "18px" : "0px";
        td0.textContent = label;

        const td1 = document.createElement("td");
        td1.className = "py-1 px-2 text-right tabular-nums";
        td1.textContent = col1;

        const td2 = document.createElement("td");
        td2.className = "py-1 px-2 text-right tabular-nums";
        td2.textContent = col2;

        const td3 = document.createElement("td");
        td3.className = "py-1 pl-2 text-right tabular-nums";
        td3.textContent = col3;

        if (opts.underline2) td2.classList.add("border-b", "border-slate-900", "dark:border-slate-100");
        if (opts.underline3) td3.classList.add("border-b", "border-slate-900", "dark:border-slate-100");

        tr.appendChild(td0);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        stmtBody.appendChild(tr);
      }

      function renderStatement(){
        stmtBody.innerHTML = "";

        row("Fixed/Non Current Assets", "", "", "", {bold:true, topGap:true});
        (fixedCats || []).forEach(cat => {
          row(cat, money(fixedTotals[cat] || 0), "", "", {indent:true});
        });
        row("", "", money(totalFixed), "", {underline2:true});

        row("", "", "", "");
        row("Current Assets", "", "", "", {bold:true});
        (curAssetLines || []).forEach(cat => {
          row(cat, money(curAssetTotals[cat] || 0), "", "", {indent:true});
        });
        row("", "", money(totalCurAssets), "", {underline2:true});

        row("", "", "", "");
        row("Less:  Current Liabilities", "", "", "", {bold:true});
        (curLiabLines || []).forEach(cat => {
          row(cat, money(curLiabTotals[cat] || 0), "", "", {indent:true});
        });
        row("", "", money(totalCurLiab), "", {underline2:true});

        row("", "", "", "");
        row("Working Capital", "", "", money(workingCapital), {underline3:true});
        row("Net total Assets", "", "", money(netTotalAssets), {bold:true, underline3:true});

        row("", "", "", "");
        row("Financed by:", "", "", "", {bold:true});
        (equityLines || []).forEach(cat => {
          row(cat, money(equityTotals[cat] || 0), "", "", {indent:true});
        });
        row("", "", money(totalEquity), "", {underline2:true});

        row("", "", "", "");
        row("Long-term Liability:", "", "", "", {bold:true});
        (ltLiabLines || []).forEach(cat => {
          row(cat, money(ltLiabTotals[cat] || 0), "", "", {indent:true});
        });
        row("", "", money(totalLoan), "", {underline2:true});

        row("Capital Employed", "", "", money(capitalEmployed), {bold:true, underline3:true});

        if (Math.abs(netTotalAssets - capitalEmployed) > 0.01) {
          row("", "", "", "");
          row("NOTE: Statement not balanced", "", "", money(netTotalAssets - capitalEmployed), {bold:true});
        }
      }

      function initSelector(){
        sheetSelector.innerHTML = "";
        const optNew = document.createElement("option");
        optNew.value = "";
        optNew.textContent = "New sheet...";
        sheetSelector.appendChild(optNew);

        sheetOptions.forEach(o => {
          const opt = document.createElement("option");
          opt.value = o.id || "";
          opt.textContent = o.label || "Unnamed Sheet";
          if (currentSheet.id && o.id === currentSheet.id) opt.selected = true;
          sheetSelector.appendChild(opt);
        });

        sheetSelector.addEventListener("change", function(){
          const val = sheetSelector.value || "";
          if (!val) {
            // reset to blank new sheet (keep demo lines? no)
            currentSheet = {
              id:"",
              name:"",
              as_of_date: asOfDateEl.value || "",
              currency: currencyEl.value || "GHS",
              lines: [],
              totals: {assets:0, liabilities:0, equity:0, liab_plus_equity:0}
            };
            setMeta();
            renderStatement();
            return;
          }
          window.location.href = baseUrl + "?sheet_id=" + encodeURIComponent(val);
        });
      }

      function collectPayload(){
        return {
          id: currentSheet.id || "",
          name: sheetNameEl.value || "",
          as_of_date: asOfDateEl.value || "",
          currency: currencyEl.value || "GHS",
          lines: currentSheet.lines || [],
          totals: currentSheet.totals || {assets:0, liabilities:0, equity:0, liab_plus_equity:0}
        };
      }

      btnSaveSheet.addEventListener("click", function(){
        const payload = collectPayload();
        if (!payload.lines || !payload.lines.length) {
          alert("No lines to save. (Demo mode shows sample lines only if loaded from backend.)");
          return;
        }

        btnSaveSheet.disabled = true;

        fetch("{{ url_for('acc_balance_sheet.balance_sheet_save') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
        .then(async (resp) => {
          const js = await resp.json().catch(()=> ({}));
          if (!resp.ok || !js.ok) throw new Error(js.message || "Save failed");
          currentSheet.id = js.id || "";
          window.location.href = baseUrl + "?sheet_id=" + encodeURIComponent(currentSheet.id);
        })
        .catch(err => {
          console.error(err);
          alert(err.message || "Error saving sheet");
        })
        .finally(() => {
          btnSaveSheet.disabled = false;
        });
      });

      btnExportCsv.addEventListener("click", function(){
        const payload = collectPayload();
        if (!payload.lines || !payload.lines.length) {
          alert("No data to export.");
          return;
        }
        exportPayload.value = JSON.stringify(payload);
        exportForm.submit();
      });

      btnPrint.addEventListener("click", function(){
        window.print();
      });

      // init
      setMeta();
      initSelector();
      renderStatement();

      // update statement title on date/currency change
      asOfDateEl.addEventListener("change", () => { setMeta(); renderStatement(); });
      currencyEl.addEventListener("change", () => { setMeta(); renderStatement(); });
    })();
  </script>
    {% include 'app_footer.html' %}

</body>
</html>

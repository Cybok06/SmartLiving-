<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: #f4f4f4;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .container {
        width: 95%;
        max-width: 1000px;
        margin: 100px auto 20px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: space-between;
    }

    .search-input, .status-filter, button {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1em;
    }

    .customer-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .customer-link {
        text-decoration: none;
        color: inherit;
    }

    .customer-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .customer-item:hover {
        background-color: #f9f9f9;
    }

    .customer-item img {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        margin-right: 15px;
    }

    .customer-info {
        flex: 1;
    }

    .customer-info p {
        margin: 2px 0;
    }

    .status-label {
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 0.9em;
        color: white;
    }

    .active { background-color: #28a745; }
    .inactive { background-color: #dc3545; }
    .no-payment { background-color: #6c757d; }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background: none;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        border: 6px solid #e0e0e0;
        border-top: 6px solid #6f42c1;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Footer styling */
    footer {
        background: #6f42c1;
        color: white;
        text-align: center;
        padding: 15px;
        margin-top: auto;
    }

    /* ‚úÖ Navbar mobile support */
    @media (max-width: 991px) {
        .navbar-collapse {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 10px;
        }

        .navbar-nav .nav-link {
            padding: 10px 0;
        }
    }

    /* ‚úÖ Optional: dark mode support toggle */
    .dark-mode {
        background-color: #121212;
        color: #f1f1f1;
    }

    .dark-mode .container,
    .dark-mode .navbar,
    .dark-mode .card,
    .dark-mode footer {
        background-color: #1e1e1e !important;
        color: #f1f1f1 !important;
    }

    .dark-mode .status-label {
        color: white;
    }
 .add-customer-btn {
  position: fixed;
  bottom: 25px;
  left: 25px; /* moved from right to left */
  background-color: #6f42c1;
  color: white;
  font-size: 28px;
  font-weight: bold;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  text-align: center;
  line-height: 60px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  z-index: 999;
  transition: transform 0.3s ease-in-out;
  text-decoration: none;
}
.add-customer-btn:hover {
  transform: scale(1.1);
}
    
</style>

</head>
<body>

<!-- Loading Spinner -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Navbar -->
{% include 'side_bar.html' %}


<div class="container">
    <h2>üìã Customer List</h2>

    <!-- Attends Today Summary -->
    <h5 id="attendsTodaySummary" class="text-success text-center mb-3" style="display:none;"></h5>

    <form class="filter-bar" method="get" action="{{ url_for('view.view_customers') }}">
        <input class="search-input" type="text" name="search" placeholder="Search by name or phone" value="{{ search_query }}">

        <select class="status-filter" name="status">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
            <option value="not active" {% if status_filter == 'not active' %}selected{% endif %}>Not Active</option>
        </select>

        <select class="status-filter" name="sort_by">
            <option value="name_asc" {% if sort_by == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
            <option value="name_desc" {% if sort_by == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
            <option value="payment_newest" {% if sort_by == 'payment_newest' %}selected{% endif %}>Last Payment (Newest)</option>
            <option value="payment_oldest" {% if sort_by == 'payment_oldest' %}selected{% endif %}>Last Payment (Oldest)</option>
        </select>

        <button type="submit">üîç Apply</button>
        <a href="{{ url_for('view.view_customers', search=search_query, status=status_filter, sort_by=sort_by, export='true') }}" style="padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">‚¨áÔ∏è Export CSV</a>

        <button type="button" onclick="filterAttendsToday()" style="padding: 10px; background: #198754; color: white; border: none; border-radius: 5px;">üéØ Attends Today</button>
        <button type="button" onclick="resetFilter()" style="padding: 10px; background: #6c757d; color: white; border: none; border-radius: 5px;">üîÑ Reset Filter</button>
    </form>

    <ul class="customer-list">
        {% for customer in customers %}
        <a href="{{ url_for('view.view_customer_profile', customer_id=customer._id) }}" class="customer-link">
            <li class="customer-item" data-last-payment="{{ customer.last_payment_date }}">
         <img src="{{ customer.image_url }}" loading="lazy" alt="{{ customer.name }}">
                <div class="customer-info">
                    <p><strong>{{ customer.name }}</strong> ({{ customer.phone_number }})</p>
                    <p>üìÖ Last Payment: {{ customer.last_payment_date }}</p>
                </div>
                <span class="status-label 
                    {% if customer.status == 'Active' %}active
                    {% elif customer.status == 'Not Active' %}inactive
                    {% else %}no-payment{% endif %}">
                    {{ customer.status }}
                </span>
            </li>
        </a>
        {% endfor %}
    </ul>

    {% if not customers %}
        <p style="text-align:center; color:#777;">No customers match your filter.</p>
    {% endif %}
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-center mt-4">
  {% if page > 1 %}
    <a class="btn btn-outline-secondary me-2"
       href="{{ url_for('view.view_customers', page=page-1, search=search_query, status=status_filter, sort_by=sort_by) }}">
       ‚¨ÖÔ∏è Previous
    </a>
  {% endif %}
  {% if customers|length == 30 %}
    <a class="btn btn-outline-primary"
       href="{{ url_for('view.view_customers', page=page+1, search=search_query, status=status_filter, sort_by=sort_by) }}">
       Next ‚û°Ô∏è
    </a>
  {% endif %}
</div>

<!-- ‚úÖ Floating Button -->
<a href="/customer/register" class="add-customer-btn" title="Register Customer">+</a>

<!-- Footer -->
<footer>
    <p>&copy; 2025 SMART LIVING CRM. All Rights Reserved.</p>
</footer>

<!-- Bootstrap JS and Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
<script>
  function toggleMode() {
    document.body.classList.toggle('dark-mode');

    // Store preference
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');

    // Update only the toggle button icon
    const toggleButton = document.getElementById('darkModeToggle');
    if (toggleButton) {
      toggleButton.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Loader
    const loader = document.getElementById("loadingOverlay");
    setTimeout(() => {
      loader.style.display = "none";
    }, 2000);

    // Restore dark mode preference
    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark-mode');
      const toggleButton = document.getElementById('darkModeToggle');
      if (toggleButton) {
        toggleButton.textContent = '‚òÄÔ∏è';
      }
    }

    // Attends Today Summary
    const today = new Date().toISOString().split('T')[0];
    const items = document.querySelectorAll('.customer-item');
    let attending = 0;
    items.forEach(item => {
      const date = item.getAttribute('data-last-payment');
      const isToday = date && date === today;
      if (isToday) attending++;
    });
    if (attending > 0) {
      document.getElementById('attendsTodaySummary').textContent = `Attends Today: ${attending} out of ${items.length}`;
      document.getElementById('attendsTodaySummary').style.display = 'block';
    }
  });

  function filterAttendsToday() {
    const today = new Date().toISOString().split('T')[0];
    const items = document.querySelectorAll('.customer-item');
    let attending = 0;

    items.forEach(item => {
      const date = item.getAttribute('data-last-payment');
      const isToday = date && date === today;
      item.parentElement.style.display = isToday ? '' : 'none';
      if (isToday) attending++;
    });

    const total = items.length;
    document.getElementById('attendsTodaySummary').textContent = `Attends Today: ${attending} out of ${total}`;
    document.getElementById('attendsTodaySummary').style.display = 'block';
  }

  function resetFilter() {
    document.querySelectorAll('.customer-link').forEach(link => {
      link.style.display = '';
    });
    document.getElementById('attendsTodaySummary').style.display = 'none';
  }
</script>

<script>
    window.cbConfig = {
      chatId: "acac0de2-5c91-4eae-9354-1376e3093d91"
    };
  </script>
  <script src="https://app.chatbit.co/embed.min.js" defer></script>
</body>
</html>

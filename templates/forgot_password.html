<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password | SmartLiving CRM</title>
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;800;900&display=swap">
  <style>
    :root{
      --ax-blue:#0066cc;
      --ax-orange:#f58634;
      --sl-purple:#7c3aed;
      --ink:#0f172a;
      --muted:#64748b;
      --card:rgba(255,255,255,.9);
      --danger:#ef4444;
      --ok:#10b981;
    }
    *{ box-sizing:border-box; font-family:"Raleway",system-ui,-apple-system,sans-serif; }
    body{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(circle at 12% 10%, rgba(245,158,11,.12), transparent 55%),
        radial-gradient(circle at 88% 18%, rgba(17,102,204,.14), transparent 55%),
        radial-gradient(circle at 80% 86%, rgba(124,58,237,.12), transparent 55%),
        linear-gradient(180deg, #f8fafc, #eef2ff);
      padding:22px 16px; color:var(--ink);
    }
    .card{
      width:100%; max-width:560px; border-radius:22px; background:var(--card);
      box-shadow:0 26px 60px rgba(15,23,42,.16), 0 0 0 1px rgba(148,163,184,.24);
      backdrop-filter: blur(18px); padding:28px 30px; position:relative;
    }
    .card::before{
      content:""; position:absolute; left:0; right:0; top:0; height:6px;
      background: linear-gradient(90deg, var(--ax-orange), var(--ax-blue), var(--sl-purple));
    }
    .title{ font-size:22px; font-weight:900; margin-bottom:6px; }
    .sub{ font-size:13px; color:var(--muted); margin-bottom:18px; }

    .stepper{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:18px; gap:10px;
    }
    .step{
      flex:1; display:flex; align-items:center; gap:8px; position:relative;
    }
    .step:not(:last-child)::after{
      content:""; position:absolute; right:-6px; top:50%; transform:translateY(-50%);
      width:100%; height:2px; background:#e2e8f0; z-index:0;
    }
    .step .dot{
      width:28px; height:28px; border-radius:999px; background:#e2e8f0;
      display:grid; place-items:center; font-size:12px; font-weight:800; color:#475569; z-index:1;
    }
    .step.active .dot{ background:var(--ax-blue); color:#fff; }
    .step .label{ font-size:11px; font-weight:800; letter-spacing:.05em; color:#475569; text-transform:uppercase; }

    .field{ margin-bottom:14px; }
    .label{ font-size:11px; font-weight:900; letter-spacing:.12em; text-transform:uppercase; color:#475569; margin-bottom:6px; display:block; }
    .inputwrap{ position:relative; }
    .inputwrap i{
      position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#64748b; font-size:13px;
    }
    .input{
      width:100%; border-radius:999px; border:1px solid rgba(148,163,184,.5);
      padding:11px 14px 11px 36px; background:rgba(249,250,251,.92);
    }
    .input:focus{ outline:none; border-color:rgba(0,102,204,.85); background:#fff; }

    .detected{
      display:none;
      border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.08);
      padding:12px;
      border-radius:14px;
      margin-top:12px;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .detected.show{ display:flex; }
    .avatar{
      width:40px; height:40px; border-radius:999px; background:#e2e8f0;
      display:grid; place-items:center; font-weight:800; color:#334155;
    }
    .detected .meta{ flex:1; }
    .detected .meta .name{ font-weight:800; }
    .btn{
      border:none; border-radius:999px; padding:10px 14px; font-weight:900; cursor:pointer;
      background:linear-gradient(90deg, var(--ax-orange), var(--ax-blue));
      color:#fff;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn-secondary{
      background:#fff; border:1px solid #e2e8f0; color:#334155;
    }
    .row{ display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap; }
    .link{ font-size:12px; color:#1d4ed8; text-decoration:none; font-weight:800; }
    .status{ font-size:12px; color:var(--muted); margin-top:8px; }
    .status.bad{ color:var(--danger); }
    .status.ok{ color:var(--ok); }

    .alert{
      background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
      padding:8px 10px; border-radius:10px; font-size:12px; margin-bottom:12px;
    }
  </style>
 </head>
<body>
  <div class="card">
    <div class="stepper">
      <div class="step active">
        <div class="dot">1</div>
        <div class="label">Identify</div>
      </div>
      <div class="step">
        <div class="dot">2</div>
        <div class="label">Verify</div>
      </div>
      <div class="step">
        <div class="dot">3</div>
        <div class="label">Reset</div>
      </div>
    </div>

    <div class="title">Reset your password</div>
    <div class="sub">Enter the phone number linked to your account.</div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="alert">
          {% for category, message in messages %}
            {{ message }}{% if not loop.last %}<br>{% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('auth_password_reset.forgot_password') }}" id="forgotForm">
      <div class="field">
        <label class="label" for="phone">Phone Number</label>
        <div class="inputwrap">
          <i class="fa-solid fa-phone"></i>
          <input class="input" type="text" id="phone" name="phone" placeholder="Enter phone number">
        </div>

        <div class="detected" id="detectedPanel">
          <div class="avatar" id="detectedAvatar">U</div>
          <div class="meta">
            <div class="name">Username: <span id="detectedName">---</span></div>
            <div class="status ok" id="detectedPhone">Phone: ---</div>
          </div>
        </div>
        <div class="status" id="lookupStatus"></div>
      </div>

      <div class="field">
        <label class="label" for="username">Or Username (Optional)</label>
        <div class="inputwrap">
          <i class="fa-solid fa-user"></i>
          <input class="input" type="text" id="username" name="username" placeholder="Enter username">
        </div>
      </div>

      <div class="row">
        <button class="btn" id="sendBtn" type="submit">Send verification code</button>
      </div>
    </form>
  </div>

  <script>
    const phoneInput = document.getElementById("phone");
    const detectedPanel = document.getElementById("detectedPanel");
    const detectedName = document.getElementById("detectedName");
    const detectedAvatar = document.getElementById("detectedAvatar");
    const detectedPhone = document.getElementById("detectedPhone");
    const lookupStatus = document.getElementById("lookupStatus");

    let debounceTimer = null;

    function setStatus(text, state){
      lookupStatus.textContent = text || "";
      lookupStatus.classList.remove("ok", "bad");
      if (state) lookupStatus.classList.add(state);
    }

    function resetDetected(){
      detectedPanel.classList.remove("show");
      detectedName.textContent = "---";
      detectedAvatar.textContent = "U";
      detectedPhone.textContent = "Phone: ---";
    }

    async function lookupPhone(value){
      if (!value || value.length < 9){
        resetDetected();
        setStatus("", "");
        return;
      }
      setStatus("Checking number...", "");
      try{
        const res = await fetch(`{{ url_for('auth_password_reset.lookup_username') }}?phone=${encodeURIComponent(value)}`);
        const data = await res.json();
        if (data.ok){
          detectedName.textContent = data.username || "---";
          detectedAvatar.textContent = (data.username || "U").charAt(0).toUpperCase();
          detectedPhone.textContent = `Phone: ${data.masked_phone || ""}`;
          detectedPanel.classList.add("show");
          setStatus("Account detected.", "ok");
        } else {
          resetDetected();
          setStatus("User not found for this phone.", "bad");
        }
      } catch (e){
        resetDetected();
        setStatus("Lookup failed. Try again.", "bad");
      }
    }

    phoneInput.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => lookupPhone(phoneInput.value.trim()), 500);
    });
  </script>
  
</body>
</html>

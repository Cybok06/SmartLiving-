<div class="exec-card p-3 p-md-4 mb-3">
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
    <div>
      <div class="text-muted small">Executive Users</div>
      <h4 class="mb-1">Users</h4>
      <div class="text-muted">Manage access, activity, and profile insights.</div>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <div class="text-muted small">Total users: <strong>{{ total_users }}</strong></div>
      {% if can_manage %}
        <a class="btn btn-primary" href="/executive/users/new">
          <i class="bi bi-person-plus"></i> Add User
        </a>
        <a class="btn btn-outline-secondary" href="/executive/users/deleted">
          <i class="bi bi-archive"></i> Recently Deleted
        </a>
      {% endif %}
      <a class="btn btn-outline-primary" href="/executive/users/reports" data-ajax="true">
        <i class="bi bi-graph-up"></i> Reports
      </a>
    </div>
  </div>
</div>

<div class="exec-card p-3 p-md-4 mb-3">
  <form class="row g-2 align-items-end" method="get" action="/executive/users" data-ajax="true">
    <div class="col-md-3">
      <label class="form-label small text-muted">Search</label>
      <input type="search" class="form-control" name="search" value="{{ filters.search }}" placeholder="Name, username, phone">
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Role</label>
      <select class="form-select" name="role">
        <option value="">All roles</option>
        {% for r in roles %}
          <option value="{{ r }}" {% if filters.role == r %}selected{% endif %}>{{ r.title() }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Branch</label>
      <select class="form-select" name="branch">
        <option value="">All branches</option>
        {% for b in branches %}
          <option value="{{ b }}" {% if filters.branch == b %}selected{% endif %}>{{ b }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Status</label>
      <select class="form-select" name="status">
        <option value="">All statuses</option>
        {% for s in statuses %}
          <option value="{{ s }}" {% if filters.status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted">Range</label>
      <select class="form-select" name="range">
        <option value="7d" {% if filters.range == '7d' %}selected{% endif %}>7d</option>
        <option value="30d" {% if filters.range == '30d' %}selected{% endif %}>30d</option>
        <option value="90d" {% if filters.range == '90d' %}selected{% endif %}>90d</option>
      </select>
    </div>
    <div class="col-md-1 d-grid">
      <button type="submit" class="btn btn-primary">Apply</button>
    </div>
    <input type="hidden" name="per_page" value="{{ pagination.per_page }}">
  </form>
</div>

<div class="row g-3">
  {% if rows %}
    {% for row in rows %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="exec-card p-3 h-100">
          <div class="d-flex align-items-center gap-3">
            <img src="{{ row.image_url or DEFAULT_PROFILE_IMAGE_URL }}" class="rounded-circle" style="width:52px;height:52px;object-fit:cover;border:1px solid rgba(226,232,240,0.9);" alt="{{ row.name }}" onerror="this.src='{{ DEFAULT_PROFILE_IMAGE_URL }}'">
            <div class="flex-grow-1">
              <div class="fw-semibold">{{ row.name }}</div>
              <div class="text-muted small">@{{ row.username }}</div>
            </div>
            <span class="badge rounded-pill {{ 'bg-success-subtle text-success-emphasis' if row.status == 'Active' else 'bg-danger-subtle text-danger-emphasis' }}">{{ row.status }}</span>
          </div>
          <div class="mt-3">
            <div class="d-flex justify-content-between small text-muted">
              <span>Role</span>
              <span class="text-capitalize">{{ row.role }}</span>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Branch</span>
              <span>{{ row.branch }}</span>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Last Login</span>
              <span>{{ row.last_login[:16] if row.last_login else '-' }}</span>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Logins ({{ filters.range }})</span>
              <span>{{ row.logins_range }}</span>
            </div>
            <div class="d-flex justify-content-between small text-muted">
              <span>Activities ({{ filters.range }})</span>
              <span>
                {% if row.activities_range is not none %}
                  {{ row.activities_range }}
                {% else %}
                  -
                {% endif %}
              </span>
            </div>
          </div>
          <div class="mt-3 d-grid">
            <a href="/executive/users/{{ row.id }}" data-ajax="true" class="btn btn-primary">View Profile</a>
          </div>
          {% if can_manage %}
            <div class="d-flex gap-2 mt-2">
              <button type="button" class="btn btn-sm btn-outline-warning w-100" data-action="toggle" data-id="{{ row.id }}" data-status="{{ row.status }}">
                {{ 'Deactivate' if row.status == 'Active' else 'Activate' }}
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger w-100" data-action="delete" data-id="{{ row.id }}" data-name="{{ row.name }}">
                Delete
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="exec-card p-4 text-muted">No users found for the selected filters.</div>
    </div>
  {% endif %}
</div>

{% set total = pagination.total %}
{% set per = pagination.per_page %}
{% set page = pagination.page %}
{% set pages = (total // per) + (1 if total % per else 0) %}

<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="text-muted small">Showing {{ 0 if total == 0 else ((page - 1) * per + 1) }}-{{ (page * per) if (page * per) < total else total }} of {{ total }}</div>
  <div class="btn-group">
    {% set base = '/executive/users' %}
    {% set qs = query_string %}
    {% set prev_url = base + ('?' + qs + '&page=' + (page - 1)|string if qs else '?page=' + (page - 1)|string) %}
    {% set next_url = base + ('?' + qs + '&page=' + (page + 1)|string if qs else '?page=' + (page + 1)|string) %}
    <a class="btn btn-outline-secondary {% if page <= 1 %}disabled{% endif %}" href="{{ prev_url }}" data-ajax="true">Previous</a>
    <a class="btn btn-outline-secondary {% if page >= pages %}disabled{% endif %}" href="{{ next_url }}" data-ajax="true">Next</a>
  </div>
</div>

{% if can_manage %}
<script>
  (function(){
    const nextUrl = "{{ next_url }}";
    document.querySelectorAll('[data-action="toggle"]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-id');
        const current = btn.getAttribute('data-status');
        const proceed = confirm(`Toggle status for this user? Current: ${current}`);
        if (!proceed) return;
        const body = new URLSearchParams({ next: nextUrl });
        fetch(`/executive/users/${userId}/toggle_status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
          credentials: 'same-origin'
        }).then(() => window.location.reload());
      });
    });

    document.querySelectorAll('[data-action="delete"]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const userId = btn.getAttribute('data-id');
        const name = btn.getAttribute('data-name') || 'this user';
        const proceed = confirm(`Delete ${name}? This can be restored from Recently Deleted.`);
        if (!proceed) return;
        const body = new URLSearchParams({ next: nextUrl });
        fetch(`/executive/users/${userId}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
          credentials: 'same-origin'
        }).then(() => window.location.reload());
      });
    });
  })();
</script>
{% endif %}

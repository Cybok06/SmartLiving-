<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Inventory</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" href="https://res.cloudinary.com/dljpgzbto/image/upload/v1743993646/company-logo_dksb23.jpg" type="image/png" />
  <style>
    body {
      background-color: #f3e8ff;
      font-family: Arial, sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark-mode {
      background-color: #121212 !important;
      color: #f1f1f1;
    }

    .dark-mode .navbar,
    .dark-mode .footer,
    .dark-mode .card {
      background-color: #343a40 !important;
      color: white;
    }

    .footer {
      background-color: #e0c7ff;
      padding: 10px;
      text-align: center;
      margin-top: 40px;
      border-top: 1px solid #ccc;
    }

    .form-control, .btn {
      border-radius: 8px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 5px;
      background: #f8f8f8;
      padding: 8px 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
    {% include 'inventory_sidebar.html' %}

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light px-3">
  
  <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
    <ul class="navbar-nav align-items-center">
       <li class="nav-item">
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('inventory_products.inventory_products') }}">üì¶ Warehouse</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('inventory_analysis.inventory_analysis') }}">üìä Analysis</a>
      </li>
      <li class="nav-item">
        <button class="btn btn-outline-dark ms-lg-3 me-3" onclick="toggleDarkMode()" id="darkModeToggle">üåô</button>
      </li>
      <li class="nav-item">
        <a href="/logout" class="btn btn-danger">Logout</a>
      </li>
    </ul>
  </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
  <div class="card shadow p-4">
    <h3 class="text-center mb-4">Add Products to Warehouse</h3>
    <form method="POST" enctype="multipart/form-data" onsubmit="return calculateFinalPrice();">
      <div class="row g-3">
        <div class="col-md-6">
          <label>Product Name</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Initial Price</label>
          <input type="number" id="initial_price" name="initial_price" class="form-control" step="0.01" required>
        </div>
        <div class="col-md-6">
          <label>Profit (Amount or % e.g. 50 or 30%)</label>
          <input type="text" id="profit" name="profit" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Final Price (Auto-calculated)</label>
          <input type="number" id="price" name="price" class="form-control" step="0.01" readonly required>
        </div>
        <div class="col-md-6">
          <label>Quantity</label>
          <input type="number" name="qty" class="form-control" required>
        </div>
        <div class="col-md-12">
          <label>Description</label>
          <textarea name="description" class="form-control" rows="3" required></textarea>
        </div>

        <div class="col-md-12">
          <label for="image" class="form-label">Upload Image:</label>
          <input type="file" id="image" name="image" class="form-control" accept="image/*" required>
          <input type="hidden" id="image_url" name="image_url">
          <p id="upload-status" class="mt-2 text-muted"></p>
        </div>

        <div class="col-md-12">
          <label>Select Branche(s)</label>
          <button type="button" class="btn btn-warning btn-sm mb-2" onclick="selectAllManagers()">Select All Managers</button>
          <div class="row">
            {% for manager in managers %}
            <div class="col-md-6">
              <label class="form-check-label">
                <input type="checkbox" class="form-check-input manager-checkbox" name="manager_ids" value="{{ manager._id }}">
                {{ manager.name }} ({{ manager.branch }})
              </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <button type="submit" class="btn btn-success w-100">Add Product</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Footer -->
<footer class="footer text-center mt-5 mb-3 text-muted">
  CYTECH | Admin Panel
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const btn = document.getElementById('darkModeToggle');
    btn.textContent = document.body.classList.contains('dark-mode') ? 'üåû' : 'üåô';
  }

  function selectAllManagers() {
    document.querySelectorAll('.manager-checkbox').forEach(cb => cb.checked = true);
  }

  function calculateFinalPrice() {
    const initial = parseFloat(document.getElementById('initial_price').value);
    const profitInput = document.getElementById('profit').value.trim();
    if (isNaN(initial) || !profitInput) {
      alert("Please enter a valid initial price and profit.");
      return false;
    }
    let finalPrice = initial;
    if (profitInput.endsWith('%')) {
      const percent = parseFloat(profitInput.slice(0, -1));
      if (isNaN(percent)) {
        alert("Invalid percentage format for profit.");
        return false;
      }
      finalPrice += (initial * percent / 100);
    } else {
      const profitAmount = parseFloat(profitInput);
      if (isNaN(profitAmount)) {
        alert("Invalid profit amount.");
        return false;
      }
      finalPrice += profitAmount;
    }
    document.getElementById('price').value = finalPrice.toFixed(2);
    return true;
  }

  // ‚úÖ Upload locally to Flask endpoint
  document.getElementById('image').addEventListener('change', async function (event) {
    const file = event.target.files[0];
    if (!file) return;
    const uploadStatus = document.getElementById('upload-status');
    uploadStatus.textContent = "Uploading image...";

    const formData = new FormData();
    formData.append('image', file);

    try {
      const response = await fetch('/add_inventory/upload_image', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        document.getElementById('image_url').value = data.image_url;
        uploadStatus.textContent = "‚úÖ Image uploaded successfully.";
      } else {
        uploadStatus.textContent = "‚ùå Upload failed: " + (data.error || "Unknown error.");
        console.error('Upload error:', data);
      }
    } catch (error) {
      uploadStatus.textContent = "‚ùå Upload failed. Network error.";
      console.error(error);
    }
  });
</script>
